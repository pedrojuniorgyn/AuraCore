---
description: Regras MCP obrigat√≥rias do AuraCore - Arquitetura 100% DDD/Hexagonal, TypeScript strict, padr√µes de c√≥digo. Consultar contratos e verificar com grep ANTES de codificar. Zero bugs por falta de verifica√ß√£o.
globs: "**/*.ts,**/*.tsx"
alwaysApply: true
---

# AURA CORE - REGRAS MCP OBRIGAT√ìRIAS v2.0

**Vers√£o:** 2.0.0  
**Data:** 06/01/2026  
**Arquitetura:** 100% DDD/Hexagonal (ADR-0015)

---

## üö® REGRA FUNDAMENTAL (INVIOL√ÅVEL)

ANTES de implementar QUALQUER c√≥digo, o agente DEVE:

### 1. Consultar Contratos MCP

```
Tool: get_contract
Args: { "contract_id": "verify-before-code" }

Tool: get_contract
Args: { "contract_id": "code-consistency" }

Tool: get_contract
Args: { "contract_id": "type-safety" }

Tool: get_contract
Args: { "contract_id": "mcp-enforcement-rules" }

Tool: get_contract
Args: { "contract_id": "infrastructure-layer" }

Tool: get_contract
Args: { "contract_id": "known-bugs-registry" }

Tool: get_contract
Args: { "contract_id": "architecture-layers" }

Tool: get_contract
Args: { "contract_id": "schema-pattern" }
```

### 2. Buscar Padr√µes Relacionados

```
Tool: search_patterns
Args: { "query": "[tema da tarefa]" }
```

### 3. Verificar com GREP Antes de Usar (OBRIGAT√ìRIO)

```bash
# Interface
grep -rn "interface NomeInterface" src/

# Enum
grep -A10 "NomeEnum" src/lib/db/schema.ts

# M√©todo
grep -n "nomeMetodo(" src/modules/

# Propriedade de contexto
grep -n "propriedade:" src/lib/auth/context.ts

# SpedDocumentType (para SPED)
grep -A10 "SpedDocumentType" src/modules/fiscal/domain/value-objects/SpedDocument.ts

# Entity existente
grep -rn "class NomeEntity" src/modules/

# Value Object existente
grep -rn "class NomeVO extends ValueObject" src/modules/

# Repository interface
grep -rn "interface I.*Repository" src/modules/
```

### 4. Confirmar Leitura

Responder: **"Contratos MCP consultados. Verifica√ß√µes grep realizadas. Iniciando implementa√ß√£o."**

**NUNCA pular esta etapa. Se n√£o conseguir consultar, informar o usu√°rio.**

---

## üìê ARQUITETURA - REGRAS INVIOL√ÅVEIS (ARCH-001 a ARCH-015)

### Depend√™ncias entre Camadas

| Regra | Descri√ß√£o | Prioridade |
|-------|-----------|------------|
| ARCH-001 | Domain N√ÉO importa de Application | CR√çTICA |
| ARCH-002 | Domain N√ÉO importa de Infrastructure | CR√çTICA |
| ARCH-003 | Domain N√ÉO importa bibliotecas externas (drizzle, axios) | CR√çTICA |
| ARCH-004 | Domain N√ÉO importa m√≥dulos Node.js (fs, path, crypto) | CR√çTICA |
| ARCH-005 | Application N√ÉO importa de Infrastructure (exceto via DI) | ALTA |
| ARCH-006 | Depend√™ncias SEMPRE apontam para Domain (inward) | CR√çTICA |
| ARCH-007 | Entities t√™m comportamento (n√£o s√£o an√™micas) | ALTA |
| ARCH-008 | Value Objects s√£o imut√°veis (Object.freeze) | ALTA |
| ARCH-009 | Domain Services s√£o stateless (m√©todos est√°ticos) | ALTA |
| ARCH-010 | Use Cases implementam interface de domain/ports/input/ | ALTA |
| ARCH-011 | Repositories implementam interface de domain/ports/output/ | ALTA |
| ARCH-012 | Commands em application/commands/ | M√âDIA |
| ARCH-013 | Queries em application/queries/ | M√âDIA |
| ARCH-014 | Mappers t√™m toDomain() e toPersistence() | ALTA |
| ARCH-015 | toDomain() usa reconstitute(), n√£o create() | ALTA |

### Estrutura de Pastas Obrigat√≥ria

```
src/modules/{module}/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ value-objects/
‚îÇ   ‚îú‚îÄ‚îÄ services/           # ‚Üê OBRIGAT√ìRIO
‚îÇ   ‚îú‚îÄ‚îÄ events/
‚îÇ   ‚îú‚îÄ‚îÄ errors/
‚îÇ   ‚îî‚îÄ‚îÄ ports/
‚îÇ       ‚îú‚îÄ‚îÄ input/          # ‚Üê OBRIGAT√ìRIO
‚îÇ       ‚îî‚îÄ‚îÄ output/         # ‚Üê OBRIGAT√ìRIO
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îú‚îÄ‚îÄ commands/           # ‚Üê OBRIGAT√ìRIO
‚îÇ   ‚îú‚îÄ‚îÄ queries/            # ‚Üê OBRIGAT√ìRIO
‚îÇ   ‚îî‚îÄ‚îÄ dtos/
‚îî‚îÄ‚îÄ infrastructure/
    ‚îú‚îÄ‚îÄ persistence/
    ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
    ‚îÇ   ‚îú‚îÄ‚îÄ mappers/
    ‚îÇ   ‚îî‚îÄ‚îÄ schemas/        # 1 arquivo por tabela
    ‚îî‚îÄ‚îÄ di/
```

---

## üóÑÔ∏è BANCO DE DADOS - SCHEMA PATTERN (SCHEMA-001 a SCHEMA-010)

| Regra | Descri√ß√£o | Prioridade |
|-------|-----------|------------|
| SCHEMA-001 | Um arquivo schema por tabela | ALTA |
| SCHEMA-002 | Nome: {entity}.schema.ts (lowercase) | M√âDIA |
| SCHEMA-003 | √çndice composto: (organizationId, branchId) | CR√çTICA |
| SCHEMA-004 | √çndices para filtros frequentes | ALTA |
| SCHEMA-005 | Campos: createdAt, updatedAt obrigat√≥rios | ALTA |
| SCHEMA-006 | Soft delete: deletedAt nullable | ALTA |
| SCHEMA-007 | Money = 2 colunas (amount + currency) | ALTA |
| SCHEMA-008 | Export const tableName = mssqlTable(...) | M√âDIA |
| SCHEMA-009 | Tipos inferidos: $inferSelect, $inferInsert | ALTA |
| SCHEMA-010 | √çndice √∫nico para chaves naturais | M√âDIA |

---

## üî∑ ENTITY PATTERN (ENTITY-001 a ENTITY-012)

| Regra | Descri√ß√£o |
|-------|-----------|
| ENTITY-001 | Extends AggregateRoot<string> ou Entity<string> |
| ENTITY-002 | Factory method create() com valida√ß√µes |
| ENTITY-003 | M√©todo reconstitute() sem valida√ß√µes |
| ENTITY-004 | create() retorna Result<Entity, string> |
| ENTITY-005 | NUNCA setters p√∫blicos |
| ENTITY-006 | Getters para propriedades |
| ENTITY-007 | M√©todos de neg√≥cio (approve, cancel, etc) |
| ENTITY-008 | Validar invariantes em create() |
| ENTITY-009 | Emitir Domain Events em mudan√ßas de estado |
| ENTITY-010 | ID gerado internamente (crypto.randomUUID) |
| ENTITY-011 | Multi-tenancy: organizationId + branchId |
| ENTITY-012 | Timestamps: createdAt, updatedAt |

---

## üî∂ VALUE OBJECT PATTERN (VO-001 a VO-010)

| Regra | Descri√ß√£o |
|-------|-----------|
| VO-001 | Extends ValueObject<Props> |
| VO-002 | Props extends Record<string, unknown> |
| VO-003 | Constructor privado |
| VO-004 | Factory method create() est√°tico |
| VO-005 | Object.freeze no constructor |
| VO-006 | Imut√°vel (sem m√©todos que alteram estado) |
| VO-007 | Compara√ß√£o por valor (equals) |
| VO-008 | Valida√ß√µes em create() |
| VO-009 | Retorna Result<VO, string> |
| VO-010 | toString() para debug |

---

## üîµ DOMAIN SERVICE PATTERN (DOMAIN-SVC-001 a DOMAIN-SVC-010)

| Regra | Descri√ß√£o |
|-------|-----------|
| DOMAIN-SVC-001 | 100% Stateless (m√©todos est√°ticos) |
| DOMAIN-SVC-002 | Constructor privado (impede instancia√ß√£o) |
| DOMAIN-SVC-003 | Retorna Result<T, string> |
| DOMAIN-SVC-004 | NUNCA faz throw |
| DOMAIN-SVC-005 | ZERO depend√™ncias de infraestrutura |
| DOMAIN-SVC-006 | ZERO acesso a banco de dados |
| DOMAIN-SVC-007 | 100% test√°vel sem mocks |
| DOMAIN-SVC-008 | L√≥gica de neg√≥cio PURA |
| DOMAIN-SVC-009 | Localiza√ß√£o: domain/services/ |
| DOMAIN-SVC-010 | Nome descritivo: {A√ß√£o}Calculator, {A√ß√£o}Validator |

---

## üü£ USE CASE PATTERN (USE-CASE-001 a USE-CASE-015)

| Regra | Descri√ß√£o |
|-------|-----------|
| USE-CASE-001 | Commands em application/commands/ |
| USE-CASE-002 | Queries em application/queries/ |
| USE-CASE-003 | Implementa interface de domain/ports/input/ |
| USE-CASE-004 | M√©todo √∫nico: execute() |
| USE-CASE-005 | Recebe ExecutionContext (userId, orgId, branchId) |
| USE-CASE-006 | Retorna Promise<Result<Output, string>> |
| USE-CASE-007 | Valida input (Zod ou manual) |
| USE-CASE-008 | Verifica multi-tenancy |
| USE-CASE-009 | Delega l√≥gica para Domain |
| USE-CASE-010 | Usa DI para dependencies |
| USE-CASE-011 | @injectable() decorator |
| USE-CASE-012 | Commands podem modificar estado |
| USE-CASE-013 | Queries NUNCA modificam estado |
| USE-CASE-014 | Publica Domain Events |
| USE-CASE-015 | Gerencia transa√ß√µes |

---

## üü¢ REPOSITORY PATTERN (REPO-001 a REPO-012)

| Regra | Descri√ß√£o |
|-------|-----------|
| REPO-001 | Interface em domain/ports/output/ |
| REPO-002 | Implementa√ß√£o em infrastructure/persistence/repositories/ |
| REPO-003 | Implementa interface do domain |
| REPO-004 | Usa Mapper para convers√£o |
| REPO-005 | TODA query filtra organizationId + branchId |
| REPO-006 | Soft delete: filtrar deletedAt IS NULL |
| REPO-007 | UPSERT com onConflictDoUpdate |
| REPO-008 | Transa√ß√µes para opera√ß√µes m√∫ltiplas |
| REPO-009 | Pagina√ß√£o obrigat√≥ria em findMany |
| REPO-010 | Retorna Domain Entity, n√£o row do banco |
| REPO-011 | @injectable() decorator |
| REPO-012 | Nome: Drizzle{Entity}Repository |

---

## üü° MAPPER PATTERN (MAPPER-001 a MAPPER-008)

| Regra | Descri√ß√£o |
|-------|-----------|
| MAPPER-001 | Localiza√ß√£o: infrastructure/persistence/mappers/ |
| MAPPER-002 | M√©todo toDomain(row): Result<Entity, string> |
| MAPPER-003 | M√©todo toPersistence(entity): Insert |
| MAPPER-004 | toDomain usa reconstitute(), NUNCA create() |
| MAPPER-005 | Money ‚Üí 2 campos (amount, currency) |
| MAPPER-006 | Validar convers√£o de Value Objects |
| MAPPER-007 | Classe com m√©todos est√°ticos |
| MAPPER-008 | Nome: {Entity}Mapper |

---

## üî¥ REGRAS CR√çTICAS DE C√ìDIGO

### TypeScript Strict

- ‚ùå NUNCA usar `any` (usar `unknown` ou tipo expl√≠cito)
- ‚ùå NUNCA usar `@ts-ignore`
- ‚ùå NUNCA usar `as any`
- ‚úÖ SEMPRE tipar retornos de fun√ß√£o
- ‚úÖ SEMPRE tipar par√¢metros

### Valida√ß√£o de Input

- ‚úÖ SEMPRE validar input com Zod em rotas API
- ‚úÖ SEMPRE usar .trim() antes de validar comprimento de strings
- ‚úÖ SEMPRE verificar Result.isFail() antes de acessar .value

### Result Pattern

- ‚úÖ SEMPRE verificar Result.isFail() antes de acessar .value
- ‚úÖ SEMPRE retornar Result em opera√ß√µes que podem falhar
- ‚ùå NUNCA fazer throw para erros de neg√≥cio
- ‚ùå NUNCA acessar .value sem verificar

### Multi-Tenancy

- ‚úÖ SEMPRE filtrar por organizationId + branchId
- ‚ùå branchId NUNCA pode ser opcional em filters
- ‚úÖ √çndice composto obrigat√≥rio no schema

### Transa√ß√µes SQL

- ‚úÖ SEMPRE usar transa√ß√£o em opera√ß√µes multi-step
- ‚úÖ Usar withMssqlTransaction helper

### Mapeamento Domain-Persistence

- ‚úÖ Schema DEVE espelhar Domain COMPLETO
- ‚úÖ Money = 2 campos (amount + currency)
- ‚úÖ Campos opcionais = .nullable()
- ‚úÖ toDomain usa reconstitute(), N√ÉO create()
- ‚úÖ UPDATE com TODOS os campos mut√°veis

### Fun√ß√µes Utilit√°rias

- ‚úÖ Quando criar fun√ß√£o utilit√°ria: USAR em TODOS os lugares
- ‚úÖ REMOVER c√≥digo duplicado que a fun√ß√£o substitui
- ‚ùå NUNCA deixar l√≥gica hardcoded quando existe fun√ß√£o centralizada

### M√°quina de Estados

- ‚úÖ Transi√ß√µes que diferem por tipo DEVEM ter m√°quinas separadas
- ‚ùå NUNCA modificar m√°quina global para caso espec√≠fico
- ‚úÖ SEMPRE usar canTransitionTo(from, to, documentType)

---

## ‚úÖ VALIDA√á√ïES PR√â-COMMIT OBRIGAT√ìRIAS

ANTES de commit, executar TODOS:

```bash
# 1. TypeScript - deve retornar 0 erros
npx tsc --noEmit

# 2. Testes - todos devem passar
npm test -- --run

# 3. Buscar any - deve retornar 0 resultados
grep -r 'as any' src/

# 4. Verificar status git
git status
```

### 5. Verificar Issues do Cursor (OBRIGAT√ìRIO)

```
Tool: check_cursor_issues
Args: {}
```

Se QUALQUER verifica√ß√£o falhar, corrigir antes de commit.

---

## üìã FLUXO DE TRABALHO OBRIGAT√ìRIO

### Implementa√ß√£o

1. Consultar contratos MCP (Tool: get_contract)
2. Buscar padr√µes (Tool: search_patterns)
3. Verificar com grep
4. Confirmar leitura
5. Implementar seguindo regras
6. Testar localmente

### Pr√©-Commit

```
Tool: check_cursor_issues
Args: {}
```

1. Se issues > 0: corrigir
2. Se issues = 0: fazer commit

### P√≥s-Commit

```
Tool: check_cursor_issues
Args: {}
```

1. Se issues > 0: corrigir + registrar corre√ß√£o + git commit --amend
2. Se issues = 0: reportar para aprova√ß√£o

### Registrar Corre√ß√£o (quando aplic√°vel)

```
Tool: register_correction
Args: {
  "epic": "[√©pico atual]",
  "error_description": "[descri√ß√£o clara do erro]",
  "correction_applied": "[como foi corrigido]",
  "files_affected": ["arquivo1.ts", "arquivo2.ts"]
}
```

### Push

1. NUNCA fazer push sem aprova√ß√£o expl√≠cita do usu√°rio
2. Aguardar mensagem "APROVADO - FAZER PUSH"
3. Verificar git status antes do push

---

## üõ°Ô∏è PREVEN√á√ÉO DE GAPS (PREVENT-001 a PREVENT-008)

| Regra | Descri√ß√£o |
|-------|-----------|
| PREVENT-001 | Todo novo m√≥dulo DEVE seguir template |
| PREVENT-002 | Todo Use Case em commands/ ou queries/ |
| PREVENT-003 | Todo service DEVE estar em um m√≥dulo |
| PREVENT-004 | C√≥digo em src/services/ √© PROIBIDO |
| PREVENT-005 | Domain NUNCA importa de fora |
| PREVENT-006 | branchId SEMPRE obrigat√≥rio |
| PREVENT-007 | Repository SEMPRE usa Mapper |
| PREVENT-008 | Entity SEMPRE tem create() e reconstitute() |

---

## ‚õî PROIBI√á√ïES ABSOLUTAS

- ‚ùå NUNCA usar `any` (nem em testes)
- ‚ùå NUNCA fazer push sem aprova√ß√£o
- ‚ùå NUNCA criar fun√ß√£o utilit√°ria sem us√°-la em todos os lugares
- ‚ùå NUNCA modificar m√°quina de estados global para caso espec√≠fico
- ‚ùå NUNCA validar string sem .trim()
- ‚ùå NUNCA acessar .value sem verificar Result.isFail()
- ‚ùå NUNCA deixar testes skipped
- ‚ùå NUNCA usar placeholders como 'TEMP' ou 'TODO' em c√≥digo de produ√ß√£o
- ‚ùå NUNCA fazer commits incrementais de corre√ß√£o (usar --amend)

---

## üìä REGRA DE IMPACTO CRUZADO

Antes de modificar m√©todo compartilhado (authorize, cancel, submit, etc):

1. Listar TODOS os document types que usam esse m√©todo
2. Verificar se a mudan√ßa afeta cada tipo diferentemente
3. Adicionar condicional por tipo se necess√°rio
4. Usar fun√ß√µes centralizadas ao inv√©s de hardcode

---

## üáßüá∑ CONTEXTO BRASIL (ERP Log√≠stico)

### Legisla√ß√£o Fiscal

- ICMS (Lei Complementar 87/96 - Lei Kandir)
- PIS/COFINS (Leis 10.637/02 e 10.833/03)
- SPED Fiscal, SPED Contribui√ß√µes, SPED ECD
- CTe (Conhecimento de Transporte Eletr√¥nico)
- NFe (Nota Fiscal Eletr√¥nica)
- MDFe (Manifesto de Documentos Fiscais)
- NFS-e (Nota Fiscal de Servi√ßos Eletr√¥nica)

### Reforma Tribut√°ria 2026

- IBS (Imposto sobre Bens e Servi√ßos)
- CBS (Contribui√ß√£o sobre Bens e Servi√ßos)
- IS (Imposto Seletivo)

### Reten√ß√µes na Fonte

- IRRF (1.5%)
- PIS (0.65%)
- COFINS (3%)
- CSLL (1%)
- ISS (2-5%)

---

## üîß STACK T√âCNICA

- **Backend:** Next.js 15 (App Router), TypeScript, Drizzle ORM, SQL Server 2022
- **Frontend:** React 19, Refine, AG Grid, Shadcn/UI
- **Testes:** Vitest
- **DI:** tsyringe
- **Deploy:** Coolify

---

## üìä FORMATO DE RELAT√ìRIO FINAL

Ao concluir implementa√ß√£o, reportar:

```markdown
## TAREFA CONCLU√çDA

### Verifica√ß√µes MCP
- check_cursor_issues (pr√©-commit): ‚úÖ/‚ùå
- check_cursor_issues (p√≥s-commit): ‚úÖ/‚ùå

### Verifica√ß√µes C√≥digo
- npx tsc --noEmit: ‚úÖ 0 erros
- npm test -- --run: ‚úÖ X/X passando
- grep 'as any': ‚úÖ 0 resultados

### Commits
- Hash: [hash]
- Mensagem: [mensagem]

### Push
- Status: ‚úÖ Realizado / ‚è≥ Pendente

### Corre√ß√µes Registradas
- [LC-XXXXX]: [descri√ß√£o] (se houver)
```

---

## üìÅ ARQUIVOS CR√çTICOS (CUIDADO EXTRA)

Modifica√ß√µes nesses arquivos exigem testes extras e revis√£o cuidadosa:

1. `accounting-engine.ts` - Contabiliza√ß√£o
2. `financial-title-generator.ts` - T√≠tulos financeiros
3. `sped-fiscal-generator.ts` - SPED (multa R$ 5.000+)
4. `sped-ecd-generator.ts` - SPED Cont√°bil
5. `sped-contributions-generator.ts` - SPED PIS/COFINS
6. `FiscalDocument.ts` - Documento fiscal base
7. `DocumentType.ts` - M√°quina de estados

---

**FIM DAS REGRAS v2.0 - CONSULTAR MCP E CONFIRMAR LEITURA ANTES DE COME√áAR**
