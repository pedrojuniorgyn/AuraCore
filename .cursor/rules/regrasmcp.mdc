---
description: Regras MCP obrigat√≥rias do AuraCore - Consultar contratos e verificar com grep ANTES de codificar. Zero bugs por falta de verifica√ß√£o.
globs: "**/*.ts,**/*.tsx"
alwaysApply: true
---

# AURA CORE - REGRAS MCP OBRIGAT√ìRIAS

## üö® REGRA FUNDAMENTAL (INVIOL√ÅVEL)

ANTES de implementar QUALQUER c√≥digo, o agente DEVE:

### 1. Consultar Contratos MCP
```
Tool: get_contract
Args: { "contract_id": "verify-before-code" }

Tool: get_contract
Args: { "contract_id": "code-consistency" }

Tool: get_contract
Args: { "contract_id": "type-safety" }

Tool: get_contract
Args: { "contract_id": "mcp-enforcement-rules" }

Tool: get_contract
Args: { "contract_id": "infrastructure-layer" }

Tool: get_contract
Args: { "contract_id": "known-bugs-registry" }
```

### 2. Buscar Padr√µes Relacionados
```
Tool: search_patterns
Args: { "query": "[tema da tarefa]" }
```

### 3. Verificar com GREP Antes de Usar (OBRIGAT√ìRIO)
```bash
# Interface
grep -rn "interface NomeInterface" src/

# Enum
grep -A10 "NomeEnum" src/lib/db/schema.ts

# M√©todo
grep -n "nomeMetodo(" src/modules/

# Propriedade de contexto
grep -n "propriedade:" src/lib/auth/context.ts

# SpedDocumentType (para SPED)
grep -A10 "SpedDocumentType" src/modules/fiscal/domain/value-objects/SpedDocument.ts
```

### 4. Confirmar Leitura
Responder: **"Contratos MCP consultados. Verifica√ß√µes grep realizadas. Iniciando implementa√ß√£o."**

**NUNCA pular esta etapa. Se n√£o conseguir consultar, informar o usu√°rio.**

---

## üìã REGRAS ENFORCE CR√çTICAS (MEMORIZAR)

### Verifica√ß√£o Obrigat√≥ria (ENFORCE-030 a 039)
- **ENFORCE-030:** Validar exist√™ncia de propriedade ANTES de acessar
- **ENFORCE-031:** NUNCA assumir schema - sempre verificar estrutura real
- **ENFORCE-032:** Validar tipo ANTES de fazer cast/assertion
- **ENFORCE-033:** Verificar JSON/dados reais ANTES de criar interface
- **ENFORCE-034:** NUNCA usar `as Type` sem valida√ß√£o pr√©via
- **ENFORCE-035:** Verificar interface TenantContext antes de usar propriedades
- **ENFORCE-036:** Verificar m√©todos existentes na classe antes de chamar
- **ENFORCE-037:** Verificar valores v√°lidos de enum no schema.ts
- **ENFORCE-038:** Verificar assinatura de m√©todo (par√¢metros) antes de chamar
- **ENFORCE-039:** NUNCA implementar encoding/convers√£o manualmente se m√©todo existe

### Consist√™ncia de C√≥digo (ENFORCE-040 a 045)
- **ENFORCE-040:** NUNCA any - SEMPRE unknown ou tipo expl√≠cito
- **ENFORCE-041:** Array.isArray() ANTES de usar m√©todos de array
- **ENFORCE-042:** Manter consist√™ncia entre declara√ß√£o e retorno de MIME types
- **ENFORCE-043:** Usar Promise.allSettled() para graceful degradation
- **ENFORCE-044:** Validar TIPO dos elementos AP√ìS confirmar que √© array
- **ENFORCE-045:** Validar que string n√£o √© vazia AL√âM de verificar tipo

### Error Handling (ENFORCE-050 a 051)
- **ENFORCE-050:** Try-catch OBRIGAT√ìRIO em todos handlers e opera√ß√µes I/O
- **ENFORCE-051:** SEMPRE re-throw erros desconhecidos - nunca silenciar

### Seguran√ßa (ENFORCE-055 a 056)
- **ENFORCE-055:** SEMPRE sanitizar IDs/inputs antes de usar em paths
- **ENFORCE-056:** Regex deve ser espec√≠fico - verificar contexto primeiro

### SPED Espec√≠fico (ENFORCE-060 a 067)
- **ENFORCE-060:** Encoding DEVE ser ISO-8859-1 via toBuffer(), NUNCA convers√£o manual
- **ENFORCE-061:** Formato DEVE ser pipe-delimited: |REG|CAMPO1|CAMPO2|
- **ENFORCE-062:** Quebra de linha DEVE ser CRLF (\r\n)
- **ENFORCE-063:** Datas DEVEM estar no formato DDMMAAAA
- **ENFORCE-064:** Valores num√©ricos SEM separador de milhar, COM v√≠rgula decimal
- **ENFORCE-065:** Bloco 9 DEVE totalizar corretamente todos os registros
- **ENFORCE-066:** SpedDocument.create() DEVE receber { documentType, blocks }
- **ENFORCE-067:** SEMPRE usar ctx.defaultBranchId (n√£o ctx.branchId)

---

## ‚ùå PROIBI√á√ïES ABSOLUTAS (VIOLA√á√ÉO = REJEI√á√ÉO)

### TypeScript Strict
- NUNCA usar `any` (usar `unknown` ou tipo expl√≠cito)
- NUNCA usar `@ts-ignore`
- NUNCA usar `as any`

### Verifica√ß√£o
- NUNCA inventar valores de enum sem verificar com grep
- NUNCA assumir nome de propriedade sem verificar interface
- NUNCA chamar m√©todo sem verificar se existe
- NUNCA acessar `result.error.message` sem type guard
- NUNCA acessar `.value` sem verificar `Result.isFail()`

### Implementa√ß√£o
- NUNCA converter BigInt para Number
- NUNCA implementar encoding manualmente
- NUNCA modificar interface sem atualizar TODOS os consumidores
- NUNCA criar fun√ß√£o utilit√°ria sem us√°-la em todos os lugares
- NUNCA modificar m√°quina de estados global para caso espec√≠fico
- NUNCA validar string sem .trim()
- NUNCA deixar testes skipped
- NUNCA usar placeholders como 'TEMP' ou 'TODO' em c√≥digo de produ√ß√£o

### Git
- NUNCA fazer push sem aprova√ß√£o expl√≠cita
- NUNCA fazer commits incrementais de corre√ß√£o (usar --amend)

---

## ‚úÖ SEMPRE FAZER (OBRIGAT√ìRIO)

1. **SEMPRE** consultar MCP antes de codificar
2. **SEMPRE** usar grep para verificar defini√ß√µes
3. **SEMPRE** validar propriedades nullable antes de usar
4. **SEMPRE** usar Result pattern para opera√ß√µes fal√≠veis
5. **SEMPRE** incluir organizationId + branchId (multi-tenancy)
6. **SEMPRE** registrar corre√ß√µes com register_correction
7. **SEMPRE** aguardar autoriza√ß√£o para push
8. **SEMPRE** validar input com Zod em rotas API
9. **SEMPRE** usar .trim() antes de validar comprimento de strings
10. **SEMPRE** usar transa√ß√µes em opera√ß√µes multi-step (withMssqlTransaction)

---

## üìã FLUXO DE COMMIT OBRIGAT√ìRIO

### Pr√©-Codifica√ß√£o
```
1. get_contract("verify-before-code")
2. get_contract("code-consistency")
3. search_patterns("[tema]")
4. grep para verificar interfaces/enums/m√©todos
5. Confirmar: "Contratos consultados. Iniciando."
```

### Pr√©-Commit
```
1. npx tsc --noEmit (deve retornar 0 erros)
2. npm test -- --run (todos devem passar, 0 skipped)
3. grep -r "as any" src/ (deve retornar 0 resultados)
4. check_cursor_issues (deve retornar 0 issues)
5. Se QUALQUER verifica√ß√£o falhar: corrigir antes de commit
6. Se tudo passar: fazer UM commit limpo
```

### P√≥s-Commit
```
1. check_cursor_issues novamente
2. Se issues > 0: corrigir + register_correction + git commit --amend
3. Se issues = 0: reportar para aprova√ß√£o
```

### Push
```
1. NUNCA fazer push sem aprova√ß√£o expl√≠cita
2. Aguardar mensagem "APROVADO - FAZER PUSH"
3. Verificar git status antes do push (sem arquivos pendentes)
```

---

## üìä TEMPLATE DE VERIFICA√á√ÉO PR√â-C√ìDIGO

Antes de escrever c√≥digo, executar:

```bash
# 1. Se vai usar interface
grep -rn "interface NomeDaInterface" src/

# 2. Se vai usar enum
grep -A10 "NomeDoEnum" src/lib/db/schema.ts

# 3. Se vai chamar m√©todo
grep -n "nomeDoMetodo(" src/modules/

# 4. Se vai usar propriedade de contexto
grep -n "defaultBranchId" src/lib/auth/context.ts

# 5. Se vai criar arquivo SPED
grep -A10 "SpedDocumentType" src/modules/fiscal/domain/value-objects/SpedDocument.ts

# 6. Se vai usar tipo de documento
grep -A20 "documentType" src/modules/fiscal/domain/value-objects/SpedDocument.ts
```

---

## üîÑ REGRA DE IMPACTO CRUZADO

Antes de modificar m√©todo compartilhado (authorize, cancel, submit, etc):

1. Listar TODOS os document types que usam esse m√©todo
2. Verificar se a mudan√ßa afeta cada tipo diferentemente
3. Adicionar condicional por tipo se necess√°rio
4. Usar fun√ß√µes centralizadas ao inv√©s de hardcode
5. Atualizar TODOS os consumidores da interface modificada

---

## üìê MAPEAMENTO DOMAIN-PERSISTENCE

- Schema DEVE espelhar Domain COMPLETO
- Money = 2 campos (amount + currency)
- Campos opcionais = .nullable()
- toDomain usa reconstitute(), N√ÉO create()
- UPDATE com TODOS os campos mut√°veis

---

## üîß FUN√á√ïES UTILIT√ÅRIAS

Quando criar fun√ß√£o utilit√°ria (ex: canTransitionTo):
- USAR a fun√ß√£o em TODOS os lugares relevantes
- REMOVER c√≥digo duplicado que a fun√ß√£o substitui
- NUNCA deixar l√≥gica hardcoded quando existe fun√ß√£o centralizada

---

## ‚öôÔ∏è M√ÅQUINA DE ESTADOS

- Transi√ß√µes que diferem por tipo de documento DEVEM ter m√°quinas separadas
- NUNCA modificar m√°quina global para caso espec√≠fico de um tipo
- SEMPRE usar canTransitionTo(from, to, documentType)

---

## üáßüá∑ CONTEXTO BRASIL (ERP Log√≠stico)

### Legisla√ß√£o Fiscal
- ICMS (Lei Complementar 87/96 - Lei Kandir)
- PIS/COFINS (Leis 10.637/02 e 10.833/03)
- SPED Fiscal, SPED Contribui√ß√µes, SPED ECD
- CTe (Conhecimento de Transporte Eletr√¥nico)
- NFe (Nota Fiscal Eletr√¥nica)
- MDFe (Manifesto de Documentos Fiscais)
- NFS-e (Nota Fiscal de Servi√ßos Eletr√¥nica)

### Reforma Tribut√°ria 2026
- IBS (Imposto sobre Bens e Servi√ßos)
- CBS (Contribui√ß√£o sobre Bens e Servi√ßos)
- IS (Imposto Seletivo)

### Reten√ß√µes na Fonte
- IRRF (1.5%)
- PIS (0.65%)
- COFINS (3%)
- CSLL (1%)
- ISS (2-5%)

---

## üõ†Ô∏è STACK T√âCNICA

- Backend: Next.js 15 (App Router), TypeScript, Drizzle (mssql), SQL Server 2022
- Frontend: React 19, Refine, AG Grid, Shadcn/UI
- Deploy: Coolify
- Testes: Vitest

---

## ‚ö†Ô∏è ARQUIVOS CR√çTICOS (CUIDADO EXTRA)

| Arquivo | Motivo | Risco |
|---------|--------|-------|
| accounting-engine.ts | Contabiliza√ß√£o | Multa R$ 5.000+ |
| financial-title-generator.ts | T√≠tulos financeiros | Multa R$ 5.000+ |
| sped-fiscal-generator.ts | SPED Fiscal | Multa R$ 5.000+ |
| sped-ecd-generator.ts | SPED Cont√°bil | Multa R$ 5.000+ |
| sped-contributions-generator.ts | SPED PIS/COFINS | Multa R$ 5.000+ |
| FiscalDocument.ts | Documento fiscal base | Alto |
| DocumentType.ts | M√°quina de estados | Alto |

Modifica√ß√µes nesses arquivos exigem:
- Verifica√ß√£o tripla
- Testes extras
- Revis√£o cuidadosa

---

## üìù FORMATO DE RELAT√ìRIO FINAL

```markdown
## TAREFA CONCLU√çDA

### Verifica√ß√µes MCP
- Contratos consultados: ‚úÖ
- grep executado: ‚úÖ
- check_cursor_issues (pr√©-commit): ‚úÖ 0 issues
- check_cursor_issues (p√≥s-commit): ‚úÖ 0 issues

### Valida√ß√µes Pr√©-Commit
- npx tsc --noEmit: 0 erros
- npm test -- --run: X/X passando
- grep "as any": 0 resultados

### Commits
- Hash: [hash]
- Mensagem: [mensagem]

### Push
- Status: ‚è≥ AGUARDANDO AUTORIZA√á√ÉO

### Corre√ß√µes Registradas
- [LC-XXXXX]: [descri√ß√£o] (se houver)

N√ÉO FOI FEITO PUSH. Aguardando aprova√ß√£o.
```

---

## üéØ OBJETIVO FINAL

**Zero bugs por falta de verifica√ß√£o.**

Cada linha de c√≥digo deve ser baseada em:
- ‚úÖ Contratos MCP consultados
- ‚úÖ Interfaces verificadas com grep
- ‚úÖ Enums confirmados no schema
- ‚úÖ M√©todos existentes na classe
- ‚úÖ Propriedades nullable tratadas

**Se n√£o verificou, N√ÉO ESCREVA O C√ìDIGO.**

---

FIM DAS REGRAS - CONSULTAR MCP E CONFIRMAR LEITURA ANTES DE COME√áAR
