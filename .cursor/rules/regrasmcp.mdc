---
description: Regras MCP obrigat√≥rias do AuraCore - Arquitetura 100% DDD/Hexagonal, TypeScript strict, padr√µes de c√≥digo. Consultar contratos e verificar com grep ANTES de codificar. Zero bugs por falta de verifica√ß√£o.
globs: "**/*.ts,**/*.tsx"
alwaysApply: true
---

# AURA CORE - REGRAS MCP OBRIGAT√ìRIAS v2.0

**Vers√£o:** 2.0.0  
**Data:** 06/01/2026  
**Arquitetura:** 100% DDD/Hexagonal (ADR-0015)

---

## üîí PROTOCOLO DE EXECU√á√ÉO OBRIGAT√ìRIO (SEMPRE ATIVO)

> **‚ö†Ô∏è ATEN√á√ÉO CR√çTICA:** Este protocolo √© AUTOMATICAMENTE ATIVO em TODA tarefa.
> O Agent DEVE EXECUTAR E MOSTRAR cada etapa. Executar internamente sem mostrar √© VIOLA√á√ÉO.
> Pular qualquer etapa invalida TODA a execu√ß√£o.

---

### üöÄ RITUAL DE IN√çCIO (OBRIGAT√ìRIO - N√ÉO PULAR)

**ANTES de qualquer an√°lise ou edi√ß√£o, o Agent DEVE mostrar:**

```
üîí EXECUTANDO RITUAL DE IN√çCIO...
```

**Ent√£o executar E mostrar os resultados:**

```
Tool: get_contract
Args: { "contract_id": "verify-before-code" }
[mostrar resultado ou resumo]

Tool: get_contract
Args: { "contract_id": "known-bugs-registry" }
[mostrar resultado ou resumo]
```

**Ent√£o ler anti-patterns:**

```bash
cat docs/mcp/SMP_ANTI_PATTERNS.md | head -50
```

**Finalizar com:**

```
‚úÖ RITUAL DE IN√çCIO CONCLU√çDO
```

> ‚õî Se o Agent N√ÉO mostrar "üîí EXECUTANDO RITUAL DE IN√çCIO..." no in√≠cio,
> a execu√ß√£o √© considerada INV√ÅLIDA.

---

### üìù PROTOCOLO POR ARQUIVO (5 PASSOS OBRIGAT√ìRIOS)

Para CADA arquivo que for modificar:

#### PASSO 1: VERBALIZAR (FORMATO EXATO OBRIGAT√ìRIO)

```
üìù EDITANDO: [caminho/completo/arquivo.ts]
   REGRA: [ID] - [descri√ß√£o da regra]
   ANTI-PATTERN: [AP-ID] - [o que N√ÉO fazer]
   PADR√ÉO: [c√≥digo correto resumido]
```

> ‚õî Usar EXATAMENTE este formato. Varia√ß√µes s√£o consideradas VIOLA√á√ÉO.

#### PASSO 2: CONSULTAR (OBRIGAT√ìRIO - N√ÉO ASSUMIR)

**MESMO que o Agent "j√° saiba" o padr√£o, DEVE mostrar a consulta:**

```bash
# Consultar padr√£o correto:
grep -A10 "[ID-da-regra]" docs/mcp/SMP_PATTERNS_CATALOG.md

# Consultar anti-pattern:
grep -A10 "[AP-ID]" docs/mcp/SMP_ANTI_PATTERNS.md
```

> ‚õî Regra GR-004: NUNCA assumir que "j√° sabe" o padr√£o. SEMPRE consultar e mostrar.

#### PASSO 3: EDITAR

Aplicar a corre√ß√£o usando APENAS padr√µes catalogados.

#### PASSO 4: VERIFICAR (OBRIGAT√ìRIO)

```bash
# Verificar que padr√£o antigo foi eliminado:
grep -n "[padr√£o antigo]" [arquivo]
# DEVE mostrar: 0 resultados
```

> ‚õî Se resultado > 0: PARAR e corrigir antes de prosseguir.

#### PASSO 5: REPORTAR (FORMATO EXATO)

```
‚úÖ [caminho/arquivo.ts] corrigido
   Padr√£o aplicado: [ID]
   Verifica√ß√£o: grep = 0
```

---

### üîÑ CHECKPOINT A CADA 3 ARQUIVOS

Ap√≥s editar cada 3 arquivos:

```bash
# Verifica√ß√£o em lote:
grep -rn "[padr√£o antigo]" src/ --include="*.ts" | wc -l

# Compila√ß√£o:
npx tsc --noEmit 2>&1 | head -20
```

**Mostrar:**
```
üîÑ CHECKPOINT (3 arquivos)
   Padr√£o antigo restante: [N]
   Compila√ß√£o: [OK/ERRO]
```

---

### üèÜ REGRAS DE OURO (NUNCA VIOLAR)

| # | Regra | Verifica√ß√£o |
|---|-------|-------------|
| GR-001 | NUNCA usar padr√£o n√£o catalogado | Consultar cat√°logo antes |
| GR-002 | NUNCA pular verifica√ß√£o p√≥s-edi√ß√£o | grep obrigat√≥rio |
| GR-003 | NUNCA editar pr√≥ximo se verifica√ß√£o falhou | Parar e corrigir |
| GR-004 | NUNCA assumir que "j√° sabe" o padr√£o | SEMPRE consultar e mostrar |
| GR-005 | SEMPRE verbalizar ANTES de editar | Formato exato obrigat√≥rio |
| GR-006 | SEMPRE mostrar ritual de in√≠cio | "üîí EXECUTANDO..." obrigat√≥rio |

---

### ‚ö†Ô∏è PENALIDADES POR VIOLA√á√ÉO

Se Agent violar QUALQUER regra:
1. ‚ùå Execu√ß√£o considerada INV√ÅLIDA
2. üìù Usu√°rio reportar√° como BUG
3. üîÑ Agent DEVE refazer do in√≠cio
4. üìö Nova li√ß√£o aprendida ser√° documentada

---

### üìã EXEMPLO COMPLETO DE EXECU√á√ÉO CORRETA

```
üîí EXECUTANDO RITUAL DE IN√çCIO...

Tool: get_contract
Args: { "contract_id": "verify-before-code" }
[Resultado: contrato com regras de verifica√ß√£o]

Tool: get_contract
Args: { "contract_id": "known-bugs-registry" }
[Resultado: bugs conhecidos]

cat docs/mcp/SMP_ANTI_PATTERNS.md | head -50
[Mostra anti-patterns relevantes]

‚úÖ RITUAL DE IN√çCIO CONCLU√çDO

---

üìù EDITANDO: src/services/accounting-engine.ts
   REGRA: P-DB-006 - getFirstRow DEVE ter verifica√ß√£o null
   ANTI-PATTERN: AP-003 - acesso a propriedade de undefined
   PADR√ÉO: getFirstRowOrThrow() ou verifica√ß√£o manual

grep -A10 "P-DB-006" docs/mcp/SMP_PATTERNS_CATALOG.md
[Mostra padr√£o correto]

[Aplica edi√ß√£o]

grep -n "getFirstRow[^O]" src/services/accounting-engine.ts
[Resultado: 0]

‚úÖ src/services/accounting-engine.ts corrigido
   Padr√£o aplicado: P-DB-006
   Verifica√ß√£o: grep = 0
```

---

## üö® REGRA FUNDAMENTAL (INVIOL√ÅVEL)

ANTES de implementar QUALQUER c√≥digo, o agente DEVE:

### 1. Consultar Contratos MCP

```
Tool: get_contract
Args: { "contract_id": "verify-before-code" }

Tool: get_contract
Args: { "contract_id": "code-consistency" }

Tool: get_contract
Args: { "contract_id": "type-safety" }

Tool: get_contract
Args: { "contract_id": "mcp-enforcement-rules" }

Tool: get_contract
Args: { "contract_id": "infrastructure-layer" }

Tool: get_contract
Args: { "contract_id": "known-bugs-registry" }

Tool: get_contract
Args: { "contract_id": "architecture-layers" }

Tool: get_contract
Args: { "contract_id": "schema-pattern" }

Tool: get_contract
Args: { "contract_id": "smp-methodology" }

Tool: get_contract
Args: { "contract_id": "lesson-learned" }
```

### 2. Buscar Padr√µes Relacionados

```
Tool: search_patterns
Args: { "query": "[tema da tarefa]" }
```

### 3. Verificar com GREP Antes de Usar (OBRIGAT√ìRIO)

```bash
# Interface
grep -rn "interface NomeInterface" src/

# Enum
grep -A10 "NomeEnum" src/lib/db/schema.ts

# M√©todo
grep -n "nomeMetodo(" src/modules/

# Propriedade de contexto
grep -n "propriedade:" src/lib/auth/context.ts

# SpedDocumentType (para SPED)
grep -A10 "SpedDocumentType" src/modules/fiscal/domain/value-objects/SpedDocument.ts

# Entity existente
grep -rn "class NomeEntity" src/modules/

# Value Object existente
grep -rn "class NomeVO extends ValueObject" src/modules/

# Repository interface
grep -rn "interface I.*Repository" src/modules/
```

### 4. Confirmar Leitura

Responder: **"Contratos MCP consultados. Verifica√ß√µes grep realizadas. Iniciando implementa√ß√£o."**

**NUNCA pular esta etapa. Se n√£o conseguir consultar, informar o usu√°rio.**

---

## üìê ARQUITETURA - REGRAS INVIOL√ÅVEIS (ARCH-001 a ARCH-015)

### Depend√™ncias entre Camadas

| Regra | Descri√ß√£o | Prioridade |
|-------|-----------|------------|
| ARCH-001 | Domain N√ÉO importa de Application | CR√çTICA |
| ARCH-002 | Domain N√ÉO importa de Infrastructure | CR√çTICA |
| ARCH-003 | Domain N√ÉO importa bibliotecas externas (drizzle, axios) | CR√çTICA |
| ARCH-004 | Domain N√ÉO importa m√≥dulos Node.js (fs, path, crypto) | CR√çTICA |
| ARCH-005 | Application N√ÉO importa de Infrastructure (exceto via DI) | ALTA |
| ARCH-006 | Depend√™ncias SEMPRE apontam para Domain (inward) | CR√çTICA |
| ARCH-007 | Entities t√™m comportamento (n√£o s√£o an√™micas) | ALTA |
| ARCH-008 | Value Objects s√£o imut√°veis (Object.freeze) | ALTA |
| ARCH-009 | Domain Services s√£o stateless (m√©todos est√°ticos) | ALTA |
| ARCH-010 | Use Cases implementam interface de domain/ports/input/ | ALTA |
| ARCH-011 | Repositories implementam interface de domain/ports/output/ | ALTA |
| ARCH-012 | Commands em application/commands/ | M√âDIA |
| ARCH-013 | Queries em application/queries/ | M√âDIA |
| ARCH-014 | Mappers t√™m toDomain() e toPersistence() | ALTA |
| ARCH-015 | toDomain() usa reconstitute(), n√£o create() | ALTA |

### Estrutura de Pastas Obrigat√≥ria

```
src/modules/{module}/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ aggregates/         # ‚Üê Aggregates Root (opcional)
‚îÇ   ‚îú‚îÄ‚îÄ value-objects/
‚îÇ   ‚îú‚îÄ‚îÄ services/           # ‚Üê OBRIGAT√ìRIO
‚îÇ   ‚îú‚îÄ‚îÄ events/
‚îÇ   ‚îú‚îÄ‚îÄ errors/
‚îÇ   ‚îî‚îÄ‚îÄ ports/
‚îÇ       ‚îú‚îÄ‚îÄ input/          # ‚Üê OBRIGAT√ìRIO
‚îÇ       ‚îî‚îÄ‚îÄ output/         # ‚Üê OBRIGAT√ìRIO
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îú‚îÄ‚îÄ commands/           # ‚Üê OBRIGAT√ìRIO
‚îÇ   ‚îú‚îÄ‚îÄ queries/            # ‚Üê OBRIGAT√ìRIO
‚îÇ   ‚îî‚îÄ‚îÄ dtos/
‚îî‚îÄ‚îÄ infrastructure/
    ‚îú‚îÄ‚îÄ persistence/
    ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
    ‚îÇ   ‚îú‚îÄ‚îÄ mappers/
    ‚îÇ   ‚îî‚îÄ‚îÄ schemas/        # 1 arquivo por tabela
    ‚îî‚îÄ‚îÄ di/
```

**Nota sobre Aggregates:**
- Aggregates simples podem ficar em `entities/` 
- Aggregates complexos com entidades filhas devem ficar em `aggregates/`
- Aggregate Root SEMPRE estende `AggregateRoot<string>`

---

## üóÑÔ∏è BANCO DE DADOS - SCHEMA PATTERN (SCHEMA-001 a SCHEMA-010)

| Regra | Descri√ß√£o | Prioridade |
|-------|-----------|------------|
| SCHEMA-001 | Um arquivo schema por tabela | ALTA |
| SCHEMA-002 | Nome: {entity}.schema.ts (lowercase) | M√âDIA |
| SCHEMA-003 | √çndice composto: (organizationId, branchId) | CR√çTICA |
| SCHEMA-004 | √çndices para filtros frequentes | ALTA |
| SCHEMA-005 | Campos: createdAt, updatedAt obrigat√≥rios | ALTA |
| SCHEMA-006 | Soft delete: deletedAt nullable | ALTA |
| SCHEMA-007 | Money = 2 colunas (amount + currency) | ALTA |
| SCHEMA-008 | Export const tableName = mssqlTable(...) | M√âDIA |
| SCHEMA-009 | Tipos inferidos: $inferSelect, $inferInsert | ALTA |
| SCHEMA-010 | √çndice √∫nico para chaves naturais | M√âDIA |

---

## üîÑ MIGRATIONS - REGRAS OBRIGAT√ìRIAS (MIGRATION-001 a MIGRATION-006)

### Cria√ß√£o de Migrations

| Regra | Descri√ß√£o | Prioridade |
|-------|-----------|------------|
| MIGRATION-001 | SEMPRE validar colunas existem antes de criar √≠ndices | CR√çTICA |
| MIGRATION-002 | NUNCA usar `drizzle-kit push` em produ√ß√£o/homologa√ß√£o | CR√çTICA |
| MIGRATION-003 | SEMPRE iniciar migration com `SET QUOTED_IDENTIFIER ON; SET ANSI_NULLS ON;` | ALTA |
| MIGRATION-004 | SEMPRE usar `IF NOT EXISTS` para CREATE INDEX | ALTA |
| MIGRATION-005 | SEMPRE testar migration em ambiente local ANTES de homolog/prod | CR√çTICA |
| MIGRATION-006 | NUNCA criar migration sem verificar schema real do banco | ALTA |

### Valida√ß√£o Pr√©-Migration

```sql
-- OBRIGAT√ìRIO antes de criar √≠ndice
SELECT COLUMN_NAME 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'nome_tabela';

-- Verificar se √≠ndice j√° existe
SELECT name FROM sys.indexes WHERE name = 'nome_indice';
```

### Comandos Proibidos em Produ√ß√£o

| Comando | Risco | Alternativa |
|---------|-------|-------------|
| `drizzle-kit push` | DATA LOSS | Migration SQL manual |
| `drizzle-kit drop` | DATA LOSS | Migration com DROP controlado |
| `DROP TABLE` sem backup | DATA LOSS | Backup + valida√ß√£o primeiro |
| `TRUNCATE TABLE` | DATA LOSS | DELETE com WHERE |
| `DELETE sem WHERE` | DATA LOSS | DELETE com filtro espec√≠fico |

### Template de Migration SQL

```sql
-- Migration: XXXX_descricao.sql
-- Data: YYYY-MM-DD
-- √âpico: EX.X
-- Autor: [nome]
--
-- IMPORTANTE: Testar em ambiente local antes de executar em homolog/prod
-- Rollback: [comandos de rollback]

SET QUOTED_IDENTIFIER ON;
SET ANSI_NULLS ON;
GO

-- √çndice 1: [descri√ß√£o]
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'idx_xxx')
BEGIN
    CREATE NONCLUSTERED INDEX [idx_xxx] ON [tabela] ([col1], [col2])
    INCLUDE ([col3], [col4])
    WHERE [deleted_at] IS NULL;
    PRINT 'Criado: idx_xxx';
END
GO
```

### Li√ß√µes Aprendidas (E8.4)

| ID | Incidente | Corre√ß√£o |
|----|-----------|----------|
| LC-740883 | Migration com colunas inexistentes | Validar INFORMATION_SCHEMA |
| LC-743510 | drizzle-kit push causou DATA LOSS | Usar migrations manuais |
| LC-745627 | √çndices filtrados falharam | SET QUOTED_IDENTIFIER ON |

---

## üî∑ ENTITY PATTERN (ENTITY-001 a ENTITY-012)

| Regra | Descri√ß√£o |
|-------|-----------|
| ENTITY-001 | Extends AggregateRoot<string> ou Entity<string> |
| ENTITY-002 | Factory method create() com valida√ß√µes |
| ENTITY-003 | M√©todo reconstitute() sem valida√ß√µes |
| ENTITY-004 | create() retorna Result<Entity, string> |
| ENTITY-005 | NUNCA setters p√∫blicos |
| ENTITY-006 | Getters para propriedades |
| ENTITY-007 | M√©todos de neg√≥cio (approve, cancel, etc) |
| ENTITY-008 | Validar invariantes em create() |
| ENTITY-009 | Emitir Domain Events em mudan√ßas de estado |
| ENTITY-010 | ID gerado internamente (crypto.randomUUID) |
| ENTITY-011 | Multi-tenancy: organizationId + branchId |
| ENTITY-012 | Timestamps: createdAt, updatedAt |

---

## üî∂ VALUE OBJECT PATTERN (VO-001 a VO-010)

| Regra | Descri√ß√£o |
|-------|-----------|
| VO-001 | Extends ValueObject<Props> |
| VO-002 | Props extends Record<string, unknown> |
| VO-003 | Constructor privado |
| VO-004 | Factory method create() est√°tico |
| VO-005 | Object.freeze no constructor |
| VO-006 | Imut√°vel (sem m√©todos que alteram estado) |
| VO-007 | Compara√ß√£o por valor (equals) |
| VO-008 | Valida√ß√µes em create() |
| VO-009 | Retorna Result<VO, string> |
| VO-010 | toString() para debug |

---

## üîµ DOMAIN SERVICE PATTERN (DOMAIN-SVC-001 a DOMAIN-SVC-010)

| Regra | Descri√ß√£o |
|-------|-----------|
| DOMAIN-SVC-001 | 100% Stateless (m√©todos est√°ticos) |
| DOMAIN-SVC-002 | Constructor privado (impede instancia√ß√£o) |
| DOMAIN-SVC-003 | Retorna Result<T, string> |
| DOMAIN-SVC-004 | NUNCA faz throw |
| DOMAIN-SVC-005 | ZERO depend√™ncias de infraestrutura |
| DOMAIN-SVC-006 | ZERO acesso a banco de dados |
| DOMAIN-SVC-007 | 100% test√°vel sem mocks |
| DOMAIN-SVC-008 | L√≥gica de neg√≥cio PURA |
| DOMAIN-SVC-009 | Localiza√ß√£o: domain/services/ |
| DOMAIN-SVC-010 | Nome descritivo: {A√ß√£o}Calculator, {A√ß√£o}Validator |

---

## üü£ USE CASE PATTERN (USE-CASE-001 a USE-CASE-015)

| Regra | Descri√ß√£o |
|-------|-----------|
| USE-CASE-001 | Commands em application/commands/ |
| USE-CASE-002 | Queries em application/queries/ |
| USE-CASE-003 | Implementa interface de domain/ports/input/ |
| USE-CASE-004 | M√©todo √∫nico: execute() |
| USE-CASE-005 | Recebe ExecutionContext (userId, orgId, branchId) |
| USE-CASE-006 | Retorna Promise<Result<Output, string>> |
| USE-CASE-007 | Valida input (Zod ou manual) |
| USE-CASE-008 | Verifica multi-tenancy |
| USE-CASE-009 | Delega l√≥gica para Domain |
| USE-CASE-010 | Usa DI para dependencies |
| USE-CASE-011 | @injectable() decorator |
| USE-CASE-012 | Commands podem modificar estado |
| USE-CASE-013 | Queries NUNCA modificam estado |
| USE-CASE-014 | Publica Domain Events |
| USE-CASE-015 | Gerencia transa√ß√µes |

---

## üü¢ REPOSITORY PATTERN (REPO-001 a REPO-012)

| Regra | Descri√ß√£o |
|-------|-----------|
| REPO-001 | Interface em domain/ports/output/ |
| REPO-002 | Implementa√ß√£o em infrastructure/persistence/repositories/ |
| REPO-003 | Implementa interface do domain |
| REPO-004 | Usa Mapper para convers√£o |
| REPO-005 | TODA query filtra organizationId + branchId |
| REPO-006 | Soft delete: filtrar deletedAt IS NULL |
| REPO-007 | UPSERT com onConflictDoUpdate |
| REPO-008 | Transa√ß√µes para opera√ß√µes m√∫ltiplas |
| REPO-009 | Pagina√ß√£o obrigat√≥ria em findMany |
| REPO-010 | Retorna Domain Entity, n√£o row do banco |
| REPO-011 | @injectable() decorator |
| REPO-012 | Nome: Drizzle{Entity}Repository |

---

## üü° MAPPER PATTERN (MAPPER-001 a MAPPER-008)

| Regra | Descri√ß√£o |
|-------|-----------|
| MAPPER-001 | Localiza√ß√£o: infrastructure/persistence/mappers/ |
| MAPPER-002 | M√©todo toDomain(row): Result<Entity, string> |
| MAPPER-003 | M√©todo toPersistence(entity): Insert |
| MAPPER-004 | toDomain usa reconstitute(), NUNCA create() |
| MAPPER-005 | Money ‚Üí 2 campos (amount, currency) |
| MAPPER-006 | Validar convers√£o de Value Objects |
| MAPPER-007 | Classe com m√©todos est√°ticos |
| MAPPER-008 | Nome: {Entity}Mapper |

---

## üî¥ REGRAS CR√çTICAS DE C√ìDIGO

### TypeScript Strict

- ‚ùå NUNCA usar `any` (usar tipo espec√≠fico, generic, ou `unknown`)
- ‚ùå NUNCA usar `@ts-ignore`
- ‚ùå NUNCA usar `as any`
- ‚úÖ SEMPRE tipar retornos de fun√ß√£o
- ‚úÖ SEMPRE tipar par√¢metros

### Hierarquia de Tipos (OBRIGAT√ìRIA)

Usar na ordem de prefer√™ncia (1 = melhor):

| Prioridade | Tipo | Quando Usar | Exemplo |
|------------|------|-------------|---------|
| 1Ô∏è‚É£ | **Interface/Type espec√≠fico** | Estrutura conhecida | `FiscalDocument`, `ICellRendererParams` |
| 2Ô∏è‚É£ | **Union types** | Poucos tipos poss√≠veis | `string \| number \| null` |
| 3Ô∏è‚É£ | **Generics** | Tipo vari√°vel mas consistente | `Result<T, E>`, `Array<T>` |
| 4Ô∏è‚É£ | **Record<K, V>** | Objetos de configura√ß√£o | `Record<string, string>` |
| 5Ô∏è‚É£ | **`unknown`** | Tipo genuinamente desconhecido | catch blocks, JSON.parse |
| ‚ùå | **`any`** | **NUNCA** | - |

### Uso Correto de `unknown` (TYPE-UNKNOWN-001 a TYPE-UNKNOWN-005)

| Regra | Contexto | Exemplo Correto |
|-------|----------|-----------------|
| TYPE-UNKNOWN-001 | **Catch blocks** | `catch (error: unknown)` |
| TYPE-UNKNOWN-002 | **JSON.parse n√£o validado** | `const data: unknown = JSON.parse(str)` |
| TYPE-UNKNOWN-003 | **APIs externas sem contrato** | `const response: unknown = await externalApi()` |
| TYPE-UNKNOWN-004 | **Event handlers gen√©ricos** | `onCustomEvent: (data: unknown) => void` |
| TYPE-UNKNOWN-005 | **Dados de formul√°rio din√¢mico** | `formData: Record<string, unknown>` |

### Uso INCORRETO de `unknown` (NUNCA UTILIZAR)

| ‚ùå Incorreto | ‚úÖ Correto | Motivo |
|-------------|-----------|--------|
| `params: unknown` (AG Grid) | `params: ICellRendererParams` | Tipo espec√≠fico existe |
| `event: unknown` (React) | `event: React.MouseEvent` | Tipo espec√≠fico existe |
| `value: unknown` (quando sabe tipos) | `value: string \| number` | Union type √© mais preciso |
| `config: unknown` | `config: Record<string, string>` | Record √© mais preciso |
| `callback: (x: unknown) => unknown` | `callback: <T>(x: T) => T` | Generic preserva tipo |

### Type Guards Obrigat√≥rios com `unknown`

Sempre que usar `unknown`, implementar type guard:

```typescript
// ‚úÖ CORRETO: Type guard para catch
catch (error: unknown) {
  const message = error instanceof Error 
    ? error.message 
    : String(error);
}

// ‚úÖ CORRETO: Type guard para JSON
const data: unknown = JSON.parse(jsonString);
if (isFiscalDocument(data)) {
  // TypeScript sabe que √© FiscalDocument
  console.log(data.documentNumber);
}

// ‚úÖ CORRETO: Type guard function
function isFiscalDocument(data: unknown): data is FiscalDocument {
  return (
    typeof data === 'object' &&
    data !== null &&
    'documentNumber' in data &&
    'documentType' in data
  );
}
```

### Valida√ß√£o de Input

- ‚úÖ SEMPRE validar input com Zod em rotas API
- ‚úÖ SEMPRE usar .trim() antes de validar comprimento de strings
- ‚úÖ SEMPRE verificar Result.isFail() antes de acessar .value

### Result Pattern

- ‚úÖ SEMPRE verificar Result.isFail() antes de acessar .value
- ‚úÖ SEMPRE retornar Result em opera√ß√µes que podem falhar
- ‚ùå NUNCA fazer throw para erros de neg√≥cio
- ‚ùå NUNCA acessar .value sem verificar

### Multi-Tenancy

- ‚úÖ SEMPRE filtrar por organizationId + branchId
- ‚ùå branchId NUNCA pode ser opcional em filters
- ‚úÖ √çndice composto obrigat√≥rio no schema

### Transa√ß√µes SQL

- ‚úÖ SEMPRE usar transa√ß√£o em opera√ß√µes multi-step
- ‚úÖ Usar withMssqlTransaction helper

### Mapeamento Domain-Persistence

- ‚úÖ Schema DEVE espelhar Domain COMPLETO
- ‚úÖ Money = 2 campos (amount + currency)
- ‚úÖ Campos opcionais = .nullable()
- ‚úÖ toDomain usa reconstitute(), N√ÉO create()
- ‚úÖ UPDATE com TODOS os campos mut√°veis

### Fun√ß√µes Utilit√°rias

- ‚úÖ Quando criar fun√ß√£o utilit√°ria: USAR em TODOS os lugares
- ‚úÖ REMOVER c√≥digo duplicado que a fun√ß√£o substitui
- ‚ùå NUNCA deixar l√≥gica hardcoded quando existe fun√ß√£o centralizada

### M√°quina de Estados

- ‚úÖ Transi√ß√µes que diferem por tipo DEVEM ter m√°quinas separadas
- ‚ùå NUNCA modificar m√°quina global para caso espec√≠fico
- ‚úÖ SEMPRE usar canTransitionTo(from, to, documentType)

### Fixed Positioning com Transforms (FIXED-001)

- ‚ùå NUNCA colocar elementos `fixed` dentro de containers com CSS transform
- ‚ùå NUNCA colocar AIInsightWidget/LegislationWidget dentro de PageTransition
- ‚úÖ SEMPRE renderizar fixed elements FORA de motion containers

```tsx
// ‚úÖ CORRETO
<>
  <PageTransition>{/* conte√∫do */}</PageTransition>
  <AIInsightWidget position="bottom-right" />
</>

// ‚ùå INCORRETO
<PageTransition>
  {/* conte√∫do */}
  <AIInsightWidget position="bottom-right" /> {/* QUEBRADO! */}
</PageTransition>
```

**Por que:** CSS transforms criam novo containing block, quebrando position: fixed.  
**Contrato:** FIXED_POSITIONING_CONTRACT.md  
**Corre√ß√£o:** LC-QW5-FIXED-001 (21/01/2026)

---

## üõ°Ô∏è VERIFY-AFTER-TYPE (VAT-001 a VAT-010)

### Regras OBRIGAT√ìRIAS Ap√≥s Adicionar Qualquer Tipo

Estas regras previnem bugs introduzidos durante elimina√ß√£o de `any`:

| Regra | Descri√ß√£o | Verifica√ß√£o Obrigat√≥ria |
|-------|-----------|-------------------------|
| VAT-001 | Interface DEVE corresponder aos dados reais | `grep -A10 "variavel ="` para ver o que √© setado |
| VAT-002 | Union type DEVE incluir TODOS os valores poss√≠veis | Verificar Select/options/enum completo |
| VAT-003 | Type assertion DEVE preservar sem√¢ntica original | Se era array, continua array |
| VAT-004 | Cast de db result DEVE usar padr√£o .recordset | `grep -rn "recordset" src/` para verificar padr√£o |
| VAT-005 | Propriedades declaradas DEVEM ser setadas | Verificar TODOS os locais de atribui√ß√£o |
| VAT-006 | Fallback patterns DEVEM ser preservados | `\|\|` e `??` indicam fallback - n√£o quebrar |
| VAT-007 | Index access DEVE corresponder ao tipo | `[0]` em objeto ‚â† `[0]` em array |
| VAT-008 | Generic default DEVE ser `unknown`, n√£o `any` | `<T = unknown>` n√£o `<T = any>` |
| VAT-009 | Record<string, unknown> para dados din√¢micos | N√£o inventar interfaces para XML/JSON |
| VAT-010 | Verificar grep ANTES e DEPOIS da mudan√ßa | Confirmar que padr√£o est√° consistente |

### PATTERN-CONSISTENCY (PC-001 a PC-005)

Padr√µes espec√≠ficos do codebase AuraCore:

| Regra | Padr√£o | Exemplo Correto |
|-------|--------|-----------------|
| PC-001 | db.execute() retorna `{ recordset: T[] }` OU `T[]` | `result.recordset[0]` |
| PC-002 | Fallback db.execute usa `\|\|` pattern | `(result.recordset \|\| result)` |
| PC-003 | XML parseado usa `Record<string, unknown>` | `nfeXml: Record<string, unknown>` |
| PC-004 | Select union inclui TODOS os valores | `as 3 \| 6 \| 12 \| 24 \| 36 \| 60` |
| PC-005 | Icon className usa `h-N w-N` (altura E largura) | `className="h-5 w-5"` |
| PC-006 | NUNCA usar `Array.isArray()` em resultado db | Use `(result.recordset \|\| result)` |

### SEMANTIC-PRESERVATION (SP-001 a SP-003)

| Regra | Descri√ß√£o | Exemplo |
|-------|-----------|---------|
| SP-001 | Cast N√ÉO muda comportamento | Se `[0]` funcionava antes, deve funcionar depois |
| SP-002 | Fallback N√ÉO √© quebrado | `a \|\| b` - ambos devem funcionar |
| SP-003 | Tipo infere do USO, n√£o da declara√ß√£o | Ver como a vari√°vel √© USADA, n√£o s√≥ declarada |

### Exemplo de Bug Prevenido por VAT-007 e PC-006

```typescript
// ‚ùå ERRADO - [0] em objeto retorna undefined
const rule = result.recordset?.[0] || (result as { recordset: T[] })[0];
// Problema: [0] acessa propriedade "0" do OBJETO, n√£o elemento do array!

// ‚ùå ERRADO - Array.isArray √© c√≥digo morto (result √© SEMPRE objeto)
const rule = result.recordset?.[0] || 
  (Array.isArray(result) ? result[0] : undefined);
// Problema: Array.isArray({ recordset: [...] }) = FALSE sempre

// ‚úÖ CORRETO - Padr√£o do codebase AuraCore (PC-006)
const resultData = (result.recordset || result) as Array<Record<string, unknown>>;
const rule = resultData[0];
```

---

## ‚úÖ VALIDA√á√ïES PR√â-COMMIT OBRIGAT√ìRIAS

ANTES de commit, executar TODOS:

```bash
# 1. TypeScript - deve retornar 0 erros
npx tsc --noEmit

# 2. Testes - todos devem passar
npm test -- --run

# 3. Buscar any - deve retornar 0 resultados
grep -r 'as any' src/

# 4. Verificar status git
git status
```

### 5. Verificar Issues do Cursor (OBRIGAT√ìRIO)

```
Tool: check_cursor_issues
Args: {}
```

Se QUALQUER verifica√ß√£o falhar, corrigir antes de commit.

---

## üî¥ DEBUG ERROS 500 - CHECKLIST OBRIGAT√ìRIO (DEBUG-500-001 a DEBUG-500-005)

> **Li√ß√£o aprendida:** 80% dos erros 500 em m√≥dulos s√£o por SCHEMA N√ÉO EXPORTADO
> **Refer√™ncia:** Incidente HOTFIX-STRATEGIC-500 (21/01/2026, commit 6f3e2cdb)

| Regra | Verifica√ß√£o | Comando | Probabilidade |
|-------|-------------|---------|---------------|
| DEBUG-500-001 | Schema exportado? | `grep "modules/{modulo}" src/lib/db/schema.ts` | 80% |
| DEBUG-500-002 | DI registrado? | `grep "{Modulo}Module" src/shared/infrastructure/di/container.ts` | 10% |
| DEBUG-500-003 | Tabela existe? | `ls drizzle/migrations/*{modulo}*` | 5% |
| DEBUG-500-004 | Env correto? | `grep "DATABASE" .env.local` | 3% |
| DEBUG-500-005 | Bug na rota? | `cat src/app/api/{modulo}/route.ts` | 2% |

### Ordem Obrigat√≥ria de Debug

```
1. Schema exports    ‚Üê COME√áAR AQUI (causa mais comum)
2. DI registration
3. Database tables
4. Environment vars
5. Route handlers    ‚Üê NUNCA come√ßar aqui
```

### Script Completo de Diagn√≥stico (5 Passos)

```bash
#!/bin/bash
# Script de diagn√≥stico para erros 500
# Uso: ./debug-500.sh {modulo}
MODULE="${1:-strategic}"
echo "üîç === DIAGN√ìSTICO ERRO 500 - M√≥dulo: $MODULE ==="
echo ""

echo "=== 1. SCHEMA EXPORTS (80% dos casos) ==="
if grep -q "modules/$MODULE" src/lib/db/schema.ts 2>/dev/null; then
  echo "‚úÖ Schema exportado"
  grep -n "modules/$MODULE" src/lib/db/schema.ts
else
  echo "‚ùå PROBLEMA: Schema N√ÉO exportado!"
  echo "   Adicionar: export * from '@/modules/$MODULE/infrastructure/persistence/schemas';"
fi

echo ""
echo "=== 2. DI REGISTRATION (10% dos casos) ==="
if grep -iq "${MODULE}Module" src/shared/infrastructure/di/container.ts 2>/dev/null; then
  echo "‚úÖ M√≥dulo registrado no DI"
  grep -in "${MODULE}Module" src/shared/infrastructure/di/container.ts
else
  echo "‚ùå PROBLEMA: M√≥dulo N√ÉO registrado no DI!"
  echo "   Verificar: src/shared/infrastructure/di/container.ts"
fi

echo ""
echo "=== 3. DATABASE TABLES (5% dos casos) ==="
MIGRATIONS=$(ls drizzle/migrations/*$MODULE* 2>/dev/null | wc -l)
if [ "$MIGRATIONS" -gt 0 ]; then
  echo "‚úÖ Migrations encontradas: $MIGRATIONS arquivo(s)"
  ls drizzle/migrations/*$MODULE* 2>/dev/null | head -5
else
  echo "‚ö†Ô∏è Nenhuma migration espec√≠fica para '$MODULE'"
fi

echo ""
echo "=== 4. ENVIRONMENT VARIABLES (3% dos casos) ==="
if [ -f ".env.local" ]; then
  echo "üìã Vari√°veis de banco:"
  grep -E "DATABASE|MSSQL|DB_" .env.local 2>/dev/null | head -3 || echo "‚ö†Ô∏è Nenhuma vari√°vel encontrada"
else
  echo "‚ùå PROBLEMA: Arquivo .env.local n√£o encontrado!"
fi

echo ""
echo "=== 5. ROUTE HANDLERS (2% dos casos) ==="
ROUTE_PATH="src/app/api/$MODULE"
if [ -d "$ROUTE_PATH" ]; then
  ROUTE_COUNT=$(find "$ROUTE_PATH" -name "route.ts" 2>/dev/null | wc -l)
  echo "‚úÖ Pasta de rotas existe: $ROUTE_COUNT rotas"
  find "$ROUTE_PATH" -name "route.ts" 2>/dev/null | head -5
else
  echo "‚ùå PROBLEMA: Pasta de rotas n√£o existe: $ROUTE_PATH"
fi

echo ""
echo "üèÅ Diagn√≥stico conclu√≠do para m√≥dulo: $MODULE"
```

### Sintomas por Causa

| Sintoma | Causa Prov√°vel | Passo | A√ß√£o |
|---------|----------------|-------|------|
| **TODAS** as rotas do m√≥dulo retornam 500 | Schema n√£o exportado | 1 | Adicionar export em schema.ts |
| `db.query.{table}Table` √© `undefined` | Schema n√£o exportado | 1 | Adicionar export em schema.ts |
| "Dependency not found" | DI n√£o registrado | 2 | Registrar m√≥dulo em container.ts |
| Use Case n√£o instancia | DI n√£o registrado | 2 | Registrar m√≥dulo em container.ts |
| "Invalid object name" | Tabela n√£o existe | 3 | Rodar migrations |
| Query falha no Drizzle | Tabela n√£o existe | 3 | Verificar banco de dados |
| **"Connection refused" / "ECONNREFUSED"** | **Vari√°vel de ambiente incorreta** | **4** | **Verificar .env.local** |
| **"Connection timeout" / "ETIMEDOUT"** | **Banco inacess√≠vel ou env errado** | **4** | **Verificar DATABASE_URL** |
| **"Login failed" / "Authentication failed"** | **Credenciais incorretas** | **4** | **Corrigir credenciais no .env** |
| Erro em UMA rota espec√≠fica (n√£o todas) | Bug na implementa√ß√£o | 5 | Debug da rota |
| Stack trace aponta linha espec√≠fica | Bug no c√≥digo | 5 | Corrigir c√≥digo da rota |

**Contrato completo:** `docs/architecture/contracts/DEBUG_500_CONTRACT.md`

---

## üìã FLUXO DE TRABALHO OBRIGAT√ìRIO

### Implementa√ß√£o

1. Consultar contratos MCP (Tool: get_contract)
2. Buscar padr√µes (Tool: search_patterns)
3. Verificar com grep
4. Confirmar leitura
5. Implementar seguindo regras
6. Testar localmente

### Pr√©-Commit

```
Tool: check_cursor_issues
Args: {}
```

1. Se issues > 0: corrigir
2. Se issues = 0: fazer commit

### P√≥s-Commit

```
Tool: check_cursor_issues
Args: {}
```

1. Se issues > 0: corrigir + registrar corre√ß√£o + git commit --amend
2. Se issues = 0: reportar para aprova√ß√£o

### Registrar Corre√ß√£o (quando aplic√°vel)

```
Tool: register_correction
Args: {
  "epic": "[√©pico atual]",
  "error_description": "[descri√ß√£o clara do erro]",
  "correction_applied": "[como foi corrigido]",
  "files_affected": ["arquivo1.ts", "arquivo2.ts"]
}
```

### Push

1. NUNCA fazer push sem aprova√ß√£o expl√≠cita do usu√°rio
2. Aguardar mensagem "APROVADO - FAZER PUSH"
3. Verificar git status antes do push

---

## üõ°Ô∏è PREVEN√á√ÉO DE GAPS (PREVENT-001 a PREVENT-008)

| Regra | Descri√ß√£o |
|-------|-----------|
| PREVENT-001 | Todo novo m√≥dulo DEVE seguir template |
| PREVENT-002 | Todo Use Case em commands/ ou queries/ |
| PREVENT-003 | Todo service DEVE estar em um m√≥dulo |
| PREVENT-004 | C√≥digo em src/services/ √© PROIBIDO |
| PREVENT-005 | Domain NUNCA importa de fora |
| PREVENT-006 | branchId SEMPRE obrigat√≥rio |
| PREVENT-007 | Repository SEMPRE usa Mapper |
| PREVENT-008 | Entity SEMPRE tem create() e reconstitute() |

---

## ‚õî PROIBI√á√ïES ABSOLUTAS

- ‚ùå NUNCA usar `any` (nem em testes)
- ‚ùå NUNCA fazer push sem aprova√ß√£o
- ‚ùå NUNCA criar fun√ß√£o utilit√°ria sem us√°-la em todos os lugares
- ‚ùå NUNCA modificar m√°quina de estados global para caso espec√≠fico
- ‚ùå NUNCA validar string sem .trim()
- ‚ùå NUNCA acessar .value sem verificar Result.isFail()
- ‚ùå NUNCA deixar testes skipped
- ‚ùå NUNCA usar placeholders como 'TEMP' ou 'TODO' em c√≥digo de produ√ß√£o
- ‚ùå NUNCA fazer commits incrementais de corre√ß√£o (usar --amend)

---

## üìä REGRA DE IMPACTO CRUZADO

Antes de modificar m√©todo compartilhado (authorize, cancel, submit, etc):

1. Listar TODOS os document types que usam esse m√©todo
2. Verificar se a mudan√ßa afeta cada tipo diferentemente
3. Adicionar condicional por tipo se necess√°rio
4. Usar fun√ß√µes centralizadas ao inv√©s de hardcode

---

## üáßüá∑ CONTEXTO BRASIL (ERP Log√≠stico)

### Legisla√ß√£o Fiscal

- ICMS (Lei Complementar 87/96 - Lei Kandir)
- PIS/COFINS (Leis 10.637/02 e 10.833/03)
- SPED Fiscal, SPED Contribui√ß√µes, SPED ECD
- CTe (Conhecimento de Transporte Eletr√¥nico)
- NFe (Nota Fiscal Eletr√¥nica)
- MDFe (Manifesto de Documentos Fiscais)
- NFS-e (Nota Fiscal de Servi√ßos Eletr√¥nica)

### Reforma Tribut√°ria 2026

- IBS (Imposto sobre Bens e Servi√ßos)
- CBS (Contribui√ß√£o sobre Bens e Servi√ßos)
- IS (Imposto Seletivo)

### Reten√ß√µes na Fonte

- IRRF (1.5%)
- PIS (0.65%)
- COFINS (3%)
- CSLL (1%)
- ISS (2-5%)

---

## üîß STACK T√âCNICA

- **Backend:** Next.js 15 (App Router), TypeScript, Drizzle ORM, SQL Server 2022
- **Frontend:** React 19, Refine, AG Grid, Shadcn/UI
- **Testes:** Vitest
- **DI:** tsyringe
- **Deploy:** Coolify

---

## üìä FORMATO DE RELAT√ìRIO FINAL

Ao concluir implementa√ß√£o, reportar:

```markdown
## TAREFA CONCLU√çDA

### Verifica√ß√µes MCP
- check_cursor_issues (pr√©-commit): ‚úÖ/‚ùå
- check_cursor_issues (p√≥s-commit): ‚úÖ/‚ùå

### Verifica√ß√µes C√≥digo
- npx tsc --noEmit: ‚úÖ 0 erros
- npm test -- --run: ‚úÖ X/X passando
- grep 'as any': ‚úÖ 0 resultados

### Commits
- Hash: [hash]
- Mensagem: [mensagem]

### Push
- Status: ‚úÖ Realizado / ‚è≥ Pendente

### Corre√ß√µes Registradas
- [LC-XXXXX]: [descri√ß√£o] (se houver)
```

---

## üìÅ ARQUIVOS CR√çTICOS (CUIDADO EXTRA)

Modifica√ß√µes nesses arquivos exigem testes extras e revis√£o cuidadosa:

1. `accounting-engine.ts` - Contabiliza√ß√£o
2. `financial-title-generator.ts` - T√≠tulos financeiros
3. `sped-fiscal-generator.ts` - SPED (multa R$ 5.000+)
4. `sped-ecd-generator.ts` - SPED Cont√°bil
5. `sped-contributions-generator.ts` - SPED PIS/COFINS
6. `FiscalDocument.ts` - Documento fiscal base
7. `DocumentType.ts` - M√°quina de estados

---

## üìù TEMPLATES DE C√ìDIGO

### Template: Entity

```typescript
// src/modules/{module}/domain/entities/{Entity}.ts
import { AggregateRoot, Result } from '@/shared/domain';

interface {Entity}Props {
  organizationId: number;
  branchId: number;
  // campos de neg√≥cio
  createdAt: Date;
  updatedAt: Date;
}

export class {Entity} extends AggregateRoot<string> {
  private constructor(id: string, private readonly props: {Entity}Props) {
    super(id);
  }

  // Getters
  get organizationId(): number { return this.props.organizationId; }
  get branchId(): number { return this.props.branchId; }

  // Factory: create() COM valida√ß√µes
  static create(props: Create{Entity}Props): Result<{Entity}, string> {
    if (!props.organizationId) return Result.fail('organizationId obrigat√≥rio');
    if (!props.branchId) return Result.fail('branchId obrigat√≥rio');
    
    const id = globalThis.crypto.randomUUID();
    const now = new Date();
    
    return Result.ok(new {Entity}(id, { ...props, createdAt: now, updatedAt: now }));
  }

  // Factory: reconstitute() SEM valida√ß√µes (para Mapper)
  static reconstitute(props: {Entity}Props & { id: string }): Result<{Entity}, string> {
    return Result.ok(new {Entity}(props.id, props));
  }

  // M√©todos de neg√≥cio
  approve(approvedBy: string): Result<void, string> {
    // l√≥gica de neg√≥cio
    this.addDomainEvent(new {Entity}ApprovedEvent(this.id, approvedBy));
    return Result.ok(undefined);
  }
}
```

### Template: Value Object

```typescript
// src/modules/{module}/domain/value-objects/{VO}.ts
import { ValueObject, Result } from '@/shared/domain';

interface {VO}Props extends Record<string, unknown> {
  value: string;
}

export class {VO} extends ValueObject<{VO}Props> {
  private constructor(props: {VO}Props) {
    super(props); // Object.freeze aplicado
  }

  get value(): string { return this.props.value; }

  static create(value: string): Result<{VO}, string> {
    const trimmed = value.trim();
    if (!trimmed) return Result.fail('{VO} n√£o pode ser vazio');
    return Result.ok(new {VO}({ value: trimmed }));
  }
}
```

### Template: Repository Interface

```typescript
// src/modules/{module}/domain/ports/output/I{Entity}Repository.ts
import type { {Entity} } from '../../entities/{Entity}';

export interface I{Entity}Repository {
  findById(id: string, organizationId: number, branchId: number): Promise<{Entity} | null>;
  findMany(filter: {Entity}Filter): Promise<{ items: {Entity}[]; total: number }>;
  save(entity: {Entity}): Promise<void>;
  delete(id: string, organizationId: number, branchId: number): Promise<void>;
}

export interface {Entity}Filter {
  organizationId: number;
  branchId: number; // NUNCA opcional
  status?: string;
  page?: number;
  pageSize?: number;
}
```

### Template: Mapper

```typescript
// src/modules/{module}/infrastructure/persistence/mappers/{Entity}Mapper.ts
import { Result } from '@/shared/domain';
import { {Entity} } from '../../../domain/entities/{Entity}';
import type { {Entity}Row, {Entity}Insert } from '../schemas/{entity}.schema';

export class {Entity}Mapper {
  // DB ‚Üí Domain (usa reconstitute, NUNCA create)
  static toDomain(row: {Entity}Row): Result<{Entity}, string> {
    return {Entity}.reconstitute({
      id: row.id,
      organizationId: row.organizationId,
      branchId: row.branchId,
      // ... campos
      createdAt: row.createdAt,
      updatedAt: row.updatedAt,
    });
  }

  // Domain ‚Üí DB
  static toPersistence(entity: {Entity}): {Entity}Insert {
    return {
      id: entity.id,
      organizationId: entity.organizationId,
      branchId: entity.branchId,
      // ... campos
      createdAt: entity.createdAt,
      updatedAt: entity.updatedAt,
    };
  }
}
```

### Template: Schema

```typescript
// src/modules/{module}/infrastructure/persistence/schemas/{entity}.schema.ts
import { int, varchar, decimal, datetime2, index } from 'drizzle-orm/mssql-core';
import { mssqlTable } from '@/shared/infrastructure/database/table-creator';

export const {entity}Table = mssqlTable(
  '{entity_snake_case}',
  {
    id: varchar('id', { length: 36 }).primaryKey(),
    organizationId: int('organization_id').notNull(),
    branchId: int('branch_id').notNull(),
    
    // Money = 2 colunas
    amount: decimal('amount', { precision: 18, scale: 2 }).notNull(),
    amountCurrency: varchar('amount_currency', { length: 3 }).notNull().default('BRL'),
    
    // Auditoria
    createdAt: datetime2('created_at').notNull().defaultNow(),
    updatedAt: datetime2('updated_at').notNull().defaultNow(),
    deletedAt: datetime2('deleted_at'), // Soft delete
  },
  (table) => ({
    // √çndice COMPOSTO obrigat√≥rio
    tenantIdx: index('idx_{entity}_tenant').on(table.organizationId, table.branchId),
  })
);

export type {Entity}Row = typeof {entity}Table.$inferSelect;
export type {Entity}Insert = typeof {entity}Table.$inferInsert;
```

---

## üáßüá∑ CONTEXTO BRASIL - ERP LOG√çSTICO (EXPANDIDO)

### Legisla√ß√£o Fiscal Detalhada
- **ICMS:** Lei Complementar 87/96 (Lei Kandir) - Imposto estadual sobre circula√ß√£o de mercadorias
- **PIS/COFINS:** Leis 10.637/02 e 10.833/03 - Contribui√ß√µes federais sobre faturamento
- **SPED:** Sistema P√∫blico de Escritura√ß√£o Digital
  - SPED Fiscal (EFD-ICMS/IPI)
  - SPED Contribui√ß√µes (EFD-Contribui√ß√µes PIS/COFINS)
  - SPED ECD (Escritura√ß√£o Cont√°bil Digital)
- **Documentos Eletr√¥nicos:**
  - NFe (Nota Fiscal Eletr√¥nica) - Modelo 55
  - CTe (Conhecimento de Transporte Eletr√¥nico) - Modelo 57
  - MDFe (Manifesto de Documentos Fiscais Eletr√¥nicos)
  - NFS-e (Nota Fiscal de Servi√ßos Eletr√¥nica)

### Reforma Tribut√°ria 2026 (CR√çTICO)
- **IBS:** Imposto sobre Bens e Servi√ßos (estadual+municipal, substitui ICMS+ISS)
- **CBS:** Contribui√ß√£o sobre Bens e Servi√ßos (federal, substitui PIS/COFINS)
- **IS:** Imposto Seletivo (produtos espec√≠ficos: cigarros, bebidas, etc)

### Reten√ß√µes na Fonte (Lei 10.833/03)
| Tributo | Al√≠quota | Base Legal |
|---------|----------|------------|
| IRRF | 1.5% | Art. 64 Lei 9.430/96 |
| PIS | 0.65% | Art. 30 Lei 10.833/03 |
| COFINS | 3.0% | Art. 30 Lei 10.833/03 |
| CSLL | 1.0% | Art. 30 Lei 10.833/03 |
| ISS | 2-5% | LC 116/03 |

### Arquivos Cr√≠ticos (Multas SEFAZ/RFB)
| Arquivo | M√≥dulo | Risco | Multa M√≠nima | Base Legal |
|---------|--------|-------|--------------|------------|
| sped-fiscal-generator.ts | Fiscal | SPED Fiscal | R$ 5.000/m√™s | Art. 12 Lei 8.218/91 |
| sped-ecd-generator.ts | Accounting | SPED ECD | R$ 5.000/m√™s | Art. 12 Lei 8.218/91 |
| sped-contributions-generator.ts | Fiscal | EFD-Contribui√ß√µes | R$ 5.000/m√™s | Art. 12 Lei 8.218/91 |
| FiscalDocument.ts | Fiscal | NFe/CTe inv√°lida | R$ 5.000/doc | Art. 57 Lei 8.383/91 |
| TaxCalculator.ts | Fiscal | C√°lculo incorreto | Cr√©dito tribut√°rio | Vari√°vel |
| accounting-engine.ts | Accounting | Contabiliza√ß√£o | Auditoria | IN RFB 1.700/17 |
| financial-title-generator.ts | Financial | T√≠tulos duplicados | R$ 10.000+ | Art. 172 CTN |

---

## üìö REFER√äNCIAS BIBLIOGR√ÅFICAS

### Arquitetura de Software
1. **Evans, E.** (2003). *Domain-Driven Design: Tackling Complexity in the Heart of Software*. Addison-Wesley Professional. ISBN: 978-0321125217.
2. **Vernon, V.** (2013). *Implementing Domain-Driven Design*. Addison-Wesley Professional. ISBN: 978-0321834577.
3. **Cockburn, A.** (2005). *Hexagonal Architecture (Ports and Adapters)*. Dispon√≠vel em: alistair.cockburn.us/hexagonal-architecture/.
4. **Martin, R. C.** (2017). *Clean Architecture: A Craftsman's Guide to Software Structure and Design*. Prentice Hall. ISBN: 978-0134494166.
5. **Fowler, M.** (2002). *Patterns of Enterprise Application Architecture*. Addison-Wesley Professional. ISBN: 978-0321127426.

### Legisla√ß√£o Brasileira
6. **Brasil.** Lei Complementar n¬∫ 87, de 13 de setembro de 1996. Lei Kandir (ICMS).
7. **Brasil.** Lei n¬∫ 10.637, de 30 de dezembro de 2002. PIS n√£o-cumulativo.
8. **Brasil.** Lei n¬∫ 10.833, de 29 de dezembro de 2003. COFINS n√£o-cumulativo.
9. **Brasil.** Instru√ß√£o Normativa RFB n¬∫ 1.774, de 22 de dezembro de 2017. SPED.
10. **Brasil.** Emenda Constitucional n¬∫ 132, de 20 de dezembro de 2023. Reforma Tribut√°ria.

---

## üìä FORMATO DE RELAT√ìRIO FINAL (OBRIGAT√ìRIO)

Ap√≥s cada tarefa, o agente DEVE produzir:

```markdown
## TAREFA CONCLU√çDA

### Verifica√ß√µes MCP
- check_cursor_issues (pr√©-commit): ‚úÖ 0 issues / ‚ùå X issues
- check_cursor_issues (p√≥s-commit): ‚úÖ 0 issues / ‚ùå X issues

### Verifica√ß√µes C√≥digo
- npx tsc --noEmit: ‚úÖ 0 erros
- npm test -- --run: ‚úÖ X/X passando
- grep 'as any': ‚úÖ 0 resultados

### Padr√µes Aplicados
- [ ] ARCH: Depend√™ncias inward (Cockburn, 2005)
- [ ] ENTITY: create() + reconstitute() (Evans, 2003)
- [ ] REPO: Mapper com toDomain/toPersistence (Vernon, 2013)
- [ ] SCHEMA: √çndice composto multi-tenancy

### Commits
- Hash: [hash]
- Mensagem: [mensagem]

### Corre√ß√µes Registradas
- [LC-XXXXX]: [descri√ß√£o] (se houver)

### Push
- Status: ‚è≥ Aguardando aprova√ß√£o / ‚úÖ Realizado
```

---

## üîÑ SMP - SYSTEMATIC MIGRATION PROTOCOL

### Vis√£o Geral

O SMP √© a metodologia padr√£o do AuraCore para refatora√ß√µes em larga escala. DEVE ser seguido em TODA refatora√ß√£o que afeta mais de 10 arquivos.

### Documenta√ß√£o Completa

| Documento | Localiza√ß√£o | Prop√≥sito |
|-----------|-------------|-----------|
| Metodologia | `docs/mcp/SMP_METHODOLOGY.md` | Fases e processos |
| Li√ß√µes Aprendidas | `docs/mcp/SMP_LESSONS_LEARNED.md` | Registro de bugs |
| Cat√°logo de Padr√µes | `docs/mcp/SMP_PATTERNS_CATALOG.md` | C√≥digo correto |
| Anti-Patterns | `docs/mcp/SMP_ANTI_PATTERNS.md` | O que N√ÉO fazer |

### Contratos MCP

```
Tool: get_contract
Args: { "contract_id": "smp-methodology" }

Tool: get_contract
Args: { "contract_id": "lesson-learned" }
```

### Fases Obrigat√≥rias

| Fase | Nome | Descri√ß√£o | Obrigat√≥rio |
|------|------|-----------|-------------|
| 1 | SMP-INFRA | Criar helpers centralizados | Se padr√£o repete 3+ vezes |
| 2 | SMP-MAP | Mapear 100% do escopo | SEMPRE |
| 3 | SMP-CAT | Categorizar por tipo de corre√ß√£o | SEMPRE |
| 4 | SMP-APPROVE | Aguardar aprova√ß√£o do plano | SEMPRE |
| 5 | SMP-EXEC | Executar por categoria | SEMPRE |
| 6 | SMP-VERIFY | Verificar 0 ocorr√™ncias restantes | SEMPRE |

### Regras SMP

| Regra | Descri√ß√£o | Severidade |
|-------|-----------|------------|
| SMP-INFRA-001 | Criar helper se padr√£o repete em 3+ arquivos | ALTA |
| SMP-MAP-001 | Executar grep ANTES de qualquer corre√ß√£o | ALTA |
| SMP-MAP-002 | Relat√≥rio formal se > 10 ocorr√™ncias | M√âDIA |
| SMP-MAP-003 | Ao corrigir padr√£o, grep TODO o codebase | ALTA |
| SMP-MAP-004 | Mapeamento √© primeiro passo obrigat√≥rio | CR√çTICA |
| SMP-CAT-001 | Agrupar por tipo de corre√ß√£o, n√£o por arquivo | ALTA |
| SMP-APPROVE-001 | NUNCA corrigir sem aprova√ß√£o expl√≠cita | CR√çTICA |
| SMP-EXEC-001 | Commit por categoria, n√£o por arquivo | M√âDIA |
| SMP-EXEC-002 | Migra√ß√£o incompleta = registrar e corrigir | ALTA |
| SMP-EXEC-003 | Consultar SMP_ANTI_PATTERNS.md ANTES de corrigir | CR√çTICA |
| SMP-VERIFY-001 | grep final DEVE retornar 0 | ALTA |
| SMP-VERIFY-002 | Criar interfaces espec√≠ficas, n√£o Record | ALTA |

### Consulta Obrigat√≥ria Pr√©-Corre√ß√£o (SMP-EXEC-003)

**ANTES de corrigir QUALQUER padr√£o, o Agent DEVE:**

1. **Consultar Anti-Patterns:**
   ```bash
   cat docs/mcp/SMP_ANTI_PATTERNS.md | grep -A20 "[padr√£o]"
   ```

2. **Consultar Padr√µes Corretos:**
   ```bash
   cat docs/mcp/SMP_PATTERNS_CATALOG.md | grep -A20 "[padr√£o]"
   ```

3. **Usar APENAS padr√µes catalogados** - NUNCA inventar novo padr√£o

4. **Se padr√£o n√£o existe no cat√°logo:**
   - PARAR
   - Documentar novo padr√£o
   - Solicitar aprova√ß√£o
   - S√≥ ent√£o aplicar

**Viola√ß√£o desta regra √© considerada falha cr√≠tica.**

### Fluxo de Retroalimenta√ß√£o (Learning Loop)

Quando encontrar bug durante refatora√ß√£o:

```
1. PARAR corre√ß√£o atual
2. DOCUMENTAR: O que falhou, onde, c√≥digo atual
3. ANALISAR: Causa raiz, categoria SMP, impacto
4. CLASSIFICAR: Nova regra? Atualiza√ß√£o? Anti-pattern?
5. ATUALIZAR: regrasmcp.mdc e/ou contratos MCP
6. REGISTRAR: SMP_LESSONS_LEARNED.md
7. CONTINUAR: Aplicando nova regra
```

### Comandos de Mapeamento Padr√£o

```bash
# Total de ocorr√™ncias
grep -rn "padr√£o" src/ --include="*.ts" | wc -l

# Arquivos afetados
grep -rn "padr√£o" src/ --include="*.ts" | cut -d: -f1 | sort -u

# Distribui√ß√£o por diret√≥rio
grep -rn "padr√£o" src/ --include="*.ts" | cut -d: -f1 | sort | uniq -c | sort -rn
```

---

**FIM DAS REGRAS v3.0 - CONSULTAR MCP E CONFIRMAR LEITURA ANTES DE COME√áAR**
