# E7.11 - Infraestrutura de Testes

## ğŸ¯ Objetivo

Implementar infraestrutura completa para testes de integraÃ§Ã£o e E2E, resolvendo os **56 testes skipped**.

---

## ğŸ“¦ Componentes

### 1. Docker Compose

**Arquivo:** `docker-compose.test.yml`

**ServiÃ§os:**
- `sqlserver-test`: SQL Server 2022 na porta 1434
- `migrations`: Executar migrations automaticamente

**Uso:**
```bash
# Iniciar SQL Server de teste
npm run docker:test:up

# Ver logs
npm run docker:test:logs

# Parar e limpar
npm run docker:test:down

# Reiniciar (limpar + iniciar)
npm run docker:test:restart
```

### 2. Arquivo .env.test

**Criar:** `.env.test` (nÃ£o versionado)

```bash
# Test Database (Docker SQL Server)
TEST_DATABASE_URL="sqlserver://sa:TestPassword123!@localhost:1434/auracore_test;trustServerCertificate=true"

# Disable external integrations in tests
USE_MOCK_SEFAZ=true
USE_MOCK_BANKING=true
USE_MOCK_INTEGRATIONS=true
USE_MOCK_NOTIFICATION=true
USE_MOCK_OFX=true

# Test environment
NODE_ENV=test

# Auth (mock values for tests)
AUTH_SECRET="test-secret-for-e2e-tests-only"
NEXTAUTH_URL="http://localhost:3000"

# Disable telemetry
NEXT_TELEMETRY_DISABLED=1
```

### 3. testClient Real

**Arquivo:** `tests/helpers/test-client.ts`

**Antes (stub):**
```typescript
// Retornava sempre { data: {} }
export const testClient = { /* stub */ };
```

**Depois (real):**
```typescript
// Executa Next.js real com supertest
import { testClient } from '@/tests/helpers/test-client';

const response = await testClient.get('/api/fiscal/tax-reform/calculate-ibs-cbs');
expect(response.status).toBe(200);
expect(response.body.data).toBeDefined();
```

### 4. Integration DB Helper

**Arquivo:** `tests/helpers/integration-db.ts`

**ConfiguraÃ§Ã£o atualizada:**
- Porta: `1434` (docker-compose.test.yml)
- Database: `auracore_test`
- Password: `TestPassword123!`

**Uso:**
```typescript
import { createIntegrationContext } from '@/tests/helpers/integration-db';

beforeAll(async () => {
  ctx = await createIntegrationContext();
});

afterAll(async () => {
  await ctx.cleanup();
});
```

---

## ğŸ“‹ Scripts npm

| Script | DescriÃ§Ã£o |
|--------|-----------|
| `docker:test:up` | Inicia SQL Server de teste |
| `docker:test:down` | Para e limpa SQL Server |
| `docker:test:logs` | Ver logs do container |
| `docker:test:restart` | Reinicia SQL Server |
| `db:migrate:test` | Executa migrations no DB de teste |
| `test:integration:docker` | Roda testes de integraÃ§Ã£o com Docker |
| `test:all` | Roda unit + integration (com Docker) |

---

## ğŸš€ Fluxo de Uso

### Setup Inicial

```bash
# 1. Criar .env.test (copiar conteÃºdo acima)
touch .env.test

# 2. Instalar dependÃªncias (jÃ¡ feito no E7.11)
npm install -D supertest @types/supertest

# 3. Iniciar SQL Server de teste
npm run docker:test:up

# 4. Aguardar healthcheck (10-15s)
npm run docker:test:logs

# Quando ver "SQL Server is now ready for client connections", estÃ¡ pronto
```

### Executar Testes

```bash
# Unit tests (sem infraestrutura)
npm run test:unit

# Integration tests (WMS - SQL Server)
npm run test:integration

# E2E tests (Fiscal - Next.js + supertest)
npm run test:e2e

# Todos (unit + integration com Docker automÃ¡tico)
npm run test:all
```

### Troubleshooting

**Erro: "Cannot connect to SQL Server"**
```bash
# Verificar se container estÃ¡ rodando
docker ps | grep sqlserver-test

# Ver logs de erro
npm run docker:test:logs

# Reiniciar
npm run docker:test:restart
```

**Erro: "Port 1434 already in use"**
```bash
# Parar containers existentes
npm run docker:test:down

# Ou matar processo na porta
lsof -ti:1434 | xargs kill -9
```

**Testes lentos?**
- SQL Server leva ~10s para ficar pronto
- Primeira conexÃ£o cria tabelas (migrations)
- Testes subsequentes sÃ£o mais rÃ¡pidos

---

## ğŸ“Š Status dos Testes

### Antes (E7.10)

| Categoria | Passando | Skipped | Total |
|-----------|----------|---------|-------|
| Unit | 832 | 0 | 832 |
| Integration WMS | 0 | ~24 | ~24 |
| E2E Fiscal | 0 | ~33 | ~33 |
| **Total** | **832** | **57** | **889** |

### Depois (E7.11 - Meta)

| Categoria | Passando | Skipped | Total |
|-----------|----------|---------|-------|
| Unit | 832 | 0 | 832 |
| Integration WMS | ~24 | 0 | ~24 |
| E2E Fiscal | ~33 | 0 | ~33 |
| **Total** | **~889** | **0** | **889** |

---

## ğŸ” Arquivos Modificados

| Arquivo | Status | DescriÃ§Ã£o |
|---------|--------|-----------|
| `docker-compose.test.yml` | âœ… Novo | SQL Server + migrations |
| `.env.test` | âš ï¸ Manual | ConfiguraÃ§Ã£o de teste (nÃ£o versionado) |
| `package.json` | âœ… Modificado | Scripts docker + test:all |
| `tests/helpers/test-client.ts` | âœ… Novo | testClient real com supertest |
| `tests/helpers/integration-db.ts` | âœ… Modificado | Config porta 1434 |
| `.gitignore` | âœ… Modificado | Ignora .env.test |

---

## ğŸ¯ PrÃ³ximos Passos (Semana 2)

1. **Re-habilitar Testes WMS** (5 arquivos)
   - Remover `describe.skip`
   - Validar com SQL Server de teste

2. **Re-habilitar Testes E2E Fiscal** (6 arquivos)
   - Remover `describe.skip`
   - Usar testClient real
   - Remover non-null assertions (`!`)

3. **ValidaÃ§Ã£o Final**
   - `npm run test:all` â†’ ~889 passando
   - 0 testes skipped
   - Coverage > 98%

---

## ğŸ“ Notas

- **Docker obrigatÃ³rio**: Testes de integraÃ§Ã£o requerem Docker instalado
- **Porta 1434**: NÃ£o conflita com instÃ¢ncia de desenvolvimento (1433)
- **Isolamento**: Cada teste limpa seus dados apÃ³s execuÃ§Ã£o
- **CI/CD**: GitHub Actions suporta docker-compose (futuro)

---

**DocumentaÃ§Ã£o criada:** 04/01/2026  
**Ã‰pico:** E7.11 - Infraestrutura de Testes  
**Status:** Semana 1 Completa âœ…

