# E8.1 - Audit de √çndices SQL Server

**Data:** 18/01/2026 (Atualizado: 19/01/2026)  
**√âpico:** E8.1 - Performance & Observability  
**Status:** ‚úÖ MIGRATIONS CRIADAS - Pendente execu√ß√£o no SQL Server

---

## üìä RESUMO EXECUTIVO

| M√©trica | Valor |
|---------|-------|
| **Total de Tabelas** | 91 |
| **Tabelas com organizationId** | 65 |
| **Tabelas com branchId** | 24 |
| **√çndices √∫nicos existentes** | 19 |
| **√çndices tenant (org+branch)** | **35+** ‚úÖ (migrations criadas) |

### Migrations de √çndices

| Migration | Status | Descri√ß√£o |
|-----------|--------|-----------|
| `0034_add_tenant_indexes.sql` | ‚úÖ Criada | 23 tenant + 9 org + 3 status |
| `0035_strategic_module.sql` | ‚úÖ Criada | 10 √≠ndices strategic_* |
| `0036_fix_tenant_indexes.sql` | ‚úÖ Criada | Corre√ß√µes de √≠ndices |
| `0037_add_branch_id_to_tables.sql` | ‚úÖ Criada | branch_id + 9 √≠ndices |

---

## ‚úÖ PROBLEMA RESOLVIDO (Migrations Criadas)

**Migrations criadas para adicionar √≠ndices compostos (organizationId, branchId).**

‚ö†Ô∏è **PENDENTE:** Executar migrations no SQL Server (Coolify)

**Para executar:**
```bash
sqlcmd -S localhost -U sa -P [password] -d AuraCore -i drizzle/migrations/0034_add_tenant_indexes.sql
```

---

## üìã TABELAS QUE PRECISAM DE √çNDICE TENANT

### Prioridade CR√çTICA (organizationId + branchId presentes)

| Tabela | Campos | √çndice Necess√°rio |
|--------|--------|-------------------|
| `accounts_payable` | organizationId, branchId | `idx_accounts_payable_tenant` |
| `accounts_receivable` | organizationId, branchId | `idx_accounts_receivable_tenant` |
| `bank_accounts` | organizationId, branchId | `idx_bank_accounts_tenant` |
| `inbound_invoices` | organizationId, branchId | `idx_inbound_invoices_tenant` |
| `trips` | organizationId, branchId | `idx_trips_tenant` |
| `trip_stops` | organizationId, branchId | `idx_trip_stops_tenant` |
| `trip_documents` | organizationId, branchId | `idx_trip_documents_tenant` |
| `trip_checkpoints` | organizationId, branchId | `idx_trip_checkpoints_tenant` |
| `trip_occurrences` | organizationId, branchId | `idx_trip_occurrences_tenant` |
| `cargo_documents` | organizationId, branchId | `idx_cargo_documents_tenant` |
| `cte_header` | organizationId, branchId | `idx_cte_header_tenant` |
| `mdfe_header` | organizationId, branchId | `idx_mdfe_header_tenant` |
| `pickup_orders` | organizationId, branchId | `idx_pickup_orders_tenant` |
| `billing_invoices` | organizationId, branchId | `idx_billing_invoices_tenant` |
| `fuel_transactions` | organizationId, branchId | `idx_fuel_transactions_tenant` |
| `bank_transactions` | organizationId, branchId | `idx_bank_transactions_tenant` |
| `maintenance_work_orders` | organizationId, branchId | `idx_maintenance_work_orders_tenant` |
| `warehouse_movements` | organizationId, branchId | `idx_warehouse_movements_tenant` |
| `warehouse_inventory_counts` | organizationId, branchId | `idx_warehouse_inventory_counts_tenant` |
| `inventory_adjustments` | organizationId, branchId | `idx_inventory_adjustments_tenant` |
| `lancamentos_contabeis` | organizationId, branchId | `idx_lancamentos_contabeis_tenant` |
| `frota_abastecimentos` | organizationId, branchId | `idx_frota_abastecimentos_tenant` |
| `fiscal_settings` | organizationId, branchId | `idx_fiscal_settings_tenant` |

### Prioridade ALTA (apenas organizationId, mas volume alto)

| Tabela | √çndice Necess√°rio |
|--------|-------------------|
| `business_partners` | `idx_business_partners_org` |
| `products` | `idx_products_org` |
| `financial_categories` | `idx_financial_categories_org` |
| `audit_logs` | `idx_audit_logs_org` |
| `drivers` | `idx_drivers_org` |
| `vehicles` | `idx_vehicles_org` |
| `cost_centers` | `idx_cost_centers_org` |
| `chart_of_accounts` | `idx_chart_of_accounts_org` |
| `tax_matrix` | `idx_tax_matrix_org` |
| `freight_tables` | `idx_freight_tables_org` |

---

## üìú MIGRATION RECOMENDADA

```sql
-- Migration: 0034_add_tenant_indexes.sql
-- Data: 2026-01-18
-- √âpico: E8.1 - Performance

-- === √çNDICES TENANT (organizationId, branchId) ===

-- Financeiro
CREATE NONCLUSTERED INDEX [idx_accounts_payable_tenant] 
  ON [accounts_payable] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_accounts_receivable_tenant] 
  ON [accounts_receivable] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_bank_accounts_tenant] 
  ON [bank_accounts] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_bank_transactions_tenant] 
  ON [bank_transactions] ([organization_id], [branch_id]);

-- TMS
CREATE NONCLUSTERED INDEX [idx_trips_tenant] 
  ON [trips] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_trip_stops_tenant] 
  ON [trip_stops] ([organization_id], [branch_id]);

CREATE NONCLUSTERED INDEX [idx_trip_documents_tenant] 
  ON [trip_documents] ([organization_id], [branch_id]);

CREATE NONCLUSTERED INDEX [idx_cargo_documents_tenant] 
  ON [cargo_documents] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_cte_header_tenant] 
  ON [cte_header] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_mdfe_header_tenant] 
  ON [mdfe_header] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_pickup_orders_tenant] 
  ON [pickup_orders] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_billing_invoices_tenant] 
  ON [billing_invoices] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

-- Frota
CREATE NONCLUSTERED INDEX [idx_fuel_transactions_tenant] 
  ON [fuel_transactions] ([organization_id], [branch_id]);

CREATE NONCLUSTERED INDEX [idx_maintenance_work_orders_tenant] 
  ON [maintenance_work_orders] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_frota_abastecimentos_tenant] 
  ON [frota_abastecimentos] ([organization_id], [branch_id]);

-- WMS
CREATE NONCLUSTERED INDEX [idx_warehouse_movements_tenant] 
  ON [warehouse_movements] ([organization_id], [branch_id]);

CREATE NONCLUSTERED INDEX [idx_warehouse_inventory_counts_tenant] 
  ON [warehouse_inventory_counts] ([organization_id], [branch_id]);

CREATE NONCLUSTERED INDEX [idx_inventory_adjustments_tenant] 
  ON [inventory_adjustments] ([organization_id], [branch_id]);

-- Contabilidade
CREATE NONCLUSTERED INDEX [idx_lancamentos_contabeis_tenant] 
  ON [lancamentos_contabeis] ([organization_id], [branch_id]);

-- Fiscal
CREATE NONCLUSTERED INDEX [idx_fiscal_settings_tenant] 
  ON [fiscal_settings] ([organization_id], [branch_id]);

CREATE NONCLUSTERED INDEX [idx_inbound_invoices_tenant] 
  ON [inbound_invoices] ([organization_id], [branch_id]) 
  WHERE [deleted_at] IS NULL;

-- === √çNDICES SIMPLES (organizationId) ===

CREATE NONCLUSTERED INDEX [idx_business_partners_org] 
  ON [business_partners] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_products_org] 
  ON [products] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_financial_categories_org] 
  ON [financial_categories] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_audit_logs_org] 
  ON [audit_logs] ([organization_id]);

CREATE NONCLUSTERED INDEX [idx_drivers_org] 
  ON [drivers] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_vehicles_org] 
  ON [vehicles] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_cost_centers_org] 
  ON [cost_centers] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_chart_of_accounts_org] 
  ON [chart_of_accounts] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_freight_tables_org] 
  ON [freight_tables] ([organization_id]) 
  WHERE [deleted_at] IS NULL;

-- === √çNDICES ADICIONAIS (filtros frequentes) ===

-- Por status (queries frequentes)
CREATE NONCLUSTERED INDEX [idx_accounts_payable_status] 
  ON [accounts_payable] ([status], [due_date]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_trips_status] 
  ON [trips] ([status], [created_at]) 
  WHERE [deleted_at] IS NULL;

CREATE NONCLUSTERED INDEX [idx_cte_header_status] 
  ON [cte_header] ([status], [issue_date]) 
  WHERE [deleted_at] IS NULL;
```

---

## ‚ö†Ô∏è NOTAS IMPORTANTES

1. **√çndices Filtered (WHERE deleted_at IS NULL)**: 
   - SQL Server suporta √≠ndices filtrados
   - Reduz tamanho do √≠ndice excluindo registros soft-deleted

2. **Ordem das Colunas**: 
   - `(organizationId, branchId)` √© a ordem correta
   - Primeiro o campo mais seletivo (org), depois branch

3. **Impacto de Cria√ß√£o**:
   - Pode bloquear tabelas durante cria√ß√£o
   - Executar em hor√°rio de baixo uso ou usar ONLINE = ON

4. **Monitoramento P√≥s-Cria√ß√£o**:
   - Usar Query Store para verificar melhoria
   - Monitorar sys.dm_db_index_usage_stats

---

## üìà ESTIMATIVA DE MELHORIA

| Opera√ß√£o | Antes | Depois (estimado) |
|----------|-------|-------------------|
| findMany com tenant filter | ~500ms | ~10ms |
| Count por organiza√ß√£o | ~300ms | ~5ms |
| Dashboard financeiro | ~2s | ~200ms |

---

## üîó REFER√äNCIAS

- [SQL Server Index Design Guide](https://docs.microsoft.com/sql/relational-databases/sql-server-index-design-guide)
- [Multi-Tenant Indexing Patterns](https://docs.microsoft.com/azure/architecture/guide/multitenant/service/sql-database)
