# E8.2 + E8.3 - Guia de Execu√ß√£o

**Data:** 18/01/2026  
**√âpico:** E8.2 + E8.3 - Performance Implementation  
**Status:** üìã Pronto para Execu√ß√£o

---

## üìä RESUMO

| Item | Arquivo | Status |
|------|---------|--------|
| **Migration √çndices** | `drizzle/migrations/0034_add_tenant_indexes.sql` | ‚úÖ Pronto |
| **Query Store** | `scripts/sql/enable-query-store.sql` | ‚úÖ Pronto |
| **Audit** | `docs/performance/E8.1_INDEX_AUDIT.md` | ‚úÖ Documentado |

---

## üîß E8.2: EXECU√á√ÉO DA MIGRATION

### Estat√≠sticas da Migration

| Tipo | Quantidade | Descri√ß√£o |
|------|------------|-----------|
| **√çndices Tenant** | 23 | `(organization_id, branch_id)` |
| **√çndices Org** | 9 | `(organization_id)` apenas |
| **√çndices Status** | 3 | Filtros frequentes |
| **Total** | 35 | - |

### √çndices com INCLUDE (Covering Indexes)

Tabelas cr√≠ticas receberam INCLUDE columns para evitar Key Lookups:

| Tabela | INCLUDE Columns |
|--------|-----------------|
| `accounts_payable` | status, due_date, amount, partner_id |
| `accounts_receivable` | status, due_date, amount, customer_id |
| `trips` | status, driver_id, vehicle_id, created_at |
| `cte_header` | status, issue_date, access_key, number |
| `billing_invoices` | status, issue_date, total_amount, customer_id |
| `cargo_documents` | status, document_type, trip_id |

### Op√ß√£o A: Executar via SSMS

```sql
-- 1. Conectar ao banco de dados
-- 2. Abrir arquivo: drizzle/migrations/0034_add_tenant_indexes.sql
-- 3. Executar (F5)
-- 4. Verificar resultado no final do script
```

### Op√ß√£o B: Executar via Script Node.js

```bash
# Criar script de execu√ß√£o
node -e "
const fs = require('fs');
const sql = require('mssql');

async function run() {
  const config = {
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    server: process.env.DB_HOST,
    database: process.env.DB_NAME,
    options: { encrypt: false, trustServerCertificate: true }
  };
  
  const pool = await sql.connect(config);
  const migration = fs.readFileSync('drizzle/migrations/0034_add_tenant_indexes.sql', 'utf8');
  
  // Separar por GO
  const batches = migration.split(/^GO$/gm);
  
  for (const batch of batches) {
    if (batch.trim()) {
      await pool.request().batch(batch);
      console.log('Executed batch');
    }
  }
  
  console.log('Migration completed!');
  await pool.close();
}

run().catch(console.error);
"
```

### Verifica√ß√£o P√≥s-Execu√ß√£o

```sql
-- Verificar √≠ndices criados
SELECT 
  t.name AS TableName,
  i.name AS IndexName,
  i.type_desc AS IndexType,
  i.filter_definition AS FilterDefinition,
  STUFF((
    SELECT ', ' + c.name
    FROM sys.index_columns ic
    JOIN sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
    WHERE ic.object_id = i.object_id AND ic.index_id = i.index_id AND ic.is_included_column = 0
    ORDER BY ic.key_ordinal
    FOR XML PATH('')
  ), 1, 2, '') AS KeyColumns,
  STUFF((
    SELECT ', ' + c.name
    FROM sys.index_columns ic
    JOIN sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
    WHERE ic.object_id = i.object_id AND ic.index_id = i.index_id AND ic.is_included_column = 1
    ORDER BY ic.key_ordinal
    FOR XML PATH('')
  ), 1, 2, '') AS IncludedColumns
FROM sys.indexes i
JOIN sys.tables t ON i.object_id = t.object_id
WHERE i.name LIKE 'idx_%'
ORDER BY t.name, i.name;
```

---

## üîß E8.3: HABILITAR QUERY STORE

### Pr√©-Requisitos

- SQL Server 2016+ (Standard ou Enterprise)
- Permiss√£o ALTER DATABASE

### Execu√ß√£o

```sql
-- 1. Conectar ao banco de dados
-- 2. Abrir arquivo: scripts/sql/enable-query-store.sql
-- 3. Executar (F5)
-- 4. Verificar configura√ß√£o
```

### Verifica√ß√£o

```sql
-- Status do Query Store
SELECT 
  actual_state_desc,
  desired_state_desc,
  current_storage_size_mb,
  max_storage_size_mb,
  query_capture_mode_desc
FROM sys.database_query_store_options;
```

---

## üìã CHECKLIST DE EXECU√á√ÉO

### Ambiente de Desenvolvimento

- [ ] Executar migration 0034
- [ ] Verificar √≠ndices criados (35 esperados)
- [ ] Habilitar Query Store
- [ ] Verificar status Query Store

### Ambiente de Homologa√ß√£o

- [ ] Agendar janela de manuten√ß√£o
- [ ] Backup do banco
- [ ] Executar migration 0034
- [ ] Verificar √≠ndices
- [ ] Habilitar Query Store
- [ ] Testar performance

### Ambiente de Produ√ß√£o

- [ ] Agendar janela de manuten√ß√£o (baixo uso)
- [ ] Backup completo do banco
- [ ] Executar migration 0034 (estimativa: 5-15 min)
- [ ] Verificar √≠ndices
- [ ] Habilitar Query Store
- [ ] Monitorar performance por 24h
- [ ] Documentar m√©tricas antes/depois

---

## üìä IMPACTO ESPERADO

### Performance

| Opera√ß√£o | Antes (estimado) | Depois (estimado) | Melhoria |
|----------|------------------|-------------------|----------|
| `findMany` com tenant | ~500ms | ~10ms | **50x** |
| Count por organiza√ß√£o | ~300ms | ~5ms | **60x** |
| Dashboard financeiro | ~2s | ~200ms | **10x** |
| Listagem de documentos | ~1s | ~50ms | **20x** |

### Storage

| Recurso | Estimativa |
|---------|------------|
| Espa√ßo dos √≠ndices | ~500MB - 2GB |
| Query Store | ~100MB - 1GB |

---

## ‚ö†Ô∏è ROLLBACK

Se necess√°rio reverter:

```sql
-- Remover todos os √≠ndices criados
DROP INDEX IF EXISTS [idx_accounts_payable_tenant] ON [accounts_payable];
DROP INDEX IF EXISTS [idx_accounts_receivable_tenant] ON [accounts_receivable];
DROP INDEX IF EXISTS [idx_bank_accounts_tenant] ON [bank_accounts];
DROP INDEX IF EXISTS [idx_bank_transactions_tenant] ON [bank_transactions];
DROP INDEX IF EXISTS [idx_trips_tenant] ON [trips];
DROP INDEX IF EXISTS [idx_trip_stops_tenant] ON [trip_stops];
DROP INDEX IF EXISTS [idx_trip_documents_tenant] ON [trip_documents];
DROP INDEX IF EXISTS [idx_trip_checkpoints_tenant] ON [trip_checkpoints];
DROP INDEX IF EXISTS [idx_trip_occurrences_tenant] ON [trip_occurrences];
DROP INDEX IF EXISTS [idx_cargo_documents_tenant] ON [cargo_documents];
DROP INDEX IF EXISTS [idx_cte_header_tenant] ON [cte_header];
DROP INDEX IF EXISTS [idx_mdfe_header_tenant] ON [mdfe_header];
DROP INDEX IF EXISTS [idx_pickup_orders_tenant] ON [pickup_orders];
DROP INDEX IF EXISTS [idx_billing_invoices_tenant] ON [billing_invoices];
DROP INDEX IF EXISTS [idx_inbound_invoices_tenant] ON [inbound_invoices];
DROP INDEX IF EXISTS [idx_fiscal_settings_tenant] ON [fiscal_settings];
DROP INDEX IF EXISTS [idx_fuel_transactions_tenant] ON [fuel_transactions];
DROP INDEX IF EXISTS [idx_maintenance_work_orders_tenant] ON [maintenance_work_orders];
DROP INDEX IF EXISTS [idx_frota_abastecimentos_tenant] ON [frota_abastecimentos];
DROP INDEX IF EXISTS [idx_warehouse_movements_tenant] ON [warehouse_movements];
DROP INDEX IF EXISTS [idx_warehouse_inventory_counts_tenant] ON [warehouse_inventory_counts];
DROP INDEX IF EXISTS [idx_inventory_adjustments_tenant] ON [inventory_adjustments];
DROP INDEX IF EXISTS [idx_lancamentos_contabeis_tenant] ON [lancamentos_contabeis];
-- ... demais √≠ndices

-- Desabilitar Query Store
ALTER DATABASE CURRENT SET QUERY_STORE = OFF;
```

---

## üìö REFER√äNCIAS

- [SQL Server Index Design Guide](https://docs.microsoft.com/sql/relational-databases/sql-server-index-design-guide)
- [Query Store Overview](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store)
- [Multi-Tenant Indexing Patterns](https://docs.microsoft.com/azure/architecture/guide/multitenant/service/sql-database)
