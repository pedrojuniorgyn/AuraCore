# E7.20 - AnÃ¡lise Input Ports

**Data:** 14/01/2026  
**Ã‰pico:** E7 - Melhoria ContÃ­nua  
**Tipo:** AnÃ¡lise de Gap Arquitetural

---

## ğŸ“Š SumÃ¡rio Executivo

| MÃ©trica | Valor |
|---------|-------|
| **Total de Use Cases** | 51 |
| **MÃ³dulos Analisados** | 5 (Financial, Accounting, Fiscal, WMS, TMS) |
| **Input Ports Existentes** | **0** âŒ |
| **Output Ports Existentes** | 13 âœ… |
| **Gap de Arquitetura** | **100%** (0 de 5 mÃ³dulos com Input Ports) |

### ğŸ”´ ConclusÃ£o CrÃ­tica

**TODOS os Use Cases do AuraCore violam ARCH-010:**

> **ARCH-010:** Use Cases devem implementar interface de `domain/ports/input/`

Atualmente:
- âœ… **Output Ports (RepositÃ³rios):** Implementados corretamente em `domain/ports/output/`
- âŒ **Input Ports (Use Cases):** Inexistentes - Use Cases nÃ£o tÃªm contratos definidos

**Impacto:**
1. **InversÃ£o de DependÃªncia quebrada** - Use Cases sÃ£o classes concretas, nÃ£o abstraÃ§Ãµes
2. **Testes acoplados** - Mocks dependem de implementaÃ§Ã£o, nÃ£o de interface
3. **DI inapropriado** - Container registra classes ao invÃ©s de interfaces
4. **Substituibilidade comprometida** - NÃ£o Ã© possÃ­vel trocar implementaÃ§Ãµes facilmente

---

## ğŸ“‹ InventÃ¡rio Completo por MÃ³dulo

### 1. Financial (11 Use Cases)

| # | Use Case | Tipo | Input Port NecessÃ¡rio | Status |
|---|----------|------|-----------------------|--------|
| 1 | `CancelPayableUseCase` | Command | `ICancelPayable` | âŒ NÃ£o existe |
| 2 | `CreatePayableUseCase` | Command | `ICreatePayable` | âŒ NÃ£o existe |
| 3 | `GeneratePayableTitleUseCase` | Command | `IGeneratePayableTitle` | âŒ NÃ£o existe |
| 4 | `GenerateReceivableTitleUseCase` | Command | `IGenerateReceivableTitle` | âŒ NÃ£o existe |
| 5 | `PayAccountPayableUseCase` | Command | `IPayAccountPayable` | âŒ NÃ£o existe |
| 6 | `ReverseTitlesUseCase` | Command | `IReverseTitles` | âŒ NÃ£o existe |
| 7 | `GetPayableByIdUseCase` | Query | `IGetPayableById` | âŒ NÃ£o existe |
| 8 | `ListPayablesUseCase` | Query | `IListPayables` | âŒ NÃ£o existe |
| 9 | `ApproveExpenseReportUseCase` | Command | `IApproveExpenseReport` | âŒ NÃ£o existe |
| 10 | `RejectExpenseReportUseCase` | Command | `IRejectExpenseReport` | âŒ NÃ£o existe |
| 11 | `SubmitExpenseReportUseCase` | Command | `ISubmitExpenseReport` | âŒ NÃ£o existe |

**Output Ports Existentes:**
- âœ… `IExpenseReportRepository`
- âœ… `IPayableRepository`
- âœ… `IReceiptRepository`

**PadrÃ£o Atual:**
```typescript
// âŒ ImplementaÃ§Ã£o atual (sem Input Port)
export class PayAccountPayableUseCase implements IUseCaseWithContext<PayAccountPayableInput, PayAccountPayableOutput> {
  constructor(
    @inject('IPayableRepository') private payableRepo: IPayableRepository
  ) {}
  
  async execute(input: PayAccountPayableInput, ctx: ExecutionContext): Promise<Result<PayAccountPayableOutput, string>> {
    // ...
  }
}

// âŒ DI atual: registra CLASSE
container.register('PayAccountPayableUseCase', { useClass: PayAccountPayableUseCase });

// âŒ Controller atual: depende de CLASSE
constructor(@inject('PayAccountPayableUseCase') private useCase: PayAccountPayableUseCase) {}
```

**PadrÃ£o Correto (com Input Port):**
```typescript
// âœ… Input Port (interface)
export interface IPayAccountPayable {
  execute(input: PayAccountPayableInput, ctx: ExecutionContext): Promise<Result<PayAccountPayableOutput, string>>;
}

// âœ… Use Case implementa Input Port
export class PayAccountPayableUseCase implements IPayAccountPayable {
  constructor(
    @inject('IPayableRepository') private payableRepo: IPayableRepository
  ) {}
  
  async execute(input: PayAccountPayableInput, ctx: ExecutionContext): Promise<Result<PayAccountPayableOutput, string>> {
    // ...
  }
}

// âœ… DI: registra INTERFACE â†’ CLASSE
container.register<IPayAccountPayable>('IPayAccountPayable', { useClass: PayAccountPayableUseCase });

// âœ… Controller: depende de INTERFACE
constructor(@inject('IPayAccountPayable') private useCase: IPayAccountPayable) {}
```

---

### 2. Accounting (7 Use Cases)

| # | Use Case | Tipo | Input Port NecessÃ¡rio | Status |
|---|----------|------|-----------------------|--------|
| 1 | `AddLineToEntryUseCase` | Command | `IAddLineToEntry` | âŒ NÃ£o existe |
| 2 | `CreateJournalEntryUseCase` | Command | `ICreateJournalEntry` | âŒ NÃ£o existe |
| 3 | `GenerateJournalEntryUseCase` | Command | `IGenerateJournalEntry` | âŒ NÃ£o existe |
| 4 | `PostJournalEntryUseCase` | Command | `IPostJournalEntry` | âŒ NÃ£o existe |
| 5 | `ReverseJournalEntryUseCase` | Command | `IReverseJournalEntry` | âŒ NÃ£o existe |
| 6 | `GetJournalEntryByIdUseCase` | Query | `IGetJournalEntryById` | âŒ NÃ£o existe |
| 7 | `ListJournalEntriesUseCase` | Query | `IListJournalEntries` | âŒ NÃ£o existe |

**Output Ports Existentes:**
- âœ… `IJournalEntryRepository`

---

### 3. Fiscal (16 Use Cases)

| # | Use Case | Tipo | Input Port NecessÃ¡rio | Status |
|---|----------|------|-----------------------|--------|
| 1 | `AuditTaxTransitionUseCase` | Query | `IAuditTaxTransition` | âŒ NÃ£o existe |
| 2 | `AuthorizeFiscalDocumentUseCase` | Command | `IAuthorizeFiscalDocument` | âŒ NÃ£o existe |
| 3 | `CalculateCompensationUseCase` | Command | `ICalculateCompensation` | âŒ NÃ£o existe |
| 4 | `CalculateIbsCbsUseCase` | Command | `ICalculateIbsCbs` | âŒ NÃ£o existe |
| 5 | `CalculateTaxesUseCase` | Command | `ICalculateTaxes` | âŒ NÃ£o existe |
| 6 | `CancelFiscalDocumentUseCase` | Command | `ICancelFiscalDocument` | âŒ NÃ£o existe |
| 7 | `CompareTaxRegimesUseCase` | Query | `ICompareTaxRegimes` | âŒ NÃ£o existe |
| 8 | `CreateFiscalDocumentUseCase` | Command | `ICreateFiscalDocument` | âŒ NÃ£o existe |
| 9 | `GenerateSpedContributionsUseCase` | Command | `IGenerateSpedContributions` | âŒ NÃ£o existe |
| 10 | `GenerateSpedEcdUseCase` | Command | `IGenerateSpedEcd` | âŒ NÃ£o existe |
| 11 | `GenerateSpedFiscalUseCase` | Command | `IGenerateSpedFiscal` | âŒ NÃ£o existe |
| 12 | `GetTaxRatesUseCase` | Query | `IGetTaxRates` | âŒ NÃ£o existe |
| 13 | `ProcessTaxCreditsUseCase` | Command | `IProcessTaxCredits` | âŒ NÃ£o existe |
| 14 | `SimulateTaxScenarioUseCase` | Query | `ISimulateTaxScenario` | âŒ NÃ£o existe |
| 15 | `SubmitFiscalDocumentUseCase` | Command | `ISubmitFiscalDocument` | âŒ NÃ£o existe |
| 16 | `ValidateIbsCbsGroupUseCase` | Query | `IValidateIbsCbsGroup` | âŒ NÃ£o existe |

**Output Ports Existentes:**
- âœ… `IFiscalDocumentPdfGenerator`
- âœ… `IFiscalDocumentRepository`
- âœ… `ISefazService`
- âœ… `ITaxRateRepository`

**Nota:** Fiscal Ã© o mÃ³dulo mais crÃ­tico devido a:
- Risco de multas fiscais (SPED)
- Complexidade tributÃ¡ria (Reforma 2026)
- Alto nÃºmero de Use Cases (16)

---

### 4. WMS (17 Use Cases)

#### Commands (8)

| # | Use Case | Input Port NecessÃ¡rio | Status |
|---|----------|-----------------------|--------|
| 1 | `CompleteInventoryCount` | `ICompleteInventoryCount` | âŒ NÃ£o existe |
| 2 | `CreateLocation` | `ICreateLocation` | âŒ NÃ£o existe |
| 3 | `DeleteLocation` | `IDeleteLocation` | âŒ NÃ£o existe |
| 4 | `RegisterStockEntry` | `IRegisterStockEntry` | âŒ NÃ£o existe |
| 5 | `RegisterStockExit` | `IRegisterStockExit` | âŒ NÃ£o existe |
| 6 | `StartInventoryCount` | `IStartInventoryCount` | âŒ NÃ£o existe |
| 7 | `TransferStock` | `ITransferStock` | âŒ NÃ£o existe |
| 8 | `UpdateLocation` | `IUpdateLocation` | âŒ NÃ£o existe |

#### Queries (9)

| # | Use Case | Input Port NecessÃ¡rio | Status |
|---|----------|-----------------------|--------|
| 1 | `GetInventoryCountById` | `IGetInventoryCountById` | âŒ NÃ£o existe |
| 2 | `GetLocationById` | `IGetLocationById` | âŒ NÃ£o existe |
| 3 | `GetMovementById` | `IGetMovementById` | âŒ NÃ£o existe |
| 4 | `GetStockByProduct` | `IGetStockByProduct` | âŒ NÃ£o existe |
| 5 | `GetStockItemById` | `IGetStockItemById` | âŒ NÃ£o existe |
| 6 | `ListInventoryCounts` | `IListInventoryCounts` | âŒ NÃ£o existe |
| 7 | `ListLocations` | `IListLocations` | âŒ NÃ£o existe |
| 8 | `ListMovements` | `IListMovements` | âŒ NÃ£o existe |
| 9 | `ListStockItems` | `IListStockItems` | âŒ NÃ£o existe |

**Output Ports (4) - âš ï¸ Estrutura incorreta:**
- âš ï¸ `IInventoryCountRepository` (em `domain/ports/` ao invÃ©s de `domain/ports/output/`)
- âš ï¸ `ILocationRepository`
- âš ï¸ `IMovementRepository`
- âš ï¸ `IStockRepository`

**ObservaÃ§Ã£o:** WMS tem estrutura de ports diferente (sem subpasta `output/`). Precisa refatorar para `domain/ports/output/`.

---

### 5. TMS (0 Use Cases)

**Status:** MÃ³dulo TMS ainda nÃ£o tem application layer implementado.

**Output Ports (1):**
- âš ï¸ `IRomaneioRepository` (em `domain/ports/` ao invÃ©s de `domain/ports/output/`)

**RecomendaÃ§Ã£o:** Aguardar implementaÃ§Ã£o de Use Cases antes de criar Input Ports.

---

## ğŸ—ï¸ PadrÃ£o Arquitetural Esperado

### Estrutura de Pastas Correta

```
src/modules/{module}/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ value-objects/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ events/
â”‚   â”œâ”€â”€ errors/
â”‚   â””â”€â”€ ports/
â”‚       â”œâ”€â”€ input/           # âŒ FALTANDO (100% gap)
â”‚       â”‚   â”œâ”€â”€ ICreateEntity.ts
â”‚       â”‚   â”œâ”€â”€ IUpdateEntity.ts
â”‚       â”‚   â””â”€â”€ IListEntities.ts
â”‚       â””â”€â”€ output/          # âœ… EXISTEM (implementado)
â”‚           â”œâ”€â”€ IEntityRepository.ts
â”‚           â””â”€â”€ IExternalService.ts
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ commands/            # Implementam ports/input/
â”‚   â”œâ”€â”€ queries/             # Implementam ports/input/
â”‚   â””â”€â”€ dtos/
â””â”€â”€ infrastructure/
    â”œâ”€â”€ persistence/
    â”‚   â”œâ”€â”€ repositories/    # Implementam ports/output/
    â”‚   â”œâ”€â”€ mappers/
    â”‚   â””â”€â”€ schemas/
    â””â”€â”€ di/
```

### Template de Input Port

```typescript
// src/modules/{module}/domain/ports/input/ICreateEntity.ts

import type { Result } from '@/shared/domain';
import type { ExecutionContext } from '@/shared/domain';

/**
 * Input Port: Criar Entity
 * 
 * Use Case Interface seguindo ARCH-010
 */
export interface ICreateEntity {
  /**
   * Executa criaÃ§Ã£o de Entity
   * 
   * @param input - Dados de entrada
   * @param context - Contexto de execuÃ§Ã£o (multi-tenancy)
   * @returns Result com Output ou mensagem de erro
   */
  execute(
    input: CreateEntityInput,
    context: ExecutionContext
  ): Promise<Result<CreateEntityOutput, string>>;
}

export interface CreateEntityInput {
  name: string;
  description?: string;
  // ... campos de negÃ³cio
}

export interface CreateEntityOutput {
  id: string;
  name: string;
  createdAt: Date;
  // ... campos retornados
}
```

### Template de Use Case Implementando Input Port

```typescript
// src/modules/{module}/application/commands/CreateEntityUseCase.ts

import { inject, injectable } from 'tsyringe';
import type { ICreateEntity, CreateEntityInput, CreateEntityOutput } from '../../domain/ports/input/ICreateEntity';
import type { IEntityRepository } from '../../domain/ports/output/IEntityRepository';
import { Entity } from '../../domain/entities/Entity';
import { Result } from '@/shared/domain';
import type { ExecutionContext } from '@/shared/domain';

/**
 * Use Case: Criar Entity
 * 
 * Implementa ICreateEntity (Input Port)
 */
@injectable()
export class CreateEntityUseCase implements ICreateEntity {
  constructor(
    @inject('IEntityRepository') private readonly entityRepository: IEntityRepository
  ) {}

  async execute(
    input: CreateEntityInput,
    context: ExecutionContext
  ): Promise<Result<CreateEntityOutput, string>> {
    // 1. Validar input
    if (!input.name?.trim()) {
      return Result.fail('Nome Ã© obrigatÃ³rio');
    }

    // 2. Criar Entity (domain logic)
    const entityResult = Entity.create({
      name: input.name.trim(),
      description: input.description?.trim(),
      organizationId: context.organizationId,
      branchId: context.branchId,
    });

    if (!Result.isOk(entityResult)) {
      return Result.fail(entityResult.error);
    }

    // 3. Persistir
    await this.entityRepository.save(entityResult.value);

    // 4. Retornar output
    return Result.ok({
      id: entityResult.value.id,
      name: entityResult.value.name,
      createdAt: entityResult.value.createdAt,
    });
  }
}
```

### Template de DI Registration

```typescript
// src/modules/{module}/infrastructure/di/container.ts

import { container } from 'tsyringe';
import type { ICreateEntity } from '../../domain/ports/input/ICreateEntity';
import { CreateEntityUseCase } from '../../application/commands/CreateEntityUseCase';

export function registerModule() {
  // âœ… CORRETO: Registrar INTERFACE â†’ IMPLEMENTAÃ‡ÃƒO
  container.register<ICreateEntity>(
    'ICreateEntity',
    { useClass: CreateEntityUseCase }
  );
}
```

### Template de Controller/Dependente

```typescript
// src/modules/{module}/presentation/controllers/EntityController.ts

import { inject, injectable } from 'tsyringe';
import type { ICreateEntity } from '../../domain/ports/input/ICreateEntity';
import { NextRequest, NextResponse } from 'next/server';

@injectable()
export class EntityController {
  constructor(
    // âœ… CORRETO: Depende de INTERFACE, nÃ£o de classe
    @inject('ICreateEntity') private readonly createEntity: ICreateEntity
  ) {}

  async create(request: NextRequest, context: ExecutionContext) {
    const body = await request.json();
    
    const result = await this.createEntity.execute(body, context);
    
    if (!Result.isOk(result)) {
      return NextResponse.json({ error: result.error }, { status: 400 });
    }
    
    return NextResponse.json({ data: result.value }, { status: 201 });
  }
}
```

---

## ğŸ¯ ViolaÃ§Ãµes de Arquitetura Identificadas

### 1. ARCH-010: Use Cases nÃ£o implementam Input Ports

**Severidade:** ğŸ”´ ALTA  
**MÃ³dulos afetados:** 5 (100%)  
**Use Cases afetados:** 51 (100%)

**Problema:**
```typescript
// âŒ ATUAL: Use Case sem Input Port
export class PayAccountPayableUseCase implements IUseCaseWithContext<Input, Output> {
  // IUseCaseWithContext Ã© interface GENÃ‰RICA do BaseUseCase
  // NÃƒO Ã© uma interface especÃ­fica do domain
}
```

**SoluÃ§Ã£o:**
```typescript
// âœ… CORRETO: Use Case implementa Input Port especÃ­fico
export class PayAccountPayableUseCase implements IPayAccountPayable {
  // IPayAccountPayable Ã© interface ESPECÃFICA em domain/ports/input/
}
```

### 2. PORTS-STRUCTURE: WMS/TMS sem subpasta output/

**Severidade:** ğŸŸ¡ MÃ‰DIA  
**MÃ³dulos afetados:** WMS, TMS

**Problema:**
```
src/modules/wms/domain/ports/
â”œâ”€â”€ ILocationRepository.ts          # âŒ Direto em ports/
â”œâ”€â”€ IMovementRepository.ts
â””â”€â”€ IStockRepository.ts
```

**SoluÃ§Ã£o:**
```
src/modules/wms/domain/ports/
â”œâ”€â”€ input/                           # âœ… Criar
â”‚   â”œâ”€â”€ ICreateLocation.ts
â”‚   â””â”€â”€ IListLocations.ts
â””â”€â”€ output/                          # âœ… Mover para cÃ¡
    â”œâ”€â”€ ILocationRepository.ts
    â””â”€â”€ IMovementRepository.ts
```

### 3. DI-VIOLATION: Container registra classes ao invÃ©s de interfaces

**Severidade:** ğŸ”´ ALTA  
**MÃ³dulos afetados:** 5 (100%)

**Problema:**
```typescript
// âŒ DI atual
container.register('PayAccountPayableUseCase', { useClass: PayAccountPayableUseCase });

// âŒ Dependente
constructor(@inject('PayAccountPayableUseCase') private useCase: PayAccountPayableUseCase) {}
```

**SoluÃ§Ã£o:**
```typescript
// âœ… DI correto
container.register<IPayAccountPayable>('IPayAccountPayable', { useClass: PayAccountPayableUseCase });

// âœ… Dependente
constructor(@inject('IPayAccountPayable') private useCase: IPayAccountPayable) {}
```

### 4. TEST-COUPLING: Testes acoplados a implementaÃ§Ã£o

**Severidade:** ğŸŸ¡ MÃ‰DIA  
**Impacto:** Dificulta refatoraÃ§Ã£o

**Problema:**
```typescript
// âŒ Teste acoplado a classe
const useCase = new PayAccountPayableUseCase(mockRepo);
```

**SoluÃ§Ã£o:**
```typescript
// âœ… Teste usa interface
const useCase: IPayAccountPayable = new PayAccountPayableUseCase(mockRepo);
// Ou melhor: resolver do container de testes
```

---

## ğŸ“Š EstatÃ­sticas Detalhadas

### Por MÃ³dulo

| MÃ³dulo | Use Cases | Input Ports | Output Ports | Gap % |
|--------|-----------|-------------|--------------|-------|
| Financial | 11 | 0 | 3 | 100% |
| Accounting | 7 | 0 | 1 | 100% |
| Fiscal | 16 | 0 | 4 | 100% |
| WMS | 17 | 0 | 4* | 100% |
| TMS | 0 | 0 | 1* | N/A |
| **TOTAL** | **51** | **0** | **13** | **100%** |

_* Output Ports em estrutura incorreta (sem subpasta `output/`)_

### Por Tipo de Use Case

| Tipo | Quantidade | % |
|------|-----------|---|
| Commands | 32 | 63% |
| Queries | 19 | 37% |
| **Total** | **51** | **100%** |

### Impacto de NegÃ³cio

| MÃ³dulo | Criticidade | Risco |
|--------|-------------|-------|
| Fiscal | ğŸ”´ CRÃTICA | Multas SEFAZ (R$ 5.000+) |
| Financial | ğŸ”´ CRÃTICA | TÃ­tulos duplicados |
| Accounting | ğŸŸ¡ ALTA | Auditoria fiscal |
| WMS | ğŸŸ¡ MÃ‰DIA | Operacional |
| TMS | ğŸŸ¢ BAIXA | Em desenvolvimento |

---

## ğŸ”„ Interface GenÃ©rica Atual (IUseCaseWithContext)

**LocalizaÃ§Ã£o:** Cada `BaseUseCase.ts` define sua prÃ³pria versÃ£o (cÃ³digo duplicado)

```typescript
// src/modules/{module}/application/use-cases/BaseUseCase.ts

export interface IUseCaseWithContext<TInput, TOutput> {
  execute(input: TInput, ctx: ExecutionContext): Promise<Result<TOutput, string>>;
}
```

**Problemas:**
1. âŒ CÃ³digo duplicado (3 definiÃ§Ãµes idÃªnticas)
2. âŒ NÃ£o Ã© uma interface de DOMAIN (estÃ¡ em application/)
3. âŒ Ã‰ GENÃ‰RICA - nÃ£o define contrato especÃ­fico por Use Case
4. âŒ NÃ£o permite substituiÃ§Ã£o individual de Use Cases

**SoluÃ§Ã£o:**
1. âœ… Mover para `@/shared/domain/use-case.ts` (eliminar duplicaÃ§Ã£o)
2. âœ… Criar Input Ports especÃ­ficos em cada `domain/ports/input/`
3. âœ… Use Cases implementam Input Port especÃ­fico (que pode estender a genÃ©rica)

---

## ğŸ¯ PrÃ³ximos Passos

1. âœ… **AnÃ¡lise concluÃ­da** (este documento)
2. â³ **Criar E7.20_PLANO_CRIACAO.md** (plano de implementaÃ§Ã£o)
3. â³ **AprovaÃ§Ã£o do plano**
4. â³ **E7.21: ExecuÃ§Ã£o** (criar Input Ports)

---

## ğŸ“š ReferÃªncias

- **ADR-0015:** Arquitetura DDD/Hexagonal
- **ARCH-010:** Use Cases implementam Input Ports
- **ARCH-011:** Repositories implementam Output Ports
- **Cockburn, A. (2005):** Hexagonal Architecture (Ports and Adapters)
- **Vernon, V. (2013):** Implementing Domain-Driven Design

---

**Documento gerado por:** E7.20 - AnÃ¡lise Input Ports  
**Data:** 14/01/2026  
**Modo:** ANÃLISE APENAS (sem modificaÃ§Ã£o de cÃ³digo)
