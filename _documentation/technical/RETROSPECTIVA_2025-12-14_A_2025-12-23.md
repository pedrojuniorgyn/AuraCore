# Retrospectiva (Chat + Implementação) — 2025-12-14 → 2025-12-23

## Escopo e fontes

- **Período**: 14/12/2025 → 23/12/2025 (inclusive)
- **Fonte primária**: transcript do chat (Cursor) em:
  - `/Users/pedrolemes/.cursor/projects/Users-pedrolemes-aura-core/agent-transcripts/26a517f2-7f8a-465b-8c5e-0dbd41160bb5.txt`
- **Fonte secundária**: histórico git do `aura_core` no mesmo intervalo (commits e paths).

> Nota: esta retrospectiva consolida **planejamento + execução**. Para detalhes profundos do Módulo de Auditoria (GlobalTCL/AuditFinDB), ver: `MODULO_AUDITORIA_GLOBALTCL_AUDITFINDB.md`.

---

## 1) Resultado executivo (o que ficou “de pé” no período)

### 1.1 Entregas de base (hardening/compatibilidade)
- **SQL Server compat**: remoção/evitação de `.returning()` e ajustes de compatibilidade em rotas e serviços para SQL Server.
- **Segurança de writes**: bloqueio de override via `...body` quando `organizationId`/`branchId` não devem vir do payload.
- **Contrato de identidade (auditoria)**: padronização para `userId` como **string UUID** em auditoria (`createdBy/updatedBy`) e correções de endpoints que faziam `parseInt(userId)`.
- **Transações / atomicidade**: operações multi-step críticas passaram a usar transação para reduzir estado parcial (financeiro/contábil/fiscal e integrações).

### 1.2 Observabilidade e operação (Coolify)
- **Onda 5A (observabilidade)**: request-id/correlation, `Server-Timing`, logs estruturados e “diagnóstico de requests lentos”.
- **Operação via token interno**: liberação controlada de endpoints de diagnóstico via token para reduzir dependência de terminal/SSH no Coolify.

### 1.3 Auditoria (GlobalTCL → AuditFinDB)
Houve duas linhas em paralelo no período:
- **Módulo Auditoria dentro do `aura_core`** (17/12–22/12): UI + APIs + SSRM + token operacional (`x-audit-token`) + docs/ADR.
- **Módulo Auditoria como app separado (audit-tcl)**: arquitetura e implementação de Audit API + Audit UI (fora do repo `aura_core`, mas planejado/validado no chat).

---

## 2) Linha do tempo (por dia) — planejamento e execução

> Referência: lista de commits no intervalo (exemplos):  
> 14/12: `c64b623`, `5f3422f`, `dc1f5a2`, `90551b8`  
> 15/12: `6ef242d`, `4c8eefd`, `df6b01c`, `4492f06`, `92bf920`, `efd0d93`, etc.  
> 16/12: `ded0d4b`, `a184d89`, `dc736d8`, `af2c3de`, `b7a6476`  
> 17/12–22/12 (Auditoria no AuraCore): `8e62d65`, `afe44e9`, `36b311b`, `f0b6c72`, `b6f3926`, `604f8de`, `b08d9a2`, `21c46f9`, `86b7af0`, `740f7cf`  
> 22/12 (Observabilidade): `7c0bef1`, `f9869e8`, `6389349`, `a277cee`, `c416053`  
> 23/12 (Idempotência): criação/migration `0033` (ver transcript; commit pode variar conforme squash/PR).

### 14/12 — Seeds e fundação de permissões/conexão
- **Seeds**:
  - `feat(seed)`: import de master data (PCC/PCG/CC/CF/NCM/CC3D) e ajustes para criar tabela antes do load.
- **Auth/DB**:
  - `ensureConnection` em fluxo de login/adapter.
  - `seed-permissions` garantindo tabela `user_roles` quando faltar.

### 15/12 — Compat SQL Server, segurança, paginação e transações
- **Compat SQL Server**:
  - remoção de `.returning()` em rotas e fluxo de billing/financeiro.
- **Segurança de payload**:
  - “header manda / tenant manda”: impedir override via spread do body em rotas de write.
- **Paginação/SSRM**:
  - paginação server-side (incluindo casos “MAX()+1” e carga incremental) para grandes volumes.
- **Transações**:
  - operações multi-step sensíveis (financeiro/contábil) passaram a ser transacionais e com auditoria consistente.
- **Coolify**:
  - healthcheck do SQL ajustado para não depender de ferramentas indisponíveis no container.
- **Docs**:
  - documentação canônica inicial: governança, contratos e runbooks.

### 16/12 — Hardening final e correções pontuais
- **Security sweep**:
  - reforço de isolamento por `organizationId` em endpoints.
- **CRM**:
  - correção de update parcial preservando `wonDate`.
- **Higiene do repo**:
  - normalização de finais de arquivo em lote (chore).

### 17/12 — Auditoria no AuraCore: snapshots + ETL inicial
**Implementado (commit referência: `8e62d65`)**
- **APIs adicionadas**:
  - `src/app/api/admin/audit/snapshots/route.ts`
  - `src/app/api/admin/audit/snapshots/run/route.ts`
- **Lib ETL/infra**:
  - `src/lib/audit/db.ts`
  - `src/lib/audit/env.ts`
  - `src/lib/audit/etl/bulk.ts`
  - `src/lib/audit/etl/snapshotRun.ts`

Objetivo: permitir **execução de snapshot/ETL** e **listar runs** no AuditFinDB.

### 18/12 — Auditoria no AuraCore: menu e tela de snapshots + RBAC
**Implementado (commit referência: `afe44e9`)**
- **Telas adicionadas**:
  - `src/app/(dashboard)/auditoria/snapshots/page.tsx`
- **Sidebar**:
  - menu “Auditoria” no `GroupedSidebar`.
- **RBAC**:
  - alinhamento das rotas a permissões do domínio `audit.*` (ex.: `audit.read`, `audit.run`, `audit.migrate`).

### 19/12 — Auditoria no AuraCore: robustez e scoping por legado
**Implementações no período (commits de referência):** `f0b6c72`, `b6f3926`, `604f8de`, `b08d9a2`
- **Robustez**:
  - tratar respostas não-JSON (502/504) na UI de snapshots.
  - “runs pendurados” (stale) marcados como FAILED após tolerância configurável.
- **Multi-tenancy / branch scoping**:
  - evolução de schema para segregar runs por `organization_id`.
  - scoping por filial via **`legacyCompanyBranchCode`** (mapeando para `CodigoEmpresaFilial` no legado GlobalTCL).

### 22/12 — Auditoria no AuraCore: isolamento do módulo + SSRM + grids premium
**Implementado (commit referência: `86b7af0` + `21c46f9`)**

**Telas (UI) criadas** (todas sob `src/app/(dashboard)/auditoria/*`):
- `auditoria/page.tsx`
- `auditoria/snapshots/page.tsx`
- `auditoria/contas-pagar/page.tsx`
- `auditoria/contas-receber/page.tsx`
- `auditoria/conciliacao/page.tsx`
- `auditoria/cashflow/page.tsx`
- `auditoria/findings/page.tsx`
- `auditoria/parcelas/page.tsx`

**Componentes (grids premium / SSRM)**:
- `src/components/audit/audit-snapshots-grid.tsx`
- `src/components/audit/audit-parcelas-grid.tsx`
- `src/components/audit/audit-findings-grid.tsx`
- `src/components/audit/audit-cashflow-grid.tsx`

**APIs (admin/audit)**:
- Snapshots:
  - `GET /api/admin/audit/snapshots`
  - `POST /api/admin/audit/snapshots/run`
  - `POST /api/admin/audit/snapshots/migrate`
  - `POST /api/admin/audit/snapshots/cleanup`
  - `POST /api/admin/audit/snapshots/cleanup-by-run`
  - `POST /api/admin/audit/snapshots/ssrm`
  - `GET /api/admin/audit/snapshots/summary`
- Parcelas:
  - `GET /api/admin/audit/parcelas`
  - `POST /api/admin/audit/parcelas/ssrm`
  - `GET /api/admin/audit/parcelas/summary`
- Findings:
  - `GET /api/admin/audit/findings`
  - `POST /api/admin/audit/findings/ssrm`
  - `GET /api/admin/audit/findings/summary`
- Cashflow:
  - `GET /api/admin/audit/cashflow`
  - `POST /api/admin/audit/cashflow/ssrm`
  - `GET /api/admin/audit/cashflow/summary`
  - `GET /api/admin/audit/cashflow/chart`
- Legado (suporte/mapeamento):
  - `GET /api/admin/audit/legacy/branch-codes`
  - `GET /api/admin/audit/legacy/tax-classifications`

**Docs/decisões (no período)**:
- `docs/architecture/domains/AUDITORIA.md` (domínio Auditoria)
- `docs/architecture/adr/0007-audit-ops-http-token.md` (token operacional via HTTP)

### 22/12 — Observabilidade e diagnóstico (Onda 5A)
- **Request correlation**:
  - `x-request-id`, `Server-Timing`, threshold de lentidão.
- **Diagnósticos via token**:
  - liberação do endpoint de diagnósticos para uso em Coolify sem depender de sessão/cookie.
- **Docs**:
  - roadmap executivo Ondas 5A–9 e log de execução.

### 22/12 — “Evento” relevante: remoção do menu Auditoria do sidebar
No fim do período, houve commit que removeu apenas o **menu** de Auditoria do sidebar:
- referência: `740f7cf fix(core): remover menu de Auditoria do sidebar`

> Importante: o módulo em si (telas/APIs) existiu no período e foi “isolado”; porém o item de navegação foi removido naquele momento (por razões de organização/escopo do PR), o que fez o acesso ficar indireto.

### 23/12 — Idempotência (infra para integrações)
Planejado e implementado no chat (e materializado em migração e utilitários):
- migração `drizzle/migrations/0033_idempotency_keys.sql`
- utilitários em `src/lib/idempotency/*`

Motivação: deduplicação e “efeito único” para integrações/rotas sensíveis em ambiente multi-réplica (Coolify).

---

## 3) Inventário (resumo) — telas, rotas, scripts e configs tocados no período

### 3.1 Telas (UI) — Auditoria (AuraCore)
Criadas no período (referência: `86b7af0` / `afe44e9` / `21c46f9`):
- `/auditoria` (hub)
- `/auditoria/snapshots`
- `/auditoria/contas-pagar`
- `/auditoria/contas-receber`
- `/auditoria/conciliacao`
- `/auditoria/cashflow`
- `/auditoria/findings`
- `/auditoria/parcelas`

### 3.2 Rotas API — Auditoria (AuraCore)
Criadas no período (referência: `86b7af0` / `8e62d65` / `21c46f9`):
- Namespace: `/api/admin/audit/*` com SSRM + summaries + operações (run/migrate/cleanup).

### 3.3 Scripts / migrações / operação
- Seeds e scripts de manutenção (14–16/12): master data e hardening.
- Runbooks (Coolify/migrações/seeds) e ADRs (22/12).
- Migração de idempotência (23/12): `0033_idempotency_keys.sql`.

### 3.4 Configurações relevantes (Coolify + DB)
- Token operacional (auditoria/ops/diagnóstico) para reduzir dependência de terminal:
  - `AUDIT_SNAPSHOT_HTTP_TOKEN` (aura_core, quando o módulo Auditoria estava interno)
- Bancos e credenciais segregadas:
  - **GlobalTCL**: usuário **read-only** (SELECT)
  - **AuditFinDB**: usuário read/write apenas no banco de auditoria

---

## 4) Referências rápidas

- Dossiê do módulo Auditoria (GlobalTCL/AuditFinDB): `../technical/MODULO_AUDITORIA_GLOBALTCL_AUDITFINDB.md`
- Planejamento do Audit TCL (app separado): `/Users/pedrolemes/audit-tcl/PLANEJAMENTO_AUDIT_TCL.md`
- Audit TCL README (endpoints P0 + operação): `/Users/pedrolemes/audit-tcl/README.md`

