# .github/workflows/ci.yml
# CI Pipeline: Lint, Test, Build para Frontend e Agents
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # FRONTEND - Next.js
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ‚îÄ‚îÄ GATE 1: TypeScript Strict Check (TSG-001) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  frontend-typecheck:
    name: üî∑ Gate 1 - TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript strict check (TSG-001)
        run: |
          echo "üî∑ TypeScript Gate (TSG-001): HARD mode"
          # Disable pipefail temporarily so tee doesn't kill the script on tsc failure
          set +eo pipefail
          npx tsc --noEmit 2>&1 | tee tsc-output.txt
          TSC_EXIT=${PIPESTATUS[0]}
          set -eo pipefail
          ERROR_COUNT=$(grep -c 'error TS' tsc-output.txt || echo "0")
          echo "## TypeCheck Gate" >> $GITHUB_STEP_SUMMARY
          echo "- Exit code: $TSC_EXIT" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
          if [ "$TSC_EXIT" -ne 0 ]; then
            echo "‚ùå TypeCheck FAILED with $ERROR_COUNT errors" >> $GITHUB_STEP_SUMMARY
            tail -50 tsc-output.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "‚úÖ TypeCheck PASSED (0 errors)" >> $GITHUB_STEP_SUMMARY
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

  # ‚îÄ‚îÄ GATE 2: Code Quality (as any check) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  frontend-quality:
    name: üõ°Ô∏è Gate 2 - Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for 'as any' usage
        run: |
          echo "üõ°Ô∏è Code Quality Gate: 'as any' check"
          ANY_COUNT=$(grep -rn 'as any' src/ --include="*.ts" --include="*.tsx" | grep -v 'node_modules' | grep -v '.test.' | grep -v '.spec.' | wc -l || echo "0")
          echo "## Code Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "- 'as any' occurrences: $ANY_COUNT" >> $GITHUB_STEP_SUMMARY
          if [ "$ANY_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $ANY_COUNT 'as any' usages (warning, not blocking)" >> $GITHUB_STEP_SUMMARY
            grep -rn 'as any' src/ --include="*.ts" --include="*.tsx" | grep -v 'node_modules' | grep -v '.test.' | grep -v '.spec.' | head -20 >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Zero 'as any' found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for console.log in production code
        run: |
          CONSOLE_COUNT=$(grep -rn 'console\.\(log\|error\|warn\)' src/ --include="*.ts" --include="*.tsx" | grep -v 'node_modules' | grep -v '.test.' | grep -v '.spec.' | grep -v '__tests__' | wc -l || echo "0")
          echo "- console.log occurrences: $CONSOLE_COUNT" >> $GITHUB_STEP_SUMMARY

  # ‚îÄ‚îÄ GATE 3: Lint ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  frontend-lint:
    name: üîç Gate 3 - ESLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

  # ‚îÄ‚îÄ GATE 4: Unit Tests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  frontend-test:
    name: üß™ Gate 4 - Unit Tests
    runs-on: ubuntu-latest
    needs: [frontend-typecheck, frontend-lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Unit Tests with Coverage
        run: |
          echo "üß™ Test Gate: All tests must pass"
          # Disable pipefail temporarily so tee doesn't kill the script on test failure
          set +eo pipefail
          npm run test:unit -- --coverage --reporter=verbose 2>&1 | tee test-output.txt
          TEST_EXIT=${PIPESTATUS[0]}
          set -eo pipefail
          echo "## Test Gate" >> $GITHUB_STEP_SUMMARY
          echo "- Exit code: $TEST_EXIT" >> $GITHUB_STEP_SUMMARY
          # Extract test count from output
          PASS_COUNT=$(grep -oP '\d+ passed' test-output.txt | head -1 || echo "unknown")
          FAIL_COUNT=$(grep -oP '\d+ failed' test-output.txt | head -1 || echo "0")
          echo "- Passed: $PASS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_EXIT" -ne 0 ]; then
            echo "‚ùå Tests FAILED" >> $GITHUB_STEP_SUMMARY
            tail -30 test-output.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: frontend
          fail_ci_if_error: false
        continue-on-error: true

  frontend-build:
    name: üèóÔ∏è Frontend - Build
    runs-on: ubuntu-latest
    needs: [frontend-typecheck, frontend-lint, frontend-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          SKIP_ENV_VALIDATION: true
          DATABASE_URL: "sqlserver://localhost:1433;database=test;trustServerCertificate=true"
          AUTH_SECRET: "test-secret-for-ci-build-only"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # AGENTS - Python
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  agents-lint:
    name: üêç Agents - Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: agents
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: agents/pyproject.toml

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruff mypy
          pip install -e ".[dev]" || pip install -e .

      - name: Run Ruff (lint)
        run: ruff check src/ || true
        continue-on-error: true

      - name: Run Ruff (format check)
        run: ruff format --check src/ || true
        continue-on-error: true

  agents-test:
    name: üß™ Agents - Test
    runs-on: ubuntu-latest
    needs: agents-lint
    defaults:
      run:
        working-directory: agents
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: agents/pyproject.toml

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          pip install -e ".[dev]" || pip install -e .

      - name: Run tests
        run: pytest tests/ -v --cov=src --cov-report=xml || true
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY_TEST }}
          AURACORE_API_URL: "http://localhost:3000"

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: agents/coverage.xml
          flags: agents
          fail_ci_if_error: false
        continue-on-error: true

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # SUMMARY
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ci-summary:
    name: üìä CI Summary
    runs-on: ubuntu-latest
    needs: [frontend-typecheck, frontend-quality, frontend-lint, frontend-test, frontend-build, agents-lint, agents-test]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend (Next.js)" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | TypeCheck (TSG-001) | ${{ needs.frontend-typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Code Quality (as any) | ${{ needs.frontend-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | ESLint | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Unit Tests | ${{ needs.frontend-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Build | ${{ needs.frontend-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agents (Python)" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.agents-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.agents-test.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: |
          needs.frontend-typecheck.result == 'failure' ||
          needs.frontend-lint.result == 'failure' ||
          needs.frontend-test.result == 'failure' ||
          needs.frontend-build.result == 'failure'
        run: |
          echo "‚ùå Critical CI gates failed"
          echo "TypeCheck: ${{ needs.frontend-typecheck.result }}"
          echo "Lint: ${{ needs.frontend-lint.result }}"
          echo "Tests: ${{ needs.frontend-test.result }}"
          echo "Build: ${{ needs.frontend-build.result }}"
          exit 1

