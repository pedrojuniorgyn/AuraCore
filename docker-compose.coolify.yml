services:
  sql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: "Y"
      # ✅ Importante: usar aspas para não quebrar com caracteres especiais
      MSSQL_SA_PASSWORD: "${DB_PASSWORD}"
      MSSQL_PID: "Developer"
    volumes:
      - sql_data:/var/opt/mssql
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - sql
    environment:
      # ✅ O app deve falar com o serviço "sql" dentro da rede do compose
      DB_HOST: "sql"
      DB_PORT: "${DB_PORT:-1433}"
      DB_USER: "${DB_USER:-sa}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME:-AuraCore}"
      # Pass-through úteis (defina no Coolify Environment Variables)
      NODE_ENV: "${NODE_ENV:-production}"
      APP_URL: "${APP_URL}"
      NEXTAUTH_URL: "${NEXTAUTH_URL}"
      AUTH_SECRET: "${AUTH_SECRET}"
      AUTH_TRUST_HOST: "${AUTH_TRUST_HOST:-true}"
      AUTH_GOOGLE_ID: "${AUTH_GOOGLE_ID}"
      AUTH_GOOGLE_SECRET: "${AUTH_GOOGLE_SECRET}"
      AUTH_GOOGLE_ALLOWED_DOMAINS: "${AUTH_GOOGLE_ALLOWED_DOMAINS}"
      ENABLE_CRON: "${ENABLE_CRON:-false}"
      DB_ENCRYPT: "${DB_ENCRYPT:-false}"
      DB_TRUST_CERT: "${DB_TRUST_CERT:-true}"
    expose:
      - "3000"
    restart: unless-stopped

volumes:
  sql_data:

