{
  "id": "repository-pattern",
  "version": "2.0.0",
  "title": "Repository Pattern Contract",
  "description": "Padrão para implementação de Repositories",
  "category": "infrastructure",
  "severity": "high",
  "rules": [
    {
      "id": "REPO-001",
      "title": "Interface em domain/ports/output/",
      "description": "Interface do Repository deve estar em domain/ports/output/",
      "pattern": "domain/ports/output/I*Repository.ts",
      "severity": "high",
      "message": "Interface do Repository deve estar em domain/ports/output/"
    },
    {
      "id": "REPO-002",
      "title": "Implementação em infrastructure/",
      "description": "Implementação deve estar em infrastructure/persistence/repositories/",
      "pattern": "infrastructure/persistence/repositories/Drizzle*Repository.ts",
      "severity": "high",
      "message": "Implementação deve estar em infrastructure/persistence/repositories/"
    },
    {
      "id": "REPO-003",
      "title": "Implementa interface do domain",
      "description": "Repository deve implementar interface de domain/ports/output/",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "required_patterns": ["implements I"],
      "severity": "critical",
      "message": "Repository deve implementar interface do domain"
    },
    {
      "id": "REPO-004",
      "title": "Usa Mapper para conversão bidirecional",
      "description": "Repository DEVE usar Mapper para converter Domain <-> Persistence em AMBAS direções",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "required_patterns": ["Mapper.toDomain(", "Mapper.toPersistence("],
      "severity": "high",
      "message": "Repository DEVE usar Mapper.toDomain() E Mapper.toPersistence(). Ambos são obrigatórios para conversão bidirecional.",
      "rationale": "Sem conversão bidirecional completa, o repository não consegue ler E escrever entidades corretamente.",
      "notes": [
        "toDomain() - converte row do banco para Entity",
        "toPersistence() - converte Entity para row de INSERT/UPDATE",
        "AMBOS são obrigatórios em todo Repository"
      ]
    },
    {
      "id": "REPO-005",
      "title": "Filtra por multi-tenancy",
      "description": "Toda query deve filtrar por organizationId e branchId",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "required_patterns": ["organizationId", "branchId"],
      "severity": "critical",
      "message": "Repository DEVE filtrar por organizationId e branchId"
    },
    {
      "id": "REPO-006",
      "title": "Soft delete",
      "description": "Repository deve filtrar deletedAt IS NULL por padrão",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "required_patterns": ["deletedAt"],
      "severity": "high",
      "message": "Repository deve considerar soft delete (deletedAt)"
    },
    {
      "id": "REPO-007",
      "title": "UPSERT pattern",
      "description": "save() deve usar upsert (onConflictDoUpdate)",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "required_patterns": ["onConflictDoUpdate"],
      "severity": "medium",
      "message": "save() deve usar UPSERT para idempotência"
    },
    {
      "id": "REPO-008",
      "title": "Transações",
      "description": "Operações múltiplas devem usar transação",
      "severity": "high",
      "message": "Operações múltiplas devem usar transação"
    },
    {
      "id": "REPO-009",
      "title": "Paginação em findMany",
      "description": "findMany() deve suportar paginação",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "required_patterns": ["limit", "offset"],
      "severity": "high",
      "message": "findMany() deve suportar paginação (limit/offset)"
    },
    {
      "id": "REPO-010",
      "title": "Retorna Domain Entity",
      "description": "Repository retorna Domain Entity, não row do banco",
      "severity": "critical",
      "message": "Repository deve retornar Domain Entity, não row do banco"
    },
    {
      "id": "REPO-011",
      "title": "@injectable() decorator",
      "description": "Repository deve ter @injectable() decorator",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "required_patterns": ["@injectable()"],
      "severity": "high",
      "message": "Repository deve ter @injectable() decorator"
    },
    {
      "id": "REPO-012",
      "title": "Nomenclatura Drizzle*Repository",
      "description": "Repository deve seguir padrão Drizzle{Entity}Repository",
      "pattern": "infrastructure/persistence/repositories/*.ts",
      "severity": "medium",
      "message": "Repository deve seguir padrão Drizzle{Entity}Repository"
    }
  ]
}

