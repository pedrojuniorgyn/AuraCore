{
  "epic": "E8",
  "corrections": [
    {
      "id": "LC-702579",
      "date": "2026-01-20",
      "epic": "E8",
      "error": "list_integrations endpoint não passava branch_id para o hub, violando regra ARCH-006 de multi-tenancy obrigatório",
      "correction": "Adicionado branch_id=auth[\"branch_id\"] na chamada hub.list_integrations() para garantir filtragem por filial",
      "files_affected": [
        "agents/src/api/integrations.py"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-113889",
      "date": "2026-01-20",
      "epic": "E8",
      "error": "DurationTracker.__aexit__ usa self._start_time sem verificar se é None. Se __aenter__ falhar ou não for chamado, __aexit__ crashará com TypeError: unsupported operand type(s) for -: 'float' and 'NoneType'",
      "correction": "Adicionado null check para _start_time antes de calcular duration. Se _start_time é None, usa 0.0 como fallback e emite warning via logger",
      "files_affected": [
        "agents/src/services/analytics/event_tracker.py"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-406747",
      "date": "2026-02-05",
      "epic": "E8",
      "error": "Schema OKR estava correto mas faltava: 1) Migration SQL para criar tabelas no banco 2) Variável timestampMap definida dentro de if mas usada fora 3) Tipo de retorno do Mapper incompatível com id opcional de KeyResult",
      "correction": "1) Criada migration 0062_create_strategic_okr.sql com tabelas e índices 2) Movida variável timestampMap para escopo externo do if 3) Corrigido tipo de retorno do toPersistence para permitir id: string | undefined",
      "files_affected": [
        "drizzle/migrations/0062_create_strategic_okr.sql",
        "src/modules/strategic/okr/infrastructure/persistence/repositories/DrizzleOkrRepository.ts",
        "src/modules/strategic/okr/infrastructure/persistence/mappers/OkrMapper.ts",
        "src/modules/strategic/okr/infrastructure/persistence/schemas/okr.schema.ts",
        "src/modules/strategic/okr/infrastructure/persistence/schemas/index.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-755363",
      "date": "2026-02-05",
      "epic": "E8",
      "error": "PUT /api/admin/roles/[id]/permissions aceitava array permissionIds sem validar se IDs existem na tabela permissions, causando potenciais violações de foreign key ou dados órfãos",
      "correction": "Adicionada validação com inArray() que verifica se todos IDs existem antes de modificar role_permissions. Retorna 400 com lista de invalidIds se algum ID não existe",
      "files_affected": [
        "src/app/api/admin/roles/[id]/permissions/route.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    }
  ]
}