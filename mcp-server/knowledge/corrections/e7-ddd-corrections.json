{
  "epic": "E7-DDD",
  "corrections": [
    {
      "id": "LC-041712",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.0: Setup + Infraestrutura de Testes - Criar estrutura base para migra√ß√£o DDD/Hexagonal H√≠brido",
      "correction": "Estrutura modular criada (src/modules/{financial,accounting,fiscal,tms,wms} + src/shared/domain + infrastructure + tests/), tsyringe configurado com TOKENS e container, Result<T,E> pattern implementado, AggregateRoot/Entity/ValueObject/DomainEvent/DomainError classes base implementadas, Vitest configurado com 80% coverage threshold + setup helpers + InMemoryRepository base, scripts npm (test, test:ui, test:coverage, test:watch) adicionados",
      "files_affected": [
        "src/shared/domain/types/Result.ts",
        "src/shared/domain/entities/AggregateRoot.ts",
        "src/shared/domain/entities/Entity.ts",
        "src/shared/domain/entities/ValueObject.ts",
        "src/shared/domain/events/DomainEvent.ts",
        "src/shared/domain/errors/DomainError.ts",
        "src/shared/infrastructure/di/tokens.ts",
        "src/shared/infrastructure/di/container.ts",
        "src/shared/infrastructure/di/index.ts",
        "src/shared/domain/index.ts",
        "src/shared/index.ts",
        "vitest.config.ts",
        "tests/setup.ts",
        "tests/helpers/mocks/repositories/InMemoryRepository.ts",
        "package.json"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-262670",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.1 Parcial: Value Objects Money, CNPJ, Email com testes completos + corre√ß√µes de ambiente (crypto.randomUUID fallback, vitest node_modules exclusion, Email trim)",
      "correction": "Implementados 3 Value Objects com TDD: Money (22 testes - opera√ß√µes monet√°rias, formata√ß√£o pt-BR, convers√£o cents), CNPJ (10 testes - valida√ß√£o d√≠gitos verificadores brasileiros), Email (12 testes - valida√ß√£o formato, domain, localPart). Corrigido crypto.randomUUID em DomainEvent com fallback para getRandomValues e Math.random. Corrigido vitest.config para excluir node_modules. Corrigido Email para trim ANTES de validar. 100% type-safe, zero any, todas interfaces satisfazem Record<string, unknown> constraint.",
      "files_affected": [
        "src/shared/domain/value-objects/Money.ts",
        "src/shared/domain/value-objects/CNPJ.ts",
        "src/shared/domain/value-objects/Email.ts",
        "src/shared/domain/value-objects/index.ts",
        "src/shared/domain/events/DomainEvent.ts",
        "tests/unit/shared/value-objects/Money.test.ts",
        "tests/unit/shared/value-objects/CNPJ.test.ts",
        "tests/unit/shared/value-objects/Email.test.ts",
        "vitest.config.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-662125",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.0 + E7.1 COMPLETOS: Setup + Shared Kernel + Value Objects + Documenta√ß√£o Arquitetural - Marco hist√≥rico da funda√ß√£o DDD do AuraCore",
      "correction": "Infraestrutura DDD completa criada: Result<T,E> pattern, AggregateRoot, Entity, ValueObject, DomainEvent (com generateUUID fallback), DomainError hierarchy. Value Objects implementados com TDD: Money (25 testes - opera√ß√µes monet√°rias, formata√ß√£o pt-BR, convers√£o cents, bug Money.zero() corrigido), CNPJ (10 testes - valida√ß√£o d√≠gitos verificadores brasileiros), Email (12 testes - valida√ß√£o formato, lowercase, trim). Vitest configurado (80% coverage threshold), InMemoryRepository helper criado. Documenta√ß√£o arquitetural completa de 376 linhas (E7_DDD_HEXAGONAL_HIBRIDO.md) com filosofia h√≠brida, estrutura de pastas, camadas, cronograma 21 semanas, estrat√©gia de testes. 100% type-safe, zero any, TDD aplicado, 47 testes passando.",
      "files_affected": [
        "src/shared/domain/types/Result.ts",
        "src/shared/domain/entities/AggregateRoot.ts",
        "src/shared/domain/entities/Entity.ts",
        "src/shared/domain/entities/ValueObject.ts",
        "src/shared/domain/events/DomainEvent.ts",
        "src/shared/domain/errors/DomainError.ts",
        "src/shared/domain/value-objects/Money.ts",
        "src/shared/domain/value-objects/CNPJ.ts",
        "src/shared/domain/value-objects/Email.ts",
        "src/shared/domain/value-objects/index.ts",
        "src/shared/domain/index.ts",
        "src/shared/infrastructure/di/tokens.ts",
        "src/shared/infrastructure/di/container.ts",
        "src/shared/infrastructure/di/index.ts",
        "src/shared/index.ts",
        "tests/setup.ts",
        "tests/helpers/mocks/repositories/InMemoryRepository.ts",
        "tests/unit/shared/value-objects/Money.test.ts",
        "tests/unit/shared/value-objects/CNPJ.test.ts",
        "tests/unit/shared/value-objects/Email.test.ts",
        "vitest.config.ts",
        "docs/architecture/E7_DDD_HEXAGONAL_HIBRIDO.md",
        "package.json"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-021765",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.1 100% COMPLETO: Todos os 6 Value Objects implementados com TDD - Shared Kernel robusto",
      "correction": "CPF (13 testes - valida√ß√£o brasileira com d√≠gitos verificadores, formata√ß√£o XXX.XXX.XXX-XX), DateRange (18 testes - intervalos de data com overlaps, contains, encompasses, duration em dias/meses), TaxRate (24 testes - taxas 0-100%, factories para impostos brasileiros IRRF/PIS/COFINS/CSLL/ISS, c√°lculo sobre Money). Total E7.1: 6 Value Objects (Money, CNPJ, CPF, Email, DateRange, TaxRate), 102 testes passando, 100% type-safe, zero any, TDD aplicado.",
      "files_affected": [
        "src/shared/domain/value-objects/CPF.ts",
        "src/shared/domain/value-objects/DateRange.ts",
        "src/shared/domain/value-objects/TaxRate.ts",
        "src/shared/domain/value-objects/index.ts",
        "src/shared/domain/index.ts",
        "tests/unit/shared/value-objects/CPF.test.ts",
        "tests/unit/shared/value-objects/DateRange.test.ts",
        "tests/unit/shared/value-objects/TaxRate.test.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-831547",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.1 MARCO: Shared Kernel 100% completo - 6 Value Objects, 102 testes, base DDD s√≥lida",
      "correction": "Money (25 testes), CNPJ (10), CPF (13), Email (12), DateRange (18), TaxRate (24). Factories brasileiras implementadas: IRRF (1.5%), PIS (0.65%), COFINS (3%), CSLL (1%), ISS (customiz√°vel). Infraestrutura DDD completa: Result<T,E> pattern, AggregateRoot, Entity, ValueObject, DomainEvent (com generateUUID fallback), DomainError hierarchy. Vitest configurado (80% threshold), InMemoryRepository, 100% type-safe. Base s√≥lida para E7.2 Financial e demais m√≥dulos de neg√≥cio.",
      "files_affected": [
        "src/shared/domain/value-objects/Money.ts",
        "src/shared/domain/value-objects/CNPJ.ts",
        "src/shared/domain/value-objects/CPF.ts",
        "src/shared/domain/value-objects/Email.ts",
        "src/shared/domain/value-objects/DateRange.ts",
        "src/shared/domain/value-objects/TaxRate.ts",
        "src/shared/domain/types/Result.ts",
        "src/shared/domain/entities/AggregateRoot.ts",
        "src/shared/domain/entities/Entity.ts",
        "src/shared/domain/entities/ValueObject.ts",
        "src/shared/domain/events/DomainEvent.ts",
        "src/shared/domain/errors/DomainError.ts",
        "tests/unit/shared/value-objects/Money.test.ts",
        "tests/unit/shared/value-objects/CNPJ.test.ts",
        "tests/unit/shared/value-objects/CPF.test.ts",
        "tests/unit/shared/value-objects/Email.test.ts",
        "tests/unit/shared/value-objects/DateRange.test.ts",
        "tests/unit/shared/value-objects/TaxRate.test.ts",
        "vitest.config.ts",
        "docs/architecture/E7_DDD_HEXAGONAL_HIBRIDO.md"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-652573",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.2 Semana 1: Domain Entities Financial - AccountPayable, Payment, PaymentTerms com comportamento rico e testes",
      "correction": "Aggregate Root AccountPayable com ciclo de vida completo (OPEN‚ÜíPROCESSING‚ÜíPARTIAL‚ÜíPAID/CANCELLED), registerPayment() com valida√ß√µes e eventos, cancel() com propaga√ß√£o para payments. Entity Payment com confirm()/cancel(). Value Object PaymentTerms com c√°lculo autom√°tico de multa (2% default), juros pro-rata di√°rio (1%/m√™s default), desconto por antecipa√ß√£o. Domain Events: PayableCreatedEvent, PaymentCompletedEvent, PayableCancelledEvent. Repository Interface IPayableRepository (Port) com m√©todos CRUD + findOverdue. 7 testes unit√°rios passando com TDD. Bug corrigido: teste usava data vencida causando c√°lculo de multa/juros inesperado.",
      "files_affected": [
        "src/modules/financial/domain/entities/AccountPayable.ts",
        "src/modules/financial/domain/entities/Payment.ts",
        "src/modules/financial/domain/entities/index.ts",
        "src/modules/financial/domain/value-objects/PaymentTerms.ts",
        "src/modules/financial/domain/value-objects/index.ts",
        "src/modules/financial/domain/events/PayableEvents.ts",
        "src/modules/financial/domain/events/index.ts",
        "src/modules/financial/domain/errors/FinancialErrors.ts",
        "src/modules/financial/domain/errors/index.ts",
        "src/modules/financial/domain/ports/output/IPayableRepository.ts",
        "src/modules/financial/domain/ports/output/index.ts",
        "src/modules/financial/domain/index.ts",
        "tests/unit/modules/financial/domain/entities/AccountPayable.test.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-069209",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.2 SEMANA 2 MARCO: Application Layer completa - 5 Use Cases, 3 DTOs, multi-tenancy, 11 testes",
      "correction": "CreatePayableUseCase, PayAccountPayableUseCase, CancelPayableUseCase, ListPayablesUseCase, GetPayableByIdUseCase. DTOs com Zod validation. ExecutionContext para multi-tenancy. Branch scoping (admin vs user). Dependency Injection com tsyringe. 11 testes passando.",
      "files_affected": [
        "src/modules/financial/application/use-cases/CreatePayableUseCase.ts",
        "src/modules/financial/application/use-cases/PayAccountPayableUseCase.ts",
        "src/modules/financial/application/use-cases/CancelPayableUseCase.ts",
        "src/modules/financial/application/use-cases/ListPayablesUseCase.ts",
        "src/modules/financial/application/use-cases/GetPayableByIdUseCase.ts",
        "src/modules/financial/application/dtos/CreatePayableDTO.ts",
        "src/modules/financial/application/dtos/PayAccountPayableDTO.ts",
        "src/modules/financial/application/dtos/PayableResponseDTO.ts"
      ],
      "pattern_created": "E7.2 Week 2 Complete - Application Layer Marco",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-900194",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.2 Semana 3: Infrastructure Layer - DrizzlePayableRepository, Mapper, EventDispatcher, DI Module",
      "correction": "DrizzlePayableRepository implementa IPayableRepository com Drizzle ORM. PayableMapper converte Domain<->Persistence. DomainEventDispatcher para eventos. FinancialModule registra todas depend√™ncias no container tsyringe. Schemas Drizzle para accounts_payable e payments. Usado char(36) para UUIDs ao inv√©s de uniqueIdentifier. Usado sql`GETDATE()` ao inv√©s de defaultNow(). Usado queryPaginated helper para .limit(). Implementado upsert manual (check + update/insert) pois mssql n√£o suporta onConflictDoUpdate. 3 testes do Mapper passando.",
      "files_affected": [
        "src/modules/financial/infrastructure/persistence/DrizzlePayableRepository.ts",
        "src/modules/financial/infrastructure/persistence/PayableMapper.ts",
        "src/modules/financial/infrastructure/persistence/PayableSchema.ts",
        "src/modules/financial/infrastructure/events/DomainEventDispatcher.ts",
        "src/modules/financial/infrastructure/di/FinancialModule.ts",
        "tests/unit/modules/financial/infrastructure/persistence/PayableMapper.test.ts"
      ],
      "pattern_created": "E7.2 Week 3 - Infrastructure Layer with Repository, Mapper, Events, DI",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-514123",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.2 SEMANA 3 MARCO: Infrastructure Layer completa - DrizzlePayableRepository, PayableMapper, DomainEventDispatcher, FinancialModule DI",
      "correction": "DrizzlePayableRepository implementa IPayableRepository com Drizzle ORM + SQL Server. PayableMapper converte Domain<->Persistence. DomainEventDispatcher para eventos de dom√≠nio. FinancialModule registra depend√™ncias no tsyringe. Upsert manual (mssql), queryPaginated helper. 33 testes passando.",
      "files_affected": [
        "src/modules/financial/infrastructure/persistence/DrizzlePayableRepository.ts",
        "src/modules/financial/infrastructure/persistence/PayableMapper.ts",
        "src/modules/financial/infrastructure/persistence/PayableSchema.ts",
        "src/modules/financial/infrastructure/events/DomainEventDispatcher.ts",
        "src/modules/financial/infrastructure/di/FinancialModule.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-240782",
      "date": "2025-12-28",
      "epic": "E7-DDD",
      "error": "E7.2 SEMANA 4 FINAL: Presentation Layer - API Routes, Controller, Bootstrap. M√≥dulo Financial COMPLETO!",
      "correction": "PayablesController com 5 m√©todos (create, list, getById, pay, cancel). API Routes Next.js em /api/v2/financial/payables. Bootstrap para inicializa√ß√£o do m√≥dulo. Error handling centralizado. Multi-tenancy via ExecutionContext. E7.2 Financial 100% completo - todas as 4 camadas Hexagonal implementadas.",
      "files_affected": [
        "src/modules/financial/presentation/controllers/PayablesController.ts",
        "src/modules/financial/presentation/bootstrap.ts",
        "src/app/api/v2/financial/payables/route.ts",
        "src/app/api/v2/financial/payables/[id]/route.ts",
        "src/app/api/v2/financial/payables/[id]/pay/route.ts",
        "src/app/api/v2/financial/payables/[id]/cancel/route.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-106509",
      "date": "2025-12-29",
      "epic": "E7-DDD",
      "error": "await em fun√ß√£o s√≠ncrona resolveBranchIdOrThrow - Agent Review detectou",
      "correction": "Removido await de resolveBranchIdOrThrow que retorna number (s√≠ncrono), n√£o Promise. Todas outras usages no codebase est√£o corretas sem await.",
      "files_affected": [
        "src/modules/financial/presentation/controllers/PayablesController.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-214560",
      "date": "2025-12-29",
      "epic": "E7-DDD",
      "error": "handleError n√£o preservava NextResponse de auth/branch - convertia 401/403/400 para 500",
      "correction": "Adicionado check 'if (error instanceof Response) return error;' no in√≠cio de handleError para preservar NextResponse lan√ßados por getTenantContext e resolveBranchIdOrThrow. Return types atualizados para NextResponse | Response. Padr√£o j√° usado em outros endpoints do AuraCore.",
      "files_affected": [
        "src/modules/financial/presentation/controllers/PayablesController.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-631357",
      "date": "2025-12-29",
      "epic": "E7-DDD",
      "error": "üèÜ E7.2 FINANCIAL MODULE COMPLETO - Marco Final ap√≥s 4 semanas",
      "correction": "M√≥dulo Financial enterprise-ready com Arquitetura Hexagonal completa. 4 camadas: Domain (19 testes, 6 invariantes, 6 bugs corrigidos), Application (11 testes, 5 use cases), Infrastructure (3 testes, repository, mapper, events), Presentation (5 API routes, controller, bootstrap). Total: 33+ testes, 0 TypeScript errors, 0 cursor issues. 2 bugs cr√≠ticos corrigidos no Agent Review final: await sync function e Response preservation.",
      "files_affected": [
        "src/modules/financial/domain/",
        "src/modules/financial/application/",
        "src/modules/financial/infrastructure/",
        "src/modules/financial/presentation/",
        "src/app/api/v2/financial/payables/"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-679075",
      "date": "2025-12-29",
      "epic": "E7-DDD",
      "error": "E7.3 Semana 3: Infrastructure Layer Accounting - DrizzleJournalEntryRepository com saveMany, JournalEntryMapper (Domain<->Persistence), AccountingModule (DI), Drizzle schemas. Seguiu padr√£o Financial Module. Total: 36 testes passando (Domain 25 + Application 7 + Infrastructure 4), 0 TypeScript errors, 0 cursor issues.",
      "correction": "DrizzleJournalEntryRepository implementa IJournalEntryRepository com Drizzle ORM (findById, findMany com queryPaginated, save, saveMany, findByPeriod, findBySourceId, exists, nextEntryNumber). JournalEntryMapper converte Domain<->Persistence (toPersistence, toDomain, lineToPersistence, lineToDomain). Drizzle schemas mssqlTable para journal_entries e journal_entry_lines com sql`GETDATE()` defaults. AccountingModule registra depend√™ncias (Repository + 6 Use Cases) com tsyringe. √çndices exportam todos componentes. 4 testes Mapper passando. TODO: implementar db.transaction() em produ√ß√£o para saveMany.",
      "files_affected": [
        "src/modules/accounting/infrastructure/persistence/DrizzleJournalEntryRepository.ts",
        "src/modules/accounting/infrastructure/persistence/JournalEntryMapper.ts",
        "src/modules/accounting/infrastructure/persistence/JournalEntrySchema.ts",
        "src/modules/accounting/infrastructure/di/AccountingModule.ts",
        "src/modules/accounting/infrastructure/persistence/index.ts",
        "src/modules/accounting/infrastructure/di/index.ts",
        "src/modules/accounting/infrastructure/index.ts",
        "src/modules/accounting/index.ts",
        "tests/unit/modules/accounting/infrastructure/persistence/JournalEntryMapper.test.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-606846",
      "date": "2025-12-29",
      "epic": "E7-DDD",
      "error": "2 bugs cr√≠ticos: (1) saveMany sem db.transaction() violando .cursorrules - m√∫ltiplas opera√ß√µes (SELECT, INSERT, UPDATE, DELETE) sem atomicidade, (2) linhas removidas do JournalEntry aggregate via removeLine() n√£o eram deletadas do banco, causando inconsist√™ncia entre domain e persistence",
      "correction": "Bug 1: Adicionado db.transaction() (Drizzle nativo) envolvendo todas opera√ß√µes do saveMany(), garantindo atomicidade (all-or-nothing) para estornos e updates. Bug 2: Implementada sincroniza√ß√£o de linhas - ap√≥s update do entry, deletar linhas √≥rf√£s (que existem no DB mas n√£o no aggregate) usando notInArray(). Se aggregate n√£o tem linhas, deletar todas. Adicionado notInArray ao import do drizzle-orm. Repository agora mant√©m consist√™ncia total entre domain model e database state.",
      "files_affected": [
        "src/modules/accounting/infrastructure/persistence/DrizzleJournalEntryRepository.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-926373",
      "date": "2025-12-29",
      "epic": "E7-DDD",
      "error": "findByPeriod retorna JournalEntry sem linhas (array vazio no mapper) - inconsist√™ncia com findById que busca linhas corretamente. Causava entries incompletos onde linhas cont√°beis eram perdidas, quebrando l√≥gica de neg√≥cio que depende das linhas.",
      "correction": "findByPeriod agora busca linhas em batch usando inArray() ap√≥s buscar os entries, agrupa linhas por entry usando Map, e passa linhas corretas para o mapper. Segue exatamente o mesmo padr√£o de findMany(). Early return se rows.length === 0. Garante que entries retornados sempre t√™m suas linhas completas.",
      "files_affected": [
        "src/modules/accounting/infrastructure/persistence/DrizzleJournalEntryRepository.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    }
  ]
}