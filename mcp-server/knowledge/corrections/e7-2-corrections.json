{
  "epic": "E7.2",
  "corrections": [
    {
      "id": "LC-049580",
      "date": "2025-12-28",
      "epic": "E7.2",
      "error": "Bug de Consistência de Estado: registerPayment() calculava status baseado no valor do pagamento sendo adicionado, mas totalPaid só contava pagamentos CONFIRMED. Isso criava inconsistência onde status podia ser PAID mas totalPaid = 0 se o pagamento fosse PENDING.",
      "correction": "Implementada abordagem híbrida DDD: (1) registerPayment() aceita PENDING/CONFIRMED mas valida projeção; (2) _recalculateStatus() garante que status sempre reflete totalPaid (apenas CONFIRMED); (3) Adicionados métodos confirmPayment() e cancelPayment() que recalculam status; (4) totalPaid getter filtra apenas CONFIRMED. Garantia de consistência: status = f(totalPaid CONFIRMED).",
      "files_affected": [
        "src/modules/financial/domain/entities/AccountPayable.ts",
        "tests/unit/modules/financial/domain/entities/AccountPayable.test.ts"
      ],
      "pattern_created": "DDD State Consistency Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-545451",
      "date": "2025-12-28",
      "epic": "E7.2",
      "error": "Bug no getter remainingAmount: quando calculateTotalDue() sucedia mas subtract() falhava, o método retornava terms.amount (valor original) em vez de totalDueResult.value (com multa/juros). Para payables vencidos com multa e juros acumulados, isso retornava valor incorreto, causando inconsistências contábeis.",
      "correction": "Corrigido getter remainingAmount para retornar totalDue (com multa/juros) em caso de falha no subtract(), em vez de terms.amount (original). Adicionados 3 testes: (1) remainingAmount para payable não pago; (2) remainingAmount após pagamento parcial; (3) remainingAmount incluindo multa e juros para payables vencidos. Garante integridade contábil.",
      "files_affected": [
        "src/modules/financial/domain/entities/AccountPayable.ts",
        "tests/unit/modules/financial/domain/entities/AccountPayable.test.ts"
      ],
      "pattern_created": "DDD Getter Fallback Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-930045",
      "date": "2025-12-28",
      "epic": "E7.2",
      "error": "Bug em cancel(): método ignorava o resultado de payment.cancel() ao iterar pelos pagamentos. Pior ainda, permitia cancelar payables com pagamentos CONFIRMED (status PARTIAL), violando invariante de domínio que payables cancelados não devem ter transações confirmadas. Isso criava inconsistência: payable CANCELLED com payments CONFIRMED.",
      "correction": "Adicionada validação em cancel() para verificar se há pagamentos CONFIRMED antes de permitir cancelamento. Se houver, retorna erro informativo com quantidade e valor total. Fluxo correto agora é: estornar pagamentos primeiro → depois cancelar payable. Adicionados 2 testes: (1) rejeitar cancelamento com CONFIRMED payments; (2) permitir cancelamento com apenas PENDING payments. Invariante de cancelamento agora protegida.",
      "files_affected": [
        "src/modules/financial/domain/entities/AccountPayable.ts",
        "tests/unit/modules/financial/domain/entities/AccountPayable.test.ts"
      ],
      "pattern_created": "DDD Cancel Invariant Protection Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-208327",
      "date": "2025-12-28",
      "epic": "E7.2",
      "error": "E7.2 SEMANA 1 FINAL: Domain Layer Financial completo - 6 bugs críticos corrigidos durante Agent Review, 19 testes unitários, 6 invariantes de domínio protegidas. Tactical DDD aplicado com Aggregate Root, Entities, Value Objects, Domain Events, Domain Errors e Repository Port.",
      "correction": "AccountPayable Aggregate Root (290 linhas) com ciclo de vida completo (OPEN→PROCESSING→PARTIAL→PAID/CANCELLED). Payment Entity (129 linhas) com estados PENDING/CONFIRMED/CANCELLED. PaymentTerms Value Object (143 linhas) com cálculo de multa e juros. 6 bugs Agent Review corrigidos: (1) supplierId validation - data integrity; (2) OverpaymentError semantic - domain correctness; (3) dead code removal - code quality; (4) state consistency status/totalPaid - DDD core principle CRÍTICO; (5) remainingAmount fallback - accounting integrity CRÍTICO; (6) cancel with CONFIRMED payments - invariant protection CRÍTICO. 19 testes TDD passando. 6 invariantes garantidas. Qualidade enterprise DDD alcançada.",
      "files_affected": [
        "src/modules/financial/domain/entities/AccountPayable.ts",
        "src/modules/financial/domain/entities/Payment.ts",
        "src/modules/financial/domain/value-objects/PaymentTerms.ts",
        "src/modules/financial/domain/events/PayableEvents.ts",
        "src/modules/financial/domain/errors/FinancialErrors.ts",
        "src/modules/financial/domain/ports/output/IPayableRepository.ts",
        "tests/unit/modules/financial/domain/entities/AccountPayable.test.ts"
      ],
      "pattern_created": "E7.2 Week 1 Complete - Enterprise DDD Financial Domain",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-216949",
      "date": "2025-12-28",
      "epic": "E7.2",
      "error": "E7.2 Semana 2: Application Layer - 5 Use Cases com DTOs, Zod validation, multi-tenancy, DI com tsyringe. Habilitado experimentalDecorators e emitDecoratorMetadata no tsconfig.json. Adicionado reflect-metadata no tests/setup.ts. 11 testes unitários passando.",
      "correction": "CreatePayableUseCase, PayAccountPayableUseCase, CancelPayableUseCase, ListPayablesUseCase, GetPayableByIdUseCase. DTOs com Zod schemas (CreatePayableDTO, PayAccountPayableDTO, PayableResponseDTO). ExecutionContext para multi-tenancy (userId, organizationId, branchId, isAdmin). Mapper toPayableResponseDTO. Branch scoping com validação admin vs user. Dependency Injection com tsyringe usando @injectable e @inject. Validação Zod com error.issues.map(e => e.path.join('.')). Import type para interfaces em decorators. PaginatedPayablesDTO para listagem. tsconfig.json atualizado com experimentalDecorators e emitDecoratorMetadata. tests/setup.ts com import 'reflect-metadata'.",
      "files_affected": [
        "src/modules/financial/application/use-cases/CreatePayableUseCase.ts",
        "src/modules/financial/application/use-cases/PayAccountPayableUseCase.ts",
        "src/modules/financial/application/use-cases/CancelPayableUseCase.ts",
        "src/modules/financial/application/use-cases/ListPayablesUseCase.ts",
        "src/modules/financial/application/use-cases/GetPayableByIdUseCase.ts",
        "src/modules/financial/application/use-cases/BaseUseCase.ts",
        "src/modules/financial/application/dtos/CreatePayableDTO.ts",
        "src/modules/financial/application/dtos/PayAccountPayableDTO.ts",
        "src/modules/financial/application/dtos/PayableResponseDTO.ts",
        "tests/unit/modules/financial/application/use-cases/CreatePayableUseCase.test.ts",
        "tests/unit/modules/financial/application/use-cases/PayAccountPayableUseCase.test.ts",
        "tsconfig.json",
        "tests/setup.ts"
      ],
      "pattern_created": "E7.2 Week 2 - Application Layer with Use Cases, DTOs, and DI",
      "status": "APPROVED",
      "must_not_repeat": true
    }
  ]
}