{
  "epic": "E7.15",
  "corrections": [
    {
      "id": "LC-781212",
      "date": "2026-01-07",
      "epic": "E7.15",
      "error": "Interface FiscalDocumentItemRow.net_amount não correspondia à coluna real total_value do banco, causando falha na query SQL do accounting engine",
      "correction": "Revertida correção errada anterior. Alinhado interface (total_value), query SQL (fdi.total_value) e código (item.total_value) com schema real verificado em FiscalDocumentSchema.ts",
      "files_affected": [
        "src/services/accounting-engine.ts"
      ],
      "pattern_created": "VAT-001: Verificar schema real antes de corrigir tipos",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-579143",
      "date": "2026-01-07",
      "epic": "E7.15",
      "error": "Correções ping-pong entre total_value e net_amount devido a schemas conflitantes (ativo vs obsoleto) após migração DDD+Hexagonal. Schema ativo (src/lib/db/schema/accounting.ts) define net_amount, mas schema obsoleto (src/modules/fiscal/.../FiscalDocumentSchema.ts) define total_value",
      "correction": "Investigação completa identificou schema ativo através de src/lib/db/schema.ts. Verificados 20+ arquivos usando net_amount. Aplicada correção definitiva alinhando interface, query SQL e código com net_amount conforme schema ativo",
      "files_affected": [
        "src/services/accounting-engine.ts"
      ],
      "pattern_created": "VAT-012: Schema ativo tem precedência - verificar src/lib/db/schema.ts",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-053509",
      "date": "2026-01-08",
      "epic": "E7.15",
      "error": "Stale closure em useEffect - expandedGroups sempre [] dentro do effect porque não estava nas deps. Causava setState desnecessário a cada mudança de pathname.",
      "correction": "Usar functional update setExpandedGroups(prev => ...) para acessar valor atual sem depender de closure. Adicionar setTimeout para evitar cascading renders (ESLint rule react-hooks/set-state-in-effect).",
      "files_affected": [
        "src/components/layout/grouped-sidebar.tsx"
      ],
      "pattern_created": "React Hooks - Functional Update Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-053796",
      "date": "2026-01-08",
      "epic": "E7.15",
      "error": "new Date('') cria Invalid Date quando dhEmi/dEmi são undefined no XML da NFe. Causava datas inválidas em parcelas de pagamento.",
      "correction": "Validar issueDateStr antes de chamar parseNFeDate. Se undefined, usar new Date() como fallback. Garantir que parseNFeDate sempre recebe string válida.",
      "files_affected": [
        "src/services/nfe-parser.ts"
      ],
      "pattern_created": "Date Validation Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-492250",
      "date": "2026-01-10",
      "epic": "E7.15",
      "error": "Bug introduzido em categorias/page.tsx ao corrigir erro TypeScript. Interface FinancialCategory definia type: 'INCOME' | 'EXPENSE' mas o banco retornava 'REVENUE'. Ao corrigir o erro de comparação, removi REVENUE do filtro sem verificar uso no renderizador (linha 215), causando subcontagem no KPI de receitas.",
      "correction": "1. Atualizei interface para incluir REVENUE: type: 'INCOME' | 'REVENUE' | 'EXPENSE'\n2. Restaurei filtro original: c.type === 'INCOME' || c.type === 'REVENUE'\n3. Atualizei formData.type para incluir REVENUE\n4. Apliquei AP-002: Interface DEVE corresponder aos dados reais do banco",
      "files_affected": [
        "src/app/(dashboard)/financeiro/categorias/page.tsx"
      ],
      "pattern_created": "VERIFY-BEFORE-REMOVE: grep patterns before removing logic",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-985888",
      "date": "2026-01-13",
      "epic": "E7.15",
      "error": "Bug de segurança multi-tenancy introduzido ao corrigir erros TypeScript em JournalEntriesController.ts. O branchId foi removido da chamada ao ReverseJournalEntryUseCase, permitindo que usuários de uma filial revertessem lançamentos contábeis de outras filiais da mesma organização. Violação do AP-008: branchId opcional em contexto de segurança.",
      "correction": "1. Adicionado branchId: number à interface ReverseJournalEntryInput\n2. Adicionado validação no UseCase: if (entry.branchId !== BigInt(input.branchId)) return fail\n3. Adicionado branchId no controller: branchId: ctx.branchId\n4. Adicionado branchId na rota API: branchId: session.user.defaultBranchId com validação\n5. Convertido para BigInt na comparação para evitar type mismatch",
      "files_affected": [
        "src/modules/accounting/application/use-cases/ReverseJournalEntryUseCase.ts",
        "src/modules/accounting/presentation/controllers/JournalEntriesController.ts",
        "src/app/api/accounting/journal-entries/[id]/reverse/route.ts"
      ],
      "pattern_created": "VERIFY-BRANCH-ID: Never remove branchId when fixing TypeScript errors",
      "status": "APPROVED",
      "must_not_repeat": true
    }
  ]
}