{
  "epic": "E7.8",
  "corrections": [
    {
      "id": "LC-324023",
      "date": "2025-12-31",
      "epic": "E7.8",
      "error": "Bug 7: Movement/stock inconsistency - Movement was saved before stock was updated. If stock update failed, movement would exist without corresponding stock change, causing data inconsistency.",
      "correction": "Reordered operations to save stock BEFORE saving movement in RegisterStockEntry, RegisterStockExit, and TransferStock. This ensures that if any stock operation fails, the movement is never saved, maintaining data integrity.",
      "files_affected": [
        "src/modules/wms/application/use-cases/RegisterStockEntry.ts",
        "src/modules/wms/application/use-cases/RegisterStockExit.ts",
        "src/modules/wms/application/use-cases/TransferStock.ts"
      ],
      "pattern_created": "Stock-First Persistence Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-325920",
      "date": "2025-12-31",
      "epic": "E7.8",
      "error": "Bug 8: Silent cost calculation failures - When Money.create() failed during weighted average cost calculation, the error was silently ignored and stock was saved with incorrect (old) unit cost, causing financial data corruption.",
      "correction": "Changed all Money.create() calls for cost calculation to return Result.fail() immediately if the operation fails, instead of silently continuing. Weighted average cost is now calculated BEFORE modifying stock, and any failure prevents the entire operation from proceeding.",
      "files_affected": [
        "src/modules/wms/application/use-cases/RegisterStockEntry.ts",
        "src/modules/wms/application/use-cases/TransferStock.ts"
      ],
      "pattern_created": "Fail-Fast Cost Calculation Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-632694",
      "date": "2025-12-31",
      "epic": "E7.8",
      "error": "Bug 9: DI tokens removed from tokens.ts without verifying usage - Tokens for FiscalAccountingIntegration, Fiscal Use Cases (Create/Submit/Authorize/Cancel/CalculateTaxes), and EventDispatcher were removed, but FiscalModule.ts and FinancialModule.ts still referenced them, causing runtime DI resolution failures at application startup.",
      "correction": "Restored all removed tokens to tokens.ts. Verified all tokens used in any *Module.ts file are defined in tokens.ts. Added comments to organize tokens by module (Shared, Financial, Accounting, Fiscal, WMS) for better maintainability.",
      "files_affected": [
        "src/shared/infrastructure/di/tokens.ts"
      ],
      "pattern_created": "Complete DI Token Registry Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-798889",
      "date": "2025-12-31",
      "epic": "E7.8",
      "error": "Bug 10: CompleteInventoryCount violated Stock-First Pattern - Movement was saved at line 111 before stock was updated and saved at line 135. This contradicted the documented pattern and created risk of movement records existing without corresponding stock changes if stock save failed.",
      "correction": "Reordered persistence in CompleteInventoryCount to match pattern used in RegisterStockEntry, RegisterStockExit, and TransferStock. New order: 1) Update and save stock (line 133), 2) Save movement (line 136), 3) Save inventory count (line 147). This ensures movement only exists if stock was successfully updated, maintaining data integrity.",
      "files_affected": [
        "src/modules/wms/application/use-cases/CompleteInventoryCount.ts"
      ],
      "pattern_created": "Stock-First Persistence Pattern (CompleteInventoryCount)",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-583196",
      "date": "2026-01-01",
      "epic": "E7.8",
      "error": "Bug 11: StockItem.reconstitute() called validateInvariants() which rejected expired products, causing repository to return null for legitimately expired items in the database. This broke audit trails and prevented access to historical expired inventory data. Products appeared as 'not found' instead of 'expired'.",
      "correction": "Separated validation logic: create() validates expiration date and rejects new items with past dates; reconstitute() only validates structural invariants (quantity >= reserved, etc) and allows loading expired items from DB; added isExpired() public method for use cases to check expiration when needed; added validateStructuralInvariants() for data integrity checks without business rules. Repository now returns expired items successfully, and use cases decide if they can be used. Added test case to verify expired products can be reconstituted.",
      "files_affected": [
        "src/modules/wms/domain/entities/StockItem.ts",
        "tests/unit/modules/wms/domain/entities/StockItem.test.ts"
      ],
      "pattern_created": "Separate Create vs Reconstitute Validation Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-199195",
      "date": "2026-01-01",
      "epic": "E7.8",
      "error": "Bug 12: Date comparison using expirationDate < new Date() compared timestamps instead of calendar dates. Products with expiration date set to today at midnight were rejected after midnight on the same day, even though the calendar date hadn't passed yet.",
      "correction": "Added isDateInPast() static method that normalizes both dates to midnight (setHours(0,0,0,0)) before comparing. This ensures comparison is based on calendar date only, not timestamp. Applied to create() validation, validateInvariants(), and isExpired() method. Pattern registered as ENFORCE-015 in MCP.",
      "files_affected": [
        "src/modules/wms/domain/entities/StockItem.ts"
      ],
      "pattern_created": "Date Comparison Pattern (ENFORCE-015)",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-201817",
      "date": "2026-01-01",
      "epic": "E7.8",
      "error": "Bug 13: StartInventoryCount did not verify if an inventory count already existed for the product/location combination. Concurrent requests could create duplicate InventoryCount records, causing ambiguity when CompleteInventoryCount retrieved only the first result.",
      "correction": "Added findPendingByProductAndLocation() method to IInventoryCountRepository and DrizzleInventoryCountRepository. Modified StartInventoryCount to check for existing pending count before creating new one. If pending count exists, returns Result.fail('Inventory count already in progress for this product/location'). Pattern registered as ENFORCE-016 in MCP.",
      "files_affected": [
        "src/modules/wms/application/use-cases/StartInventoryCount.ts",
        "src/modules/wms/domain/ports/IInventoryCountRepository.ts",
        "src/modules/wms/infrastructure/persistence/repositories/DrizzleInventoryCountRepository.ts"
      ],
      "pattern_created": "Idempotency Check Pattern (ENFORCE-016)",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-122846",
      "date": "2026-01-01",
      "epic": "E7.8",
      "error": "Bug 14: TransferStock used StockItem.create() when creating stock at destination location. If the source product was expired, create() rejected it due to expiration validation, causing the entire transfer to fail. This broke warehouse operations for expired inventory and prevented historical tracking.",
      "correction": "Changed TransferStock to use StockItem.reconstitute() instead of create() when creating stock item at destination location. Rationale: Transfer is moving already-validated data from source, not creating new inventory. The product was validated when it originally entered the system. This allows expired products to be moved/reorganized in warehouse while maintaining audit trail. Pattern registered as ENFORCE-018 in MCP.",
      "files_affected": [
        "src/modules/wms/application/use-cases/TransferStock.ts"
      ],
      "pattern_created": "Transfer Uses Reconstitute Pattern (ENFORCE-018)",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-628924",
      "date": "2026-01-01",
      "epic": "E7.8",
      "error": "Bug 19: RegisterStockExit não validava location.isActive antes de permitir saída de estoque. RegisterStockEntry e TransferStock validam isActive, mas RegisterStockExit não. Inconsistência permite operações em localizações inativas.",
      "correction": "Adicionado validação location.isActive após check de existência em RegisterStockExit. Template padrão criado: 1) Check exists, 2) Check isActive. Pattern ENFORCE-022: Consistent Business Validations Pattern registrado no MCP.",
      "files_affected": [
        "src/modules/wms/application/use-cases/RegisterStockExit.ts",
        "mcp-server/knowledge/contracts/type-safety.json",
        "mcp-server/knowledge/corrections/e7-8-wms-week2-corrections.json"
      ],
      "pattern_created": "ENFORCE-022: Consistent Business Validations Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-990504",
      "date": "2026-01-01",
      "epic": "E7.8",
      "error": "Bug 20: CreateLocation não validava que tipos não-WAREHOUSE (AISLE, SHELF, POSITION) requerem parentId ANTES de chamar o domínio. DTO fazia parentId opcional, Use Case só validava SE fornecido. Violação fail-fast: deixa domínio rejeitar com erro genérico ao invés de validar no Use Case.",
      "correction": "Adicionado validação fail-fast no Use Case: 1) Se type !== WAREHOUSE && !parentId, return fail. 2) Se type === WAREHOUSE && parentId, return fail. Adicionado .refine() no DTO para validação condicional. Ordem estabelecida: DTO format → Use Case business rules → Repository existence → Domain invariants. Pattern ENFORCE-023 registrado no MCP.",
      "files_affected": [
        "src/modules/wms/application/use-cases/CreateLocation.ts",
        "src/modules/wms/application/dtos/CreateLocationDTO.ts",
        "mcp-server/knowledge/contracts/type-safety.json",
        "mcp-server/knowledge/corrections/e7-8-wms-week2-corrections.json"
      ],
      "pattern_created": "ENFORCE-023: Fail-Fast Business Rules Validation Pattern",
      "status": "APPROVED",
      "must_not_repeat": true
    }
  ]
}