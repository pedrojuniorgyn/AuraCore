{
  "epic": "E9",
  "corrections": [
    {
      "id": "LC-375756",
      "date": "2026-01-20",
      "epic": "E9",
      "error": "Bug E9-002: Commercial calculate endpoint usava organizationId=1 e branchId=1 como defaults hardcoded, permitindo acesso sem autenticação",
      "correction": "Adicionado getTenantContext() para validar autenticação. IDs agora vêm do usuário autenticado, NUNCA do body",
      "files_affected": [
        "src/app/api/commercial/calculate/route.ts"
      ],
      "pattern_created": "tenant-security",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-378597",
      "date": "2026-01-20",
      "epic": "E9",
      "error": "Bug E9-003: Query após insert em proposals/route.ts filtrava apenas por id, sem organizationId, permitindo acesso cross-tenant",
      "correction": "Adicionado import de 'and' e filtro organizationId na query: and(eq(id), eq(organizationId))",
      "files_affected": [
        "src/app/api/comercial/proposals/route.ts"
      ],
      "pattern_created": "tenant-security",
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-084086",
      "date": "2026-01-20",
      "epic": "E9",
      "error": "Bug LC-381234: readOnlyRootFilesystem no Kubernetes deployment sem volume para /app/data, causaria falha de escrita em runtime",
      "correction": "Adicionado volume emptyDir para /app/data nos volumeMounts e volumes do deployment.yaml",
      "files_affected": [
        "agents/k8s/deployment.yaml"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-284838",
      "date": "2026-01-20",
      "epic": "E9",
      "error": "Bug CI-001: Build do Dockerfile dos agents falhava com 'OSError: Readme file does not exist: README.md' porque o pyproject.toml declara readme=\"README.md\" mas o Dockerfile só copiava pyproject.toml antes do pip install, não incluindo o README.md necessário pelo hatchling",
      "correction": "Corrigido Dockerfile para copiar README.md junto com pyproject.toml antes do pip install. Também corrigido: versão Python (3.12→3.11 para compatibilidade), removido Poetry (projeto usa hatchling), corrigido casing de AS para padrão (as→AS), removido COPY de .venv inexistente",
      "files_affected": [
        "agents/Dockerfile"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-689836",
      "date": "2026-01-21",
      "epic": "E9",
      "error": "Bug CI-002: hatchling não conseguia encontrar arquivos para build porque faltava configuração [tool.hatch.build.targets.wheel] no pyproject.toml. O projeto usa estrutura src/ mas hatchling procurava por auracore_agents/",
      "correction": "Adicionado [tool.hatch.build.targets.wheel] com packages = ['src'] e [tool.hatch.build.targets.sdist] com include list no pyproject.toml",
      "files_affected": [
        "agents/pyproject.toml"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-692590",
      "date": "2026-01-21",
      "epic": "E9",
      "error": "Bug K8S-001: Volume data usando emptyDir causa perda de dados em restart/scale-down. App armazena SQLite/ChromaDB em /app/data/memory para sessões persistentes, mas Deployment com HPA (3-10 replicas) com emptyDir perde todos os dados quando pods são recriados",
      "correction": "Adicionado WARNING comentário no deployment.yaml explicando o problema e opções (PVC, StatefulSet, Redis externo). Criado pvc-data.yaml como template opcional para produção",
      "files_affected": [
        "agents/k8s/deployment.yaml",
        "agents/k8s/pvc-data.yaml"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-997538",
      "date": "2026-01-21",
      "epic": "E9",
      "error": "Interface Contract em get-contract-tool.ts validava 'title' como campo obrigatório, mas todos os JSONs de contratos usam 'name'. Causava erro 'Invalid contract schema' ao chamar get_contract para qualquer contrato.",
      "correction": "1) Alterada interface Contract para usar 'name' como campo principal e 'title' como alias opcional. 2) Alterada validação para aceitar (!contract.name && !contract.title). 3) Corrigidos listContracts() e searchContracts() em contracts.ts para usar fallback name || title || id.",
      "files_affected": [
        "mcp-server/src/tools/get-contract-tool.ts",
        "mcp-server/src/resources/contracts.ts"
      ],
      "pattern_created": null,
      "status": "APPROVED",
      "must_not_repeat": true
    },
    {
      "id": "LC-272090",
      "date": "2026-01-21",
      "epic": "E9",
      "error": "Bug 'Cannot read properties of undefined (reading toFixed)' na página /financeiro/dre-dashboard. O componente NumberCounter em magic-components.tsx chamava value.toFixed(decimals) sem verificar se value era undefined/null/NaN. Quando dados do DRE vinham vazios ou com campos undefined da API, o componente quebrava.",
      "correction": "1) Alterado type do prop value em NumberCounter para aceitar 'number | undefined | null'. 2) Adicionado safeValue = value ?? 0 e numericValue = Number.isFinite(safeValue) ? safeValue : 0. 3) Alterado useEffect para usar numericValue ao invés de value. 4) Adicionado displayValue = Number.isFinite(count) ? count : 0 antes do toFixed(). 5) Corrigido também dre/page.tsx com (margin ?? 0) em 3 ocorrências preventivamente.",
      "files_affected": [
        "src/components/ui/magic-components.tsx",
        "src/app/(dashboard)/financeiro/dre/page.tsx"
      ],
      "pattern_created": "P-SAFE-TOFIX: Always protect toFixed with nullish coalescing",
      "status": "APPROVED",
      "must_not_repeat": true
    }
  ]
}