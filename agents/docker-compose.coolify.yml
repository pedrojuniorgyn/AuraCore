# =============================================================================
# AURACORE AGENTS - DOCKER COMPOSE PARA COOLIFY
# =============================================================================
# Este arquivo é específico para deploy no Coolify.
# Não usar para desenvolvimento local (use docker-compose.yml).
#
# Serviços:
# - agents: Agno FastAPI (Python)
# - chromadb: Vector store para RAG
# =============================================================================

version: '3.8'

services:
  # =========================================================================
  # AGNO AGENTS (FastAPI)
  # =========================================================================
  agents:
    build:
      context: .
      dockerfile: Dockerfile.docling  # Usar Dockerfile com Docling/OCR
    container_name: auracore-agents
    restart: unless-stopped
    
    environment:
      # ----- Core Settings -----
      ENVIRONMENT: ${ENVIRONMENT:-production}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      
      # ----- LLM Provider -----
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-claude-sonnet-4-20250514}
      
      # ----- AuraCore API -----
      # Em Coolify, 'web' é o nome do serviço Next.js principal
      AURACORE_API_URL: ${AURACORE_API_URL:-http://web:3000}
      AURACORE_API_TIMEOUT: ${AURACORE_API_TIMEOUT:-30}
      
      # ----- MCP Server -----
      MCP_SERVER_URL: ${MCP_SERVER_URL:-http://web:3100}
      
      # ----- ChromaDB -----
      CHROMA_HOST: ${CHROMA_HOST:-chromadb}
      CHROMA_PORT: ${CHROMA_PORT:-8000}
      CHROMA_URL: ${CHROMA_URL:-http://chromadb:8000}
      
      # ----- Memory Store -----
      MEMORY_DB_PATH: ${MEMORY_DB_PATH:-/data/memory.db}
      
      # ----- Docling / OCR -----
      DOCLING_CACHE_DIR: ${DOCLING_CACHE_DIR:-/data/docling_cache}
      TESSERACT_CMD: /usr/bin/tesseract
      
      # ----- Security -----
      ENABLE_GUARDRAILS: ${ENABLE_GUARDRAILS:-true}
      
      # ----- Observability -----
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-auracore-agents}
      
    volumes:
      # Persistir memória de longo prazo
      - agents_data:/data
      # Cache de modelos Docling
      - docling_cache:/data/docling_cache
      
    expose:
      - "8080"
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
      
    networks:
      - auracore
      
    depends_on:
      chromadb:
        condition: service_healthy
        
    labels:
      - "coolify.managed=true"
      - "coolify.service=agents"

  # =========================================================================
  # CHROMADB (Vector Store)
  # =========================================================================
  chromadb:
    image: chromadb/chroma:latest
    container_name: auracore-chromadb
    restart: unless-stopped
    
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
      
    volumes:
      - chromadb_data:/chroma/chroma
      
    expose:
      - "8000"
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
      
    networks:
      - auracore
      
    labels:
      - "coolify.managed=true"
      - "coolify.service=chromadb"

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  agents_data:
    driver: local
  chromadb_data:
    driver: local
  docling_cache:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  auracore:
    external: true
    # Conecta à rede existente do AuraCore (web + sql)
    # Se a rede não existir, o Coolify irá criar automaticamente
