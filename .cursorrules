# AURA CORE - REGRAS OBRIGATÃ“RIAS

## ğŸš¨ CRÃTICO - NUNCA VIOLAR

1. âŒ NUNCA use `any` (use `unknown` ou tipo explÃ­cito)
2. âŒ NUNCA use `@ts-ignore`
3. âŒ NUNCA use `as any`
4. âœ… SEMPRE valide input com Zod em rotas API
5. âœ… SEMPRE aplique multi-tenancy (organizationId + branchId)
6. âœ… SEMPRE use transaÃ§Ãµes em operaÃ§Ãµes multi-step (withMssqlTransaction)

## TypeScript Strict Mode
```typescript
// next.config.ts
typescript: {
  ignoreBuildErrors: false, // âœ… DEVE ser false em produÃ§Ã£o
}
```

- Tipos explÃ­citos obrigatÃ³rios
- Zero uso de `any`
- ValidaÃ§Ã£o em compile-time

## Contexto Brasil (ERP LogÃ­stico)

**LegislaÃ§Ã£o fiscal que vocÃª DEVE conhecer:**
- ICMS (Lei Complementar 87/96 - Lei Kandir)
- PIS/COFINS (Leis 10.637/02 e 10.833/03)
- SPED Fiscal, SPED ContribuiÃ§Ãµes, SPED ECD
- CTe (Conhecimento de Transporte EletrÃ´nico)
- NFe (Nota Fiscal EletrÃ´nica)
- MDFe (Manifesto de Documentos Fiscais)

**Regras importantes:**
- Cite base legal embrigatÃ³rio para crÃ©dito de ICMS
- CFOP deve ser coerente com operaÃ§Ã£o
- RetenÃ§Ãµes na fonte: IRRF (1.5%), PIS (0.65%), COFINS (3%), CSLL (1%), ISS (2-5%)

## Multi-Tenancy (OBRIGATÃ“RIO)
```typescript
// âœ… SEMPRE fazer em TODA rota API:
const ctx = await getTenantContext();
const branchId = resolveBranchIdOrThrow(req.headers, ctx);

// âœ… SEMPRE filtrar queries:
.where(
  and(
    eq(table.organizationId, ctx.organizationId),
    eq(table.branchId, branchId)
  )
)
```

## TransaÃ§Ãµes SQL (OBRIGATÃ“RIO em multi-step)
```typescript
// âœ… SEMPRE usar quando modificar 2+ tabelas:
return await withMssqlTransaction(async (tx) => {
  await tx.update(accountsPayable)...
  await tx.update(bankAccounts)...
  await tx.insert(accountingEntries)...
  // âœ… TUDO ou NADA
});
```

## ValidaÃ§Ã£o de Input (OBRIGATÃ“RIO)
```typescript
import { z } from "zod";

// âœ… SEMPRE validar input em rotas:
const InputSchema = z.object({
  amount: z.number().positive(),
  description: z.string().min(3).max(500),
});

exportq: NextRequest) {
  const body = await req.json();
  const validated = InputSchema.parse(body); // Valida ou lanÃ§a erro
  // ...
}
```

## DDD (a partir de E7 - futuro)

- Entidades: construtor privado, factory `create()`
- Value Objects: imutÃ¡veis, validaÃ§Ã£o no constructor
- Use Cases: orquestram, nÃ£o contÃªm lÃ³gica de negÃ³cio
- Result<T> pattern para operaÃ§Ãµes que podem falhar

## Estrutura de Arquivos
```
src/
â”œâ”€â”€ app/                    # Next.js routes
â”œâ”€â”€ lib/                    # Shared utilities
â”‚   â”œâ”€â”€ db/                # Database (Drizzle ORM)
â”‚   â”œâ”€â”€ auth/              # Authentication
â”‚   â””â”€â”€ validators/        # Zod schemas
â”œâ”€â”€ services/              # Business logic (atual)
â””â”€â”€ components/            # React components
```

## Commits

**ConvenÃ§Ã£o:**
```
feat(module): descriÃ§Ã£o curta

- Detalhe 1
- Detalhe 2

Refs: E0.1 (rastreabilidade)
```

**FrequÃªncia:** A cada 2-3 arquivos modificados (SEMPRE!)

## Arquivos CRÃTICOS (NÃƒO MEXnting-engine.ts` - ContabilizaÃ§Ã£o
2. `financial-title-generator.ts` - TÃ­tulos financeiros
3. `sped-fiscal-generator.ts` - SPED (multa R$ 5k+)
4. `sped-ecd-generator.ts` - SPED ContÃ¡bil
5. `sped-contributions-generator.ts` - SPED PIS/COFINS

**Por quÃª:** Sem testes = risco alto de bugs em compliance fiscal/financeiro

---

**FIM DAS REGRAS - Leia SEMPRE antes de comeÃ§ar trabalho**
